'ç™»å½•ç³»ç»Ÿ
"use client"

import React, { useState, useEffect, Suspense } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import Link from 'next/link'
import { useAuthStore } from '@/lib/store'
import { backendApi } from '@/lib/api-client'

function LoginPageContent() {
  const router = useRouter()
  const searchParams = useSearchParams()
  const { setUser } = useAuthStore()

  const [username, setUsername] = useState('')
  const [password, setPassword] = useState('')
  const [error, setError] = useState('')
  const [successMessage, setSuccessMessage] = useState('')
  const [isLoading, setIsLoading] = useState(false)

  // æ£€æŸ¥URLå‚æ•°ä¸­çš„æˆåŠŸæ¶ˆæ¯
  useEffect(() => {
    const message = searchParams.get('message')
    if (message) {
      setSuccessMessage(message)
      // 3ç§’åæ¸…é™¤æ¶ˆæ¯
      setTimeout(() => setSuccessMessage(''), 3000)
    }
  }, [searchParams])

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsLoading(true)
    setError('')

    try {      // æ¨¡æ‹Ÿç™»å½•å»¶è¿Ÿ
      await new Promise(resolve => setTimeout(resolve, 500))
      
      // ç›´æ¥è®¾ç½®ç”¨æˆ·ä¿¡æ¯
      const user = {
        id: 'debug-user-001',
        username: username || 'debug-user',
        name: username ? username.split('@')[0] : 'è°ƒè¯•ç”¨æˆ·',
        avatar: '/avatar.png',
        email: username || 'debug@example.com'
      }
      
      setUser(user) // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
      router.push('/dashboard')            /*      // ä½¿ç”¨åç«¯APIè¿›è¡Œç™»å½•      const response = await backendApi.auth.login({
        email: username,
        password: password
      })      if (response.isSuccess && response.token) {
        // åç«¯APIç™»å½•æˆåŠŸ
        const user = {
          id: response.id || 'backend-user',
          username: username.split('@')[0], // ä»é‚®ç®±æå–ç”¨æˆ·å
          name: username.split('@')[0],
          avatar: '/avatar.png',
          email: username
        }
        
        setUser(user) // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
        router.push('/dashboard')      } else {
        throw new Error(response.messages?.[0]?.description || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ')
      }
      */
    } catch (error: any) {      setError(error.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•')
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <>
      <style jsx global>{`
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        html, body {
          margin: 0;
          padding: 0;
          overflow-x: hidden;
          width: 100%;
          height: 100%;
        }

        .page-wrapper {
          position: fixed;
          width: 100%;
          height: 100%;
          top: 0;
          left: 0;
          overflow: hidden;
        }

        .page-background {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: linear-gradient(135deg, #f0f4f7 0%, #e6eef5 100%);
          z-index: -1;
        }

        .body {
          font-family: Arial, sans-serif;
          width: 100%;
          height: 100%;
          display: flex;
          justify-content: center;
          align-items: center;
          color: #333;
          position: relative;
        }

        .svg-container {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          overflow: hidden;
        }

        .svg-top,
        .svg-bottom {
          position: absolute;
          z-index: 0;
          pointer-events: none;
        }

        .svg-top {
          top: 0;
          left: 50%;
          transform: translateX(-50%);
          width: 100%;
          height: auto;
          opacity: 0.8;
        }

        .svg-bottom {
          bottom: 0;
          left: 50%;
          transform: translateX(-50%);
          width: 100%;
          height: auto;
          opacity: 0.7;
        }

        .container {
          width: 100%;
          max-width: 380px;
          background-color: rgba(255, 255, 255, 0.95);
          padding: 35px;
          border-radius: 18px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
          backdrop-filter: blur(10px);
          text-align: center;
          position: relative;
          z-index: 2;
          transition: transform 0.3s ease, box-shadow 0.3s ease;
          margin: 0 20px;
        }

        .container:hover {
          transform: translateY(-5px);
          box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        h1 {
          margin-top: 20px;
          font-size: 32px;
          color: #5865f2;
        }

        p {
          font-size: 16px;
          margin-top: 5px;
          color: #888;
        }

        .main-content form {
          margin-top: 40px;
        }

        input {
          width: 100%;
          padding: 15px;
          margin-bottom: 20px;
          border: 1px solid #ddd;
          border-radius: 8px;
          font-size: 16px;
          color: #333;
        }

        .line {
          width: 100%;
          height: 1px;
          background-color: #ddd;
          margin-bottom: 20px;
        }

        button {
          width: 100%;
          padding: 15px;
          background-color: #5865f2;
          color: white;
          font-size: 16px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          transition: background-color 0.3s;
        }

        button:hover:not(:disabled) {
          background-color: #4752c4;
        }

        button:disabled {
          opacity: 0.7;
          cursor: not-allowed;
        }

        .error-message {
          color: #e53935;
          margin-bottom: 20px;
          font-size: 14px;
          text-align: left;
          padding: 8px 12px;
          background-color: rgba(229, 57, 53, 0.1);
          border-radius: 6px;
          border-left: 3px solid #e53935;
        }

        .success-message {
          color: #2e7d32;
          margin-bottom: 20px;
          font-size: 14px;
          text-align: center;
          padding: 8px 12px;
          background-color: rgba(46, 125, 50, 0.1);
          border-radius: 6px;
          border-left: 3px solid #2e7d32;
        }

        footer {
          margin-top: 30px;
          display: flex;
          justify-content: space-between;
        }

        footer p {
          margin-top: 15px;
          font-size: 14px;
        }

        footer p a {
          text-decoration: none;
          color: #5865f2;
        }

        footer p a:hover {
          text-decoration: underline;
        }

        .register-link {
          text-align: center;
          margin-top: 20px;
          padding-top: 20px;
          border-top: 1px solid #eee;
        }
      `}</style>

      <div className="page-wrapper">
        <div className="page-background"></div>
        <div className="body">
          <div className="svg-container">
            <div className="svg-top">
              <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlnsXlink="http://www.w3.org/1999/xlink" height="1337" width="1337">
                <defs>
                  <path id="path-1" opacity="1" fillRule="evenodd" d="M1337,668.5 C1337,1037.455193874239 1037.455193874239,1337 668.5,1337 C523.6725684305388,1337 337,1236 370.50000000000006,1094 C434.03835568300906,824.6732385973953 6.906089672974592e-14,892.6277623047779 0,668.5000000000001 C0,299.5448061257611 299.5448061257609,1.1368683772161603e-13 668.4999999999999,0 C1037.455193874239,0 1337,299.544806125761 1337,668.5Z" />
                  <linearGradient id="linearGradient-2" x1="0.79" y1="0.62" x2="0.21" y2="0.86">
                    <stop offset="0" stopColor="rgb(88,62,213)" stopOpacity="1" />
                    <stop offset="1" stopColor="rgb(23,215,250)" stopOpacity="1" />
                  </linearGradient>
                </defs>
                <g opacity="1">
                  <use xlinkHref="#path-1" fill="url(#linearGradient-2)" fillOpacity="1" />
                </g>
              </svg>
            </div>
            <div className="svg-bottom">
              <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlnsXlink="http://www.w3.org/1999/xlink" height="896" width="967.8852157128662">
                <defs>
                  <path id="path-2" opacity="1" fillRule="evenodd" d="M896,448 C1142.6325445712241,465.5747656464056 695.2579309733121,896 448,896 C200.74206902668806,896 5.684341886080802e-14,695.2579309733121 0,448.0000000000001 C0,200.74206902668806 200.74206902668791,5.684341886080802e-14 447.99999999999994,0 C695.2579309733121,0 475,418 896,448Z" />
                  <linearGradient id="linearGradient-3" x1="0.5" y1="0" x2="0.5" y2="1">
                    <stop offset="0" stopColor="rgb(40,175,240)" stopOpacity="1" />
                    <stop offset="1" stopColor="rgb(18,15,196)" stopOpacity="1" />
                  </linearGradient>
                </defs>
                <g opacity="1">
                  <use xlinkHref="#path-2" fill="url(#linearGradient-3)" fillOpacity="1" />
                </g>
              </svg>
            </div>
          </div>
          <section className="container">
            <header>
              <h1>æ¬¢è¿å›æ¥ï¼</h1>
              <p>å¾ªç¿¼ Aerotrace ç™»å½•</p>
            </header>
            
            {successMessage && (
              <div className="success-message">
                {successMessage}
              </div>
            )}
            
            <section className="main-content">
              <form onSubmit={handleSubmit}>
                <input
                  type="email"
                  placeholder="é‚®ç®±åœ°å€"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  required
                />
                <div className="line"></div>
                <input
                  type="password"
                  placeholder="å¯†ç "
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                />

                {error && <div className="error-message">{error}</div>}

                <button type="submit" disabled={isLoading}>
                  {isLoading ? 'ç™»å½•ä¸­...' : 'ç™»å½•'}
                </button>
              </form>
            </section>
            <footer>
              <p>
                <Link href="/forgot-password">
                  <span style={{ color: '#5865f2', fontWeight: '500', cursor: 'pointer', textDecoration: 'underline' }}>
                    å¿˜è®°å¯†ç ?
                  </span>
                </Link>
              </p>
            </footer>
            
            <div className="register-link">
              <p>
                è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ 
                <Link href="/register">
                  <span style={{ color: '#5865f2', fontWeight: '500', cursor: 'pointer', textDecoration: 'underline' }}>
                    ç«‹å³æ³¨å†Œ
                  </span>
                </Link>
              </p>
            </div>
          </section>
        </div>
      </div>
    </>
  )
} 

export default function LoginPage() {
  return (
    <Suspense>
      <LoginPageContent/>
    </Suspense>);
}


'ç»ç¼˜å­æ£€æµ‹é¡µé¢
"use client"

import React, { useState, useRef, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { useAuthStore } from '@/lib/store'
import { backendApi } from '@/lib/api-client'
import type { DetectResponse, PlateInfo } from '@/types/api'
// æ³¨æ„ï¼šPlateInfoç±»å‹æš‚æ—¶ä¿ç•™ï¼Œåç»­å¯æ”¹ä¸ºCrackInfo
import { 
  Layout, 
  Menu, 
  Button, 
  Space, 
  Typography, 
  Breadcrumb, 
  Upload,
  Card,
  Tabs,
  Alert,
  List,
  Tag,
  Divider,
  theme,
  ConfigProvider,
  message,
  Row,
  Col
} from 'antd'
import {
  MenuFoldOutlined,
  MenuUnfoldOutlined,
  HomeOutlined,
  SettingOutlined,
  QuestionCircleOutlined,
  DashboardOutlined,
  ThunderboltOutlined,
  UploadOutlined,
  InboxOutlined,
  SunOutlined,
  MoonOutlined,
  FileImageOutlined,
  ApiOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  CloudUploadOutlined,
  UserOutlined,
  GlobalOutlined
} from '@ant-design/icons'
import { getI18nText, getCurrentLanguage, type Language } from '@/lib/i18n'

const { Header, Sider, Content } = Layout
const { Title, Text } = Typography
const { Dragger } = Upload
const { TabPane } = Tabs

// ä¸»é¢˜é…ç½® - ä¸dashboardä¿æŒä¸€è‡´
type ThemeData = {
  borderRadius: number;
  colorPrimary: string;
  colorBgLayout: string;
  colorBgContainer: string;
  algorithm: 'light' | 'dark';
}

const defaultLightTheme: ThemeData = {
  borderRadius: 6,
  colorPrimary: '#1890ff',
  colorBgLayout: '#f0f4f8',
  colorBgContainer: '#ffffff',
  algorithm: 'light',
}

const defaultDarkTheme: ThemeData = {
  borderRadius: 6,
  colorPrimary: '#177ddc',
  colorBgLayout: '#0a0a0a',
  colorBgContainer: '#1a1a1a',
  algorithm: 'dark',
}

export default function InsulatorDetectionPage() {
  const router = useRouter()
  const { isAuthenticated, user, updateUser } = useAuthStore()
  const [collapsed, setCollapsed] = useState(false)
  const [currentTheme, setCurrentTheme] = useState<ThemeData>(defaultLightTheme)
  const [currentLang, setCurrentLang] = useState<Language>(getCurrentLanguage())
  
  const [selectedFile, setSelectedFile] = useState<File | null>(null)
  const [previewUrl, setPreviewUrl] = useState<string>('')
  const [isDetecting, setIsDetecting] = useState(false)
  const [detectionResults, setDetectionResults] = useState<PlateInfo[]>([]) // æš‚æ—¶ä½¿ç”¨PlateInfoç±»å‹ï¼Œåç»­æ”¹ä¸ºCrackInfo
  const [error, setError] = useState('')
  const [requestData, setRequestData] = useState<any>(null)
  const [responseData, setResponseData] = useState<any>(null)
  const [activeTab, setActiveTab] = useState('1')
  const [imageSize, setImageSize] = useState<{ width: number; height: number; naturalWidth: number; naturalHeight: number } | null>(null)
  const resultImageRef = useRef<HTMLImageElement>(null)
  const visualizationImageRef = useRef<HTMLImageElement>(null)
  const previewImageRef = useRef<HTMLImageElement>(null)
  const [previewImageSize, setPreviewImageSize] = useState<{ width: number; height: number; naturalWidth: number; naturalHeight: number } | null>(null)

  const {
    token: { colorBgContainer, borderRadiusLG },
  } = theme.useToken()

  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  useEffect(() => {
    if (!isAuthenticated) {
      router.push('/login')
      return
    }

    // ä»localStorageæ¢å¤å¤´åƒ
    if (typeof window !== 'undefined' && user) {
      const savedAvatar = localStorage.getItem('userAvatar')
      if (savedAvatar && savedAvatar !== user.avatar) {
        updateUser({ avatar: savedAvatar })
      }
    }
  }, [isAuthenticated, router, user, updateUser])

  // åŠ è½½ä¸»é¢˜åå¥½
  useEffect(() => {
    if (typeof window !== 'undefined') {
      // ä»localStorageæ¢å¤ä¸»é¢˜è®¾ç½® - ä¸dashboardä¿æŒä¸€è‡´
      const savedTheme = localStorage.getItem('themeMode')
      
      if (savedTheme === 'dark') {
        setCurrentTheme(defaultDarkTheme)
      } else {
        setCurrentTheme(defaultLightTheme)
      }
    }
  }, [])

  // ç»„ä»¶å¸è½½æ—¶æ¸…ç†å†…å­˜
  useEffect(() => {
    return () => {
      if (previewUrl) {
        URL.revokeObjectURL(previewUrl)
      }
    }
  }, [previewUrl])

  const isDark = currentTheme.algorithm === 'dark'
  const t = getI18nText(currentLang)

  const handleNavigation = (path: string) => {
    if (path.startsWith('settings/')) {
      const type = path.split('/')[1]
      router.push(`/settings?type=${type}`)
    } else if (path === 'detect') {
      router.push('/insulator-detection')
    } else {
      router.push(`/${path}`)
    }
  }

  const handleQuickThemeSwitch = () => {
    const newTheme = currentTheme.algorithm === 'light' ? defaultDarkTheme : defaultLightTheme
    setCurrentTheme(newTheme)
    // ä¸dashboardä¿æŒä¸€è‡´çš„localStorageé”®å
    localStorage.setItem('themeMode', newTheme.algorithm)
  }

  // ä¾§è¾¹æ èœå•é¡¹
  const sideMenuItems = [
    {
      key: 'dashboard',
      icon: <DashboardOutlined />,
      label: t.dashboard,
      onClick: () => handleNavigation('dashboard')
    },
    {
      key: 'detect',
      icon: <ThunderboltOutlined />,
      label: t.carRecognition,
    },
    {
      key: 'nest-detection',
      icon: <HomeOutlined />,
      label: t.nestDetection,
      onClick: () => handleNavigation('nest-detection')
    },
    {
      key: 'settings',
      icon: <SettingOutlined />,
      label: t.systemSettings,
      children: [
        {
          key: 'settings/user',
          icon: <UserOutlined />,
          label: t.userSettings,
          onClick: () => handleNavigation('settings/user')
        },
        {
          key: 'settings/general',
          icon: <GlobalOutlined />,
          label: t.generalSettings,
          onClick: () => handleNavigation('settings/general')
        }
      ]
    },
    {
      key: 'aboutus',
      icon: <QuestionCircleOutlined />,
      label: t.aboutUs,
      onClick: () => handleNavigation('aboutus')
    }
  ]

  // ç®€åŒ–å¹¶ä¼˜åŒ–æ–‡ä»¶ä¸Šä¼ å¤„ç†
  const handleFileSelect = (file: File) => {    setSelectedFile(file)
    setError('')
    setDetectionResults([])
    setRequestData(null)
    setResponseData(null)
    setActiveTab('1')
    
    // ç”Ÿæˆé¢„è§ˆURL
    const url = URL.createObjectURL(file)
    setPreviewUrl(url)
    
    // æ ¹æ®æ–‡ä»¶å¤§å°ç»™å‡ºä¸åŒæç¤º
    if (file.size > 3 * 1024 * 1024) {
      message.warning(`æ–‡ä»¶è¾ƒå¤§ (${(file.size / 1024 / 1024).toFixed(1)}MB)ï¼Œè¯†åˆ«æ—¶å°†è‡ªåŠ¨ä¼˜åŒ–å¤„ç†ä»¥ç¡®ä¿æœ€ä½³è¯†åˆ«æ•ˆæœ`)
    } else {
      message.success(`å›¾ç‰‡ "${file.name}" ä¸Šä¼ æˆåŠŸï¼Œå¯ä»¥å¼€å§‹è¯†åˆ«äº†`)
    }  }

  // å¤„ç†æ–‡ä»¶æ‹–æ‹½ä¸Šä¼ 
  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault()
    e.stopPropagation()
    
    const files = e.dataTransfer.files
    if (files.length > 0) {
      const file = files[0]
      
      // éªŒè¯æ–‡ä»¶ç±»å‹
      const isImage = file.type.startsWith('image/')
      if (!isImage) {
        message.error('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶!')
        return
      }
      
      // è®¾ç½®æœ€å¤§æ–‡ä»¶å¤§å°ä¸º50MBï¼ˆå‹ç¼©åä¼šå°äº2MBï¼‰
      const isLt50M = file.size / 1024 / 1024 < 50
      if (!isLt50M) {
        message.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 50MB!')
        return
      }
      
      handleFileSelect(file)
    }
  }

  // å¤„ç†æ–‡ä»¶æ‹–æ‹½æ‚¬åœ
  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault()
    e.stopPropagation()
  }

  // å¤„ç†ç‚¹å‡»ä¸Šä¼ 
  const handleClickUpload = () => {
    const input = document.createElement('input')
    input.type = 'file'
    input.accept = 'image/*,.jpg,.jpeg,.png'
    input.style.display = 'none'
    
    input.onchange = (e) => {
      const target = e.target as HTMLInputElement
      const files = target.files
      if (files && files.length > 0) {
        const file = files[0]
        
        // éªŒè¯æ–‡ä»¶ç±»å‹
        const isImage = file.type.startsWith('image/')
        if (!isImage) {
          message.error('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶!')
          return
        }
        
        // è®¾ç½®æœ€å¤§æ–‡ä»¶å¤§å°ä¸º50MBï¼ˆå‹ç¼©åä¼šå°äº2MBï¼‰
        const isLt50M = file.size / 1024 / 1024 < 50
        if (!isLt50M) {
          message.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 50MB!')
          return
        }
        
        handleFileSelect(file)
      }
      
      // æ¸…ç†inputå…ƒç´ 
      document.body.removeChild(input)
    }
    
    document.body.appendChild(input)
    input.click()
  }

  /**
   * ç»ç¼˜å­æ£€æµ‹
   * ä¸Šä¼ å›¾ç‰‡å¹¶è°ƒç”¨APIè¿›è¡Œæ£€æµ‹
   */
  const handleDetection = async () => {    if (!selectedFile) {
      message.error('è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶')
      return
    }

    // éªŒè¯æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ
    if (!(selectedFile instanceof File)) {
      message.error('æ–‡ä»¶æ ¼å¼æ— æ•ˆï¼Œè¯·é‡æ–°é€‰æ‹©')
      setSelectedFile(null)
      setPreviewUrl('')
      return
    }

    setIsDetecting(true)
    setError('')
    setDetectionResults([])
    setActiveTab('1')

    try {      // å°†æ–‡ä»¶è½¬æ¢ä¸ºBase64ï¼ˆRoboflow APIéœ€è¦ï¼‰
      const base64 = await backendApi.utils.fileToBase64(selectedFile)
      // ç§»é™¤data:image/xxx;base64,å‰ç¼€ï¼Œåªä¿ç•™base64æ•°æ®
      const base64Data = base64.split(',')[1] || base64
      
      // è®°å½•è¯·æ±‚æ•°æ®
      setRequestData({
        method: 'POST',
        url: 'https://serverless.roboflow.com/insulator-defect-c1kcs/1',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        params: {
          api_key: 'cW6r5HCK2OL5sVo7ymUO'
        },
        body: {
          file: selectedFile.name,
          size: `${(selectedFile.size / 1024).toFixed(2)} KB`,
          type: selectedFile.type,
          base64Length: base64Data.length,
          timestamp: new Date().toISOString()
        }
      })
      
      // ä½¿ç”¨Roboflow APIè¿›è¡Œæ£€æµ‹
      const response: DetectResponse = await backendApi.detect.byImage(selectedFile)      // è®°å½•å“åº”æ•°æ®
      setResponseData(response)

      if (response.isSuccess && response.infos) {
        setDetectionResults(response.infos)      } else {
        const errorMessage = response.messages?.[0]?.description || 'ç»ç¼˜å­æ£€æµ‹å¤±è´¥'
        setError(errorMessage)
        message.error(errorMessage)      }
    } catch (error: any) {      let errorMsg = 'æ£€æµ‹è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯'
      
      // é’ˆå¯¹ä¸åŒç±»å‹çš„é”™è¯¯æä¾›ä¸åŒçš„å¤„ç†
      if (error.message?.includes('è®¤è¯å¤±è´¥') || error.message?.includes('401') || error.message?.includes('Unauthorized')) {
        errorMsg = 'è®¤è¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
        message.error(errorMsg)
      } else if (error.message?.includes('è¯†åˆ«å¤±è´¥')) {
        errorMsg = 'å›¾ç‰‡ä¸­æœªèƒ½è¯†åˆ«å‡ºç¼ºé™·ï¼Œè¯·ç¡®ä¿ï¼š\n1. å›¾ç‰‡ä¸­åŒ…å«æ¸…æ™°å¯è§çš„ç»ç¼˜å­\n2. ç»ç¼˜å­æ²¡æœ‰è¢«é®æŒ¡\n3. å›¾ç‰‡å…‰çº¿å……è¶³ã€å¯¹æ¯”åº¦è‰¯å¥½'
        message.error(errorMsg)
      } else if (error.message?.includes('æ–‡ä»¶å¤ªå¤§') || error.message?.includes('400')) {
        errorMsg = 'å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·å°è¯•ä½¿ç”¨æ›´å°æˆ–è´¨é‡æ›´å¥½çš„å›¾ç‰‡æ–‡ä»¶'
        message.error(errorMsg)
      } else if (error.message?.includes('å‹ç¼©å¤±è´¥') || error.message?.includes('å›¾ç‰‡åŠ è½½å¤±è´¥')) {
        errorMsg = 'å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆæ”¯æŒJPGã€PNGæ ¼å¼ï¼‰'
        message.error(errorMsg)
      } else if (error.message?.includes('Network') || error.message?.includes('ç½‘ç»œ')) {
        errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•'
        message.error(errorMsg)
      } else if (error.message?.includes('timeout') || error.message?.includes('è¶…æ—¶')) {
        errorMsg = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•'
        message.error(errorMsg)
      } else {
        errorMsg = error.message || 'æ£€æµ‹è¿‡ç¨‹ä¸­å‡ºç°æœªçŸ¥é”™è¯¯'
        message.error(errorMsg)
      }
      
      setError(errorMsg)
      setResponseData({
        isSuccess: false,
        error: errorMsg,
        timestamp: new Date().toISOString(),
        messages: [{
          code: 'DETECTION_ERROR',
          description: errorMsg
        }]
      })
    } finally {
      setIsDetecting(false)
    }
  }

  // æ¸…ç©ºç»“æœ
  const handleClear = () => {
    // æ¸…ç†å†…å­˜ä¸­çš„URL
    if (previewUrl) {
      URL.revokeObjectURL(previewUrl)
    }
    
    setSelectedFile(null)
    setPreviewUrl('')
    setDetectionResults([])
    setError('')
    setRequestData(null)
    setResponseData(null)
    setActiveTab('1')
    setPreviewImageSize(null)    message.info('å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®')
  }

  if (!isAuthenticated) {
    return null
  }

  return (
    <>
      <style jsx>{`
        :global(.custom-menu.ant-menu-dark .ant-menu-item),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-title) {
          background-color: transparent !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-item:hover),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-title:hover) {
          background-color: rgba(255, 255, 255, 0.08) !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-item-selected) {
          background-color: rgba(255, 255, 255, 0.12) !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-selected > .ant-menu-submenu-title),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-open > .ant-menu-submenu-title),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-active > .ant-menu-submenu-title),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-title:active),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-title:focus) {
          background-color: transparent !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-sub) {
          background-color: transparent !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-sub .ant-menu-item) {
          background-color: transparent !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-sub .ant-menu-item:hover) {
          background-color: rgba(255, 255, 255, 0.08) !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-sub .ant-menu-item-selected),
        :global(.custom-menu.ant-menu-dark .ant-menu-sub .ant-menu-item-active) {
          background-color: rgba(255, 255, 255, 0.12) !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub) {
          background-color: transparent !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub .ant-menu-item) {
          background-color: transparent !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub .ant-menu-item:hover) {
          background-color: rgba(255, 255, 255, 0.08) !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub .ant-menu-item-selected),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub .ant-menu-item-active) {
          background-color: rgba(255, 255, 255, 0.12) !important;
        }
      `}</style>
      <ConfigProvider
        theme={{
          token: {
            colorPrimary: currentTheme.colorPrimary,
            borderRadius: currentTheme.borderRadius,
            colorBgLayout: currentTheme.colorBgLayout,
            colorBgContainer: currentTheme.colorBgContainer,
            colorBgElevated: isDark ? '#262626' : '#ffffff',
            colorBorder: isDark ? '#303030' : '#e1e8ed',
            colorBorderSecondary: isDark ? '#252525' : '#f0f0f0',
            colorText: isDark ? '#ffffff' : '#000000d9',
            colorTextSecondary: isDark ? '#bfbfbf' : '#00000073',
            colorTextTertiary: isDark ? '#8c8c8c' : '#00000045',
            colorFillAlter: isDark ? '#1f1f1f' : '#fafafa',
            colorFillContent: isDark ? '#262626' : '#f5f5f5',
            colorBgTextHover: isDark ? '#2a2a2a' : '#f5f5f5',
          },
          components: {
            Menu: {
              itemBg: 'transparent',
              subMenuItemBg: 'transparent',
              itemActiveBg: 'transparent',
              itemSelectedBg: isDark ? 'rgba(255, 255, 255, 0.12)' : 'rgba(255, 255, 255, 0.12)',
              itemHoverBg: isDark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(255, 255, 255, 0.08)',
            },
          },
          algorithm: isDark ? theme.darkAlgorithm : theme.defaultAlgorithm,
        }}
      >
        <Layout style={{ height: '100vh', overflow: 'hidden' }}>
          {/* ä¾§è¾¹æ  - 208px (200+8Ã—1) */}
          <Sider 
            trigger={null} 
            collapsible 
            collapsed={collapsed}
            breakpoint="lg"
            collapsedWidth={collapsed ? 0 : 80}
            width={208}
            style={{
              background: 'linear-gradient(180deg, #1890ff 0%, #096dd9 30%, #0050b3 70%, #003a8c 100%)',
              height: '100vh',
              overflow: 'auto',
              position: 'fixed',
              left: 0,
              top: 0,
              bottom: 0,
              zIndex: 999
            }}
          >
            <div style={{ 
              height: 64, 
              margin: '16px', 
              display: 'flex', 
              alignItems: 'center',
              justifyContent: collapsed ? 'center' : 'flex-start',
              borderBottom: '1px solid rgba(255,255,255,0.1)',
              paddingBottom: 16
            }}>
              <ThunderboltOutlined style={{ fontSize: '24px', color: '#fff' }} />
              {!collapsed && (
                <Title level={4} style={{ margin: '0 0 0 12px', color: '#fff', fontSize: '16px' }}>
                  {t.carRecognition}
                </Title>
              )}
            </div>
            <Menu
              theme="dark"
              mode="inline"
              defaultSelectedKeys={['detect']}
              items={sideMenuItems}
              style={{ 
                borderRight: 0,
                background: 'transparent'
              }}
              className="custom-menu"
            />
          </Sider>

          <Layout style={{ marginLeft: collapsed ? 0 : 208 }}>
            {/* é¡¶éƒ¨å¯¼èˆªæ  - 64px (48+8Ã—2) */}
            <Header style={{ 
              display: 'flex', 
              alignItems: 'center',
              padding: '0 24px',
              height: 64,
              background: isDark
                ? 'linear-gradient(90deg, rgba(26,26,26,0.95) 0%, rgba(42,42,42,0.9) 50%, rgba(26,26,26,0.95) 100%)'
                : 'linear-gradient(90deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.9) 50%, rgba(255,255,255,0.95) 100%)',
              justifyContent: 'space-between',
              boxShadow: isDark
                ? '0 2px 8px rgba(0,0,0,0.4)' 
                : '0 2px 8px rgba(24, 144, 255, 0.08)',
              borderBottom: isDark
                ? '1px solid rgba(255,255,255,0.1)' 
                : '1px solid rgba(24, 144, 255, 0.08)',
              backdropFilter: 'blur(12px)'
            }}>
              {/* å·¦ä¾§ï¼šæŠ˜å æŒ‰é’® + é¢åŒ…å±‘ */}
              <Space>
                <Button
                  type="text"
                  icon={collapsed ? <MenuUnfoldOutlined /> : <MenuFoldOutlined />}
                  onClick={() => setCollapsed(!collapsed)}
                  size="large"
                  style={{
                    fontSize: '16px',
                    width: 40,
                    height: 40,
                    color: isDark ? '#ffffff' : '#1890ff'
                  }}
                />
                
                <Breadcrumb
                  items={[
                    {
                      href: '/dashboard',
                      title: <HomeOutlined />
                    },
                    {
                      title: t.carRecognition
                    }
                  ]}
                />
              </Space>

              {/* å³ä¾§ï¼šå¿«é€Ÿä¸»é¢˜åˆ‡æ¢ */}
              <Button
                type="primary"
                shape="circle"
                size="large"
                icon={isDark ? <SunOutlined /> : <MoonOutlined />}
                onClick={handleQuickThemeSwitch}
                style={{
                  width: 40,
                  height: 40,
                  backgroundColor: isDark ? '#faad14' : currentTheme.colorPrimary,
                  borderColor: isDark ? '#faad14' : currentTheme.colorPrimary,
                  boxShadow: isDark
                    ? '0 4px 12px rgba(250, 173, 20, 0.4)' 
                    : `0 4px 12px ${currentTheme.colorPrimary}40`
                }}
              />
            </Header>

            {/* ä¸»è¦å†…å®¹åŒºåŸŸ */}
            <Content style={{ 
              margin: '24px',
              padding: '24px',
              background: isDark
                ? 'linear-gradient(135deg, rgba(26,26,26,0.95) 0%, rgba(42,42,42,0.8) 25%, rgba(58,58,58,0.6) 50%, rgba(42,42,42,0.8) 75%, rgba(26,26,26,0.95) 100%)'
                : 'linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.7) 25%, rgba(240,248,255,0.5) 50%, rgba(248,250,252,0.7) 75%, rgba(255,255,255,0.9) 100%)',
              borderRadius: borderRadiusLG,
              backdropFilter: 'blur(16px)',
              border: isDark
                ? '1px solid rgba(255,255,255,0.1)' 
                : '1px solid rgba(24, 144, 255, 0.12)',
              boxShadow: isDark
                ? '0 8px 32px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.1)' 
                : '0 8px 32px rgba(24, 144, 255, 0.12), inset 0 1px 0 rgba(255,255,255,0.9)',
              overflow: 'auto',
              height: 'calc(100vh - 112px)'
            }}>
              <div style={{ marginBottom: '24px' }}>
                <Title level={2} style={{ margin: 0, display: 'flex', alignItems: 'center' }}>
                  <ThunderboltOutlined style={{ marginRight: '12px', color: currentTheme.colorPrimary }} />
                  {t.insulatorDetectionTitle}
                </Title>
                <Text type="secondary">{t.insulatorDetectionSubtitle}</Text>
              </div>

              {/* å·¦å³å¯¹ç§°å¸ƒå±€ */}
              <Row gutter={24} style={{ height: 'calc(100% - 80px)' }}>
                {/* å·¦ä¾§ï¼šä¸Šä¼ åŒºåŸŸ */}
                <Col xs={24} lg={12} style={{ height: '100%' }}>
                  <Card 
                    style={{ 
                      height: '100%', 
                      display: 'flex',
                      flexDirection: 'column',
                      background: isDark
                        ? 'linear-gradient(135deg, rgba(38,38,38,0.9) 0%, rgba(58,58,58,0.7) 50%, rgba(38,38,38,0.9) 100%)'
                        : 'linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.8) 50%, rgba(255,255,255,0.95) 100%)',
                      border: isDark
                        ? '1px solid rgba(255,255,255,0.12)' 
                        : '1px solid rgba(24, 144, 255, 0.12)',
                      backdropFilter: 'blur(12px)',
                      borderRadius: borderRadiusLG,
                      boxShadow: isDark
                        ? '0 4px 16px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1)' 
                        : '0 4px 16px rgba(24, 144, 255, 0.1), inset 0 1px 0 rgba(255,255,255,0.9)'
                    }}
                    bodyStyle={{ 
                      flex: 1,
                      display: 'flex',
                      flexDirection: 'column',
                      justifyContent: 'center',
                      padding: '24px'
                    }}
                  >
                    {!previewUrl ? (
                      <div 
                        style={{ 
                          width: '100%',
                          height: '100%',
                          minHeight: '400px',
                          background: isDark ? '#1a1a1a' : '#fafafa',
                          borderRadius: '8px',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          cursor: 'pointer',
                          transition: 'all 0.3s ease'
                        }}
                        onClick={handleClickUpload}
                        onDrop={handleDrop}
                        onDragOver={handleDragOver}
                        onDragEnter={handleDragOver}
                      >
                        <div style={{ textAlign: 'center', padding: '40px 20px' }}>
                          <CloudUploadOutlined style={{ 
                            fontSize: '64px', 
                            color: currentTheme.colorPrimary,
                            marginBottom: '16px',
                            display: 'block'
                          }} />
                          <p style={{ 
                            fontSize: '18px', 
                            margin: '16px 0',
                            fontWeight: 500,
                            color: isDark ? '#ffffff' : '#000000d9'
                          }}>
                            {t.clickOrDrag}
                          </p>
                          <p style={{
                            color: isDark ? '#8c8c8c' : '#666',
                            fontSize: '14px',
                            margin: 0
                          }}>
                            {t.supportedFormats}
                            <br />
                            <span style={{ fontSize: '12px', color: isDark ? '#666' : '#999' }}>
                              {t.largeFileNotice}
                            </span>
                          </p>
                        </div>
                      </div>
                    ) : (
                      <div style={{ 
                        width: '100%',
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        justifyContent: 'center',
                        height: '100%'
                      }}>
                        {/* æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º */}
                        {selectedFile && (
                          <div style={{
                            width: '100%',
                            padding: '12px',
                            background: isDark ? '#262626' : '#f0f8ff',
                            border: isDark ? '1px solid #303030' : '1px solid #d6e4ff',
                            borderRadius: '6px',
                            marginBottom: '16px',
                            fontSize: '13px'
                          }}>
                            <div style={{ marginBottom: '4px' }}>
                              <Text strong>{t.fileName}ï¼š</Text>
                              <Text>{selectedFile.name}</Text>
                            </div>
                            <div style={{ marginBottom: '4px' }}>
                              <Text strong>{t.fileSize}ï¼š</Text>
                              <Text>{(selectedFile.size / 1024).toFixed(2)} KB</Text>
                            </div>
                            <div>
                              <Text strong>{t.fileType}ï¼š</Text>
                              <Text>{selectedFile.type}</Text>
                            </div>
                          </div>
                        )}
                        
                        <div style={{
                          position: 'relative',
                          display: 'inline-block',
                          width: '100%',
                          marginBottom: '20px'
                        }}>
                          <img
                            ref={previewImageRef}
                            src={previewUrl}
                            alt="é¢„è§ˆ"
                            style={{
                              maxWidth: '100%',
                              maxHeight: '500px',
                              borderRadius: '8px',
                              objectFit: 'contain',
                              display: 'block'
                            }}
                            onLoad={(e) => {
                              // å›¾ç‰‡åŠ è½½å®Œæˆåï¼Œè·å–å®é™…å°ºå¯¸ç”¨äºç¼©æ”¾è®¡ç®—
                              const img = e.currentTarget
                              const displayWidth = img.clientWidth
                              const displayHeight = img.clientHeight
                              const naturalWidth = img.naturalWidth
                              const naturalHeight = img.naturalHeight
                              
                              setPreviewImageSize({
                                width: displayWidth,
                                height: displayHeight,
                                naturalWidth: naturalWidth,
                                naturalHeight: naturalHeight
                              })
                            }}
                          />
                          {/* åœ¨é¢„è§ˆå›¾ç‰‡ä¸Šç»˜åˆ¶æ£€æµ‹æ¡† */}
                          {previewImageSize && detectionResults.length > 0 && detectionResults.map((result, index) => {
                            if (!result.rect || result.rect.x === null || result.rect.y === null || 
                                result.rect.width === null || result.rect.height === null) {
                              return null
                            }
                            
                            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼šæ˜¾ç¤ºå°ºå¯¸ / åŸå§‹å°ºå¯¸
                            let scaleX = 1
                            let scaleY = 1
                            
                            if (previewImageSize.naturalWidth > 0 && previewImageSize.naturalHeight > 0) {
                              scaleX = previewImageSize.width / previewImageSize.naturalWidth
                              scaleY = previewImageSize.height / previewImageSize.naturalHeight
                            } else if (previewImageRef.current) {
                              const img = previewImageRef.current
                              if (img.naturalWidth > 0 && img.naturalHeight > 0) {
                                scaleX = img.clientWidth / img.naturalWidth
                                scaleY = img.clientHeight / img.naturalHeight
                              }
                            }
                            
                            // åº”ç”¨ç¼©æ”¾æ¯”ä¾‹
                            const x = result.rect.x * scaleX
                            const y = result.rect.y * scaleY
                            const width = result.rect.width * scaleX
                            const height = result.rect.height * scaleY
                            
                            // æ ¹æ®classå’Œcolorå­—æ®µåˆ¤æ–­ç±»å‹
                            const className = (result.class || '').toLowerCase()
                            const isInsulator = className === 'insulator' || className === 'insulators' || className.includes('insulator')
                            // å¦‚æœä¸æ˜¯ç»ç¼˜å­ï¼Œåˆ™é»˜è®¤ä¸ºç¼ºé™·
                            const isDefect = !isInsulator || result.color === 'red'
                            
                            // ç¼ºé™·ç”¨çº¢è‰²ï¼Œç»ç¼˜å­ç”¨è“è‰²
                            const boxColor = isDefect ? '#ff4d4f' : '#1890ff'
                            const confidence = result.confidence || 0
                            
                            return (
                              <div
                                key={index}
                                style={{
                                  position: 'absolute',
                                  left: `${x}px`,
                                  top: `${y}px`,
                                  width: `${width}px`,
                                  height: `${height}px`,
                                  border: `1px solid ${boxColor}`,
                                  borderRadius: '2px',
                                  pointerEvents: 'none',
                                  backgroundColor: 'transparent'
                                }}
                              >
                                {/* ç½®ä¿¡åº¦æ ‡ç­¾ - åªæ˜¾ç¤ºç™¾åˆ†æ¯” */}
                                {confidence > 0 && (
                                  <div
                                    style={{
                                      position: 'absolute',
                                      top: '-20px',
                                      left: '0',
                                      background: boxColor,
                                      color: '#fff',
                                      padding: '2px 6px',
                                      borderRadius: '2px',
                                      fontSize: '11px',
                                      fontWeight: '500',
                                      whiteSpace: 'nowrap',
                                      lineHeight: '1.2',
                                      minWidth: '35px',
                                      textAlign: 'center'
                                    }}
                                  >
                                    {confidence}%
                                  </div>
                                )}
                              </div>
                            )
                          })}
                        </div>
                        <Space size="large">
                          <Button
                            type="primary"
                            size="large"
                            loading={isDetecting}
                            onClick={handleDetection}
                            icon={<ApiOutlined />}
                            disabled={!selectedFile}
                            style={{
                              minWidth: '120px',
                              height: '40px'
                            }}
                          >
                            {isDetecting ? t.detecting : t.startDetection}
                          </Button>
                          
                          <Button
                            size="large"
                            onClick={handleClear}
                            style={{
                              minWidth: '80px',
                              height: '40px'
                            }}
                          >
                            {t.clear}
                          </Button>
                        </Space>
                        
                        {/* çŠ¶æ€æç¤º */}
                        {selectedFile && !isDetecting && (
                          <div style={{
                            marginTop: '12px',
                            padding: '8px 12px',
                            background: isDark ? '#1f4838' : '#f6ffed',
                            border: isDark ? '1px solid #274916' : '1px solid #b7eb8f',
                            borderRadius: '4px',
                            fontSize: '12px',
                            color: isDark ? '#95de64' : '#389e0d'
                          }}>
                            âœ“ {t.insulatorDetectionReady}
                          </div>
                        )}
                      </div>
                    )}
                  </Card>
                </Col>

                {/* å³ä¾§ï¼šæ ‡ç­¾é¡µåŒºåŸŸ */}
                <Col xs={24} lg={12} style={{ height: '100%' }}>
                  <Card 
                    style={{ 
                      height: '100%',
                      display: 'flex',
                      flexDirection: 'column',
                      background: isDark
                        ? 'linear-gradient(135deg, rgba(38,38,38,0.9) 0%, rgba(58,58,58,0.7) 50%, rgba(38,38,38,0.9) 100%)'
                        : 'linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.8) 50%, rgba(255,255,255,0.95) 100%)',
                      border: isDark
                        ? '1px solid rgba(255,255,255,0.12)' 
                        : '1px solid rgba(24, 144, 255, 0.12)',
                      backdropFilter: 'blur(12px)',
                      borderRadius: borderRadiusLG,
                      boxShadow: isDark
                        ? '0 4px 16px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1)' 
                        : '0 4px 16px rgba(24, 144, 255, 0.1), inset 0 1px 0 rgba(255,255,255,0.9)'
                    }}
                    bodyStyle={{ 
                      flex: 1,
                      padding: 0
                    }}
                  >
                    <Tabs 
                      activeKey={activeTab} 
                      onChange={setActiveTab}
                      style={{ height: '100%' }}
                      tabBarStyle={{ 
                        padding: '0 24px',
                        margin: 0,
                        borderBottom: isDark ? '1px solid #303030' : '1px solid #f0f0f0'
                      }}
                      items={[
                        {
                          key: '1',
                          label: t.detectionResults,
                          children: (
                            <div style={{ 
                              padding: '24px',
                              height: 'calc(100% - 48px)',
                              overflow: 'auto'
                            }}>
                              {error && (
                                <Alert
                                  message={t.detectionFailed}
                                  description={
                                    <div>
                                      <div style={{ marginBottom: '8px' }}>{error}</div>
                                      {error.includes('è¯†åˆ«å¤±è´¥') && (
                                        <div style={{ 
                                          padding: '8px 12px', 
                                          background: isDark ? '#1f1f1f' : '#f6ffed',
                                          border: isDark ? '1px solid #303030' : '1px solid #b7eb8f',
                                          borderRadius: '4px',
                                          fontSize: '12px',
                                          marginTop: '8px'
                                        }}>
                                          <strong>ğŸ’¡ {t.detectionTips}ï¼š</strong>
                                          <ul style={{ margin: '4px 0', paddingLeft: '16px' }}>
                                            {t.insulatorDetectionTips.map((tip, index) => (
                                              <li key={index}>{tip}</li>
                                            ))}
                                          </ul>
                                        </div>
                                      )}
                                    </div>
                                  }
                                  type="error"
                                  showIcon
                                  style={{ marginBottom: '16px' }}
                                />
                              )}
                              
                              {detectionResults.length > 0 && (
                                <div>
                                  <div style={{ 
                                    display: 'flex', 
                                    alignItems: 'center',
                                    marginBottom: '16px'
                                  }}>
                                    <CheckCircleOutlined style={{ 
                                      color: '#52c41a',
                                      fontSize: '18px',
                                      marginRight: '8px'
                                    }} />
                                    <Text strong style={{ fontSize: '16px' }}>
                                      {t.detectionResults} ({detectionResults.length} {t.detectedItems})
                                    </Text>
                                  </div>
                                  
                                  <List
                                    dataSource={detectionResults}
                                    renderItem={(result, index) => {
                                      // åˆ¤æ–­ç±»å‹
                                      const className = (result.class || '').toLowerCase()
                                      const isInsulator = className === 'insulator' || className === 'insulators' || className.includes('insulator')
                                      // å¦‚æœä¸æ˜¯ç»ç¼˜å­ï¼Œåˆ™é»˜è®¤ä¸ºç¼ºé™·
                                      const isDefect = !isInsulator || result.color === 'red'
                                      
                                      const typeLabel = isInsulator ? t.insulator : t.defect
                                      const typeColor = isInsulator ? 'blue' : 'red'
                                      const itemTitle = isInsulator ? `${t.insulator} #${index + 1}` : `${t.defect} #${index + 1}`
                                      
                                      return (
                                        <List.Item 
                                          key={index}
                                          style={{
                                            border: isDark ? '1px solid #303030' : '1px solid #f0f0f0',
                                            borderRadius: '8px',
                                            marginBottom: '12px',
                                            padding: '16px',
                                            background: isDark ? '#262626' : '#fafafa'
                                          }}
                                        >
                                          <List.Item.Meta
                                            avatar={
                                              <FileImageOutlined style={{ 
                                                fontSize: '24px', 
                                                color: isInsulator ? '#1890ff' : '#ff4d4f'
                                              }} />
                                            }
                                            title={
                                              <Space>
                                                <Text strong style={{ fontSize: '18px' }}>
                                                  {itemTitle}
                                                </Text>
                                                <Tag color={typeColor}>{typeLabel}</Tag>
                                              </Space>
                                            }
                                            description={
                                              <div>
                                                <div style={{ marginBottom: '8px' }}>
                                                  <Text type="secondary">{t.confidence}: </Text>
                                                  <Text style={{ marginLeft: '4px', fontWeight: 500 }}>
                                                    {result.confidence ? `${result.confidence}%` : (currentLang === 'en' ? 'Unknown' : 'æœªçŸ¥')}
                                                  </Text>
                                                </div>
                                                {result.rect && (
                                                  <Text type="secondary" style={{ fontSize: '12px' }}>
                                                    {t.position}: ({result.rect.x}, {result.rect.y}) | 
                                                    {t.size}: {result.rect.width} Ã— {result.rect.height}
                                                  </Text>
                                                )}
                                              </div>
                                            }
                                          />
                                        </List.Item>
                                      )
                                    }}
                                  />
                                </div>
                              )}
                              
                              {!isDetecting && !error && detectionResults.length === 0 && (
                                <div style={{ 
                                  textAlign: 'center', 
                                  padding: '60px 20px', 
                                  color: '#999',
                                  height: '100%',
                                  display: 'flex',
                                  flexDirection: 'column',
                                  justifyContent: 'center',
                                  alignItems: 'center'
                                }}>
                                  <FileImageOutlined style={{ 
                                    fontSize: '48px', 
                                    marginBottom: '16px',
                                    color: '#ccc'
                                  }} />
                                  <p style={{ fontSize: '16px', margin: 0 }}>{t.noDetectionData}</p>
                                </div>
                              )}
                            </div>
                          )
                        },
                        {
                          key: '2',
                          label: 'Request',
                          children: (
                            <div style={{ 
                              padding: '24px',
                              height: 'calc(100% - 48px)',
                              overflow: 'auto'
                            }}>
                              {requestData ? (
                                <pre style={{ 
                                  background: isDark ? '#1a1a1a' : '#f5f5f5',
                                  padding: '16px',
                                  borderRadius: '4px',
                                  overflow: 'auto',
                                  border: isDark ? '1px solid #303030' : '1px solid #e1e8ed',
                                  fontSize: '13px',
                                  lineHeight: '1.5'
                                }}>
                                  {JSON.stringify(requestData, null, 2)}
                                </pre>
                              ) : (
                                <div style={{ 
                                  textAlign: 'center', 
                                  padding: '60px 20px', 
                                  color: '#999',
                                  height: '100%',
                                  display: 'flex',
                                  flexDirection: 'column',
                                  justifyContent: 'center',
                                  alignItems: 'center'
                                }}>
                                  <ApiOutlined style={{ 
                                    fontSize: '48px', 
                                    marginBottom: '16px',
                                    color: '#ccc'
                                  }} />
                                  <p style={{ fontSize: '16px', margin: 0 }}>{t.noRequestData}</p>
                                </div>
                              )}
                            </div>
                          )
                        },
                        {
                          key: '3',
                          label: t.response,
                          children: (
                            <div style={{ 
                              padding: '24px',
                              height: 'calc(100% - 48px)',
                              overflow: 'auto',
                              display: 'flex',
                              flexDirection: 'column'
                            }}>
                              {responseData ? (
                                <>
                                  <pre style={{ 
                                    background: isDark ? '#1a1a1a' : '#f5f5f5',
                                    padding: '16px',
                                    borderRadius: '4px',
                                    overflow: 'auto',
                                    border: isDark ? '1px solid #303030' : '1px solid #e1e8ed',
                                    fontSize: '13px',
                                    lineHeight: '1.5',
                                    marginBottom: '24px',
                                    maxHeight: '300px'
                                  }}>
                                    {JSON.stringify(responseData, null, 2)}
                                  </pre>
                                  
                                </>
                              ) : (
                                <div style={{ 
                                  textAlign: 'center', 
                                  padding: '60px 20px', 
                                  color: '#999',
                                  height: '100%',
                                  display: 'flex',
                                  flexDirection: 'column',
                                  justifyContent: 'center',
                                  alignItems: 'center'
                                }}>
                                  <ApiOutlined style={{ 
                                    fontSize: '48px', 
                                    marginBottom: '16px',
                                    color: '#ccc'
                                  }} />
                                  <p style={{ fontSize: '16px', margin: 0 }}>{t.noResponseData}</p>
                                </div>
                              )}
                            </div>
                          )
                        }
                      ]}
                    />
                  </Card>
                </Col>
              </Row>
            </Content>
          </Layout>
        </Layout>
      </ConfigProvider>
    </>
  )
} 


'ä»ªè¡¨ç›˜é¡µé¢
/**
 * Dashboard Page Component
 * 
 * ä»ªè¡¨ç›˜ä¸»é¡µé¢ç»„ä»¶ï¼Œæä¾›ç³»ç»Ÿæ¦‚è§ˆã€ç»Ÿè®¡æ•°æ®å±•ç¤ºå’Œå¯¼èˆªåŠŸèƒ½
 * 
 * @module DashboardPage
 * @description 
 * è¯¥ç»„ä»¶å®ç°äº†ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š
 * - ç³»ç»Ÿæ¦‚è§ˆæ•°æ®å±•ç¤ºï¼ˆä»Šæ—¥æ£€æµ‹ã€å¹³å‡ç½®ä¿¡åº¦ã€åœ¨çº¿è®¾å¤‡ã€å·²å·¡æ£€çº¿è·¯ï¼‰
 * - å®æ—¶ç³»ç»ŸçŠ¶æ€ç›‘æ§ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡ï¼‰
 * - å¤šè¯­è¨€æ”¯æŒï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰
 * - ä¸»é¢˜åˆ‡æ¢ï¼ˆæ˜æš—æ¨¡å¼ï¼‰
 * - ç”¨æˆ·è®¤è¯çŠ¶æ€ç®¡ç†
 * - ä¾§è¾¹æ å¯¼èˆªèœå•
 * 
 * @performance
 * æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼š
 * - ä½¿ç”¨ React.useMemo ç¼“å­˜è®¡ç®—ç»“æœï¼ˆå›½é™…åŒ–æ–‡æœ¬ã€ä¸»é¢˜é…ç½®ã€èœå•é¡¹ï¼‰
 * - ä½¿ç”¨ React.useCallback ç¼“å­˜äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œå‡å°‘å­ç»„ä»¶ä¸å¿…è¦çš„é‡æ¸²æŸ“
 * - ç»„ä»¶æ‡’åŠ è½½å’Œä»£ç åˆ†å‰²
 * - ä½¿ç”¨å…±äº«ç»„ä»¶åº“å‡å°‘ä»£ç é‡å¤
 * - ç³»ç»ŸçŠ¶æ€æ•°æ®å®šæ—¶è½®è¯¢ï¼ˆ30ç§’é—´éš”ï¼‰ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
 * 
 * @author Aerotrace Development Team
 * @version 1.0.0
 */

"use client"

import React, { useEffect, useState, useMemo, useCallback } from 'react'
import { useRouter } from 'next/navigation'
import { useAuthStore } from '@/lib/store'
import { 
  Layout, 
  Menu, 
  Button, 
  Space, 
  Typography, 
  Breadcrumb, 
  Row, 
  Col,
  theme,
  ConfigProvider,
  Dropdown,
  Radio,
  Calendar,
  Card,
  Modal,
  Descriptions
} from 'antd'
import type { RadioChangeEvent, ConfigProviderProps } from 'antd'
import type { Dayjs } from 'dayjs'
import type { SystemStatusState, SystemStatusResponse } from '@/types/system'
import {
  MenuFoldOutlined,
  MenuUnfoldOutlined,
  HomeOutlined,
  UserOutlined,
  SettingOutlined,
  LogoutOutlined,
  QuestionCircleOutlined,
  DashboardOutlined,
  SunOutlined,
  MoonOutlined,
  DownOutlined,
  CloudServerOutlined,
  GlobalOutlined,
  ThunderboltOutlined,
  FileSearchOutlined,
  PercentageOutlined,
  LineChartOutlined
} from '@ant-design/icons'
import enUS from 'antd/locale/en_US'
import zhCN from 'antd/locale/zh_CN'
import dayjs from 'dayjs'
import 'dayjs/locale/zh-cn'

// å¯¼å…¥å…±äº«ç»„ä»¶
// æ³¨æ„ï¼šå¯¹äºé¢‘ç¹ä½¿ç”¨çš„ç»„ä»¶ï¼Œä½¿ç”¨é™æ€å¯¼å…¥ä»¥ä¼˜åŒ–æ€§èƒ½
// åŠ¨æ€å¯¼å…¥ä¸»è¦ç”¨äºå¤§å‹ç»„ä»¶æˆ–æ¡ä»¶æ¸²æŸ“çš„ç»„ä»¶
import { 
  StatisticCard, 
  WelcomeCard, 
  SystemStatusCard
} from '@/components/dashboard'
import { AvatarUpload } from '@/components/avatar-upload'
import { SidebarHeader } from '@/components/shared/SidebarHeader'
import { getI18nText, getCurrentLanguage, setLanguage, type Language } from '@/lib/i18n'
import { menuStyles } from '@/styles/menu-styles'
import { 
  siderStyles, 
  headerStyles, 
  getHeaderBackground, 
  getContentBackground,
  getBorderColor,
  getBoxShadow,
  getCardBackground
} from '@/styles/theme-styles'

const { Header, Sider, Content } = Layout
const { Title } = Typography

/**
 * Ant Design å›½é™…åŒ–è¯­è¨€é…ç½®ç±»å‹
 */
type Locale = ConfigProviderProps['locale']

/**
 * ä¸»é¢˜é…ç½®æ•°æ®ç»“æ„
 * 
 * @interface ThemeData
 * @property {number} borderRadius - ç»„ä»¶åœ†è§’åŠå¾„ï¼ˆåƒç´ ï¼‰
 * @property {string} colorPrimary - ä¸»é¢˜ä¸»è‰²è°ƒï¼ˆåå…­è¿›åˆ¶é¢œè‰²å€¼ï¼‰
 * @property {string} colorBgLayout - å¸ƒå±€èƒŒæ™¯è‰²
 * @property {string} colorBgContainer - å®¹å™¨èƒŒæ™¯è‰²
 * @property {'light' | 'dark'} algorithm - ä¸»é¢˜ç®—æ³•æ¨¡å¼ï¼ˆäº®è‰²/æš—è‰²ï¼‰
 */
type ThemeData = {
  borderRadius: number;
  colorPrimary: string;
  colorBgLayout: string;
  colorBgContainer: string;
  algorithm: 'light' | 'dark';
}

/**
 * é»˜è®¤äº®è‰²ä¸»é¢˜é…ç½®
 * 
 * @constant {ThemeData} defaultLightTheme
 * @description å®šä¹‰åº”ç”¨é»˜è®¤çš„äº®è‰²ä¸»é¢˜æ ·å¼å‚æ•°
 */
const defaultLightTheme: ThemeData = {
  borderRadius: 6,
  colorPrimary: '#1890ff',
  colorBgLayout: '#f0f4f8',
  colorBgContainer: '#ffffff',
  algorithm: 'light',
}

/**
 * é»˜è®¤æš—è‰²ä¸»é¢˜é…ç½®
 * 
 * @constant {ThemeData} defaultDarkTheme
 * @description å®šä¹‰åº”ç”¨é»˜è®¤çš„æš—è‰²ä¸»é¢˜æ ·å¼å‚æ•°
 */
const defaultDarkTheme: ThemeData = {
  borderRadius: 6,
  colorPrimary: '#177ddc',
  colorBgLayout: '#0a0a0a',
  colorBgContainer: '#1a1a1a',
  algorithm: 'dark',
}

export default function DashboardPage() {
  const router = useRouter()
  const { isAuthenticated, user, logout, updateUser } = useAuthStore()
  const [collapsed, setCollapsed] = useState(false)
  const [currentTheme, setCurrentTheme] = useState<ThemeData>(defaultLightTheme)
  const [locale, setLocale] = useState<Locale>(zhCN)
  const [currentLang, setCurrentLang] = useState<Language>(getCurrentLanguage())
  
  // æ·»åŠ ç³»ç»ŸçŠ¶æ€æ•°æ®çŠ¶æ€
  const [systemStatus, setSystemStatus] = useState<SystemStatusState>({
    cpu: 0,
    memory: 0,
    disk: 0,
    loading: true
  })

  // æ—¥å†ç›¸å…³çŠ¶æ€
  const [selectedDate, setSelectedDate] = useState<Dayjs>(dayjs())
  const [calendarValue, setCalendarValue] = useState<Dayjs>(dayjs())
  const [dateInfoVisible, setDateInfoVisible] = useState(false)

  const {
    token: { borderRadiusLG },
  } = theme.useToken()

  /**
   * è·å–ç³»ç»ŸçŠ¶æ€æ•°æ®
   * 
   * @function fetchSystemStatus
   * @description 
   * å¼‚æ­¥è·å–æœåŠ¡å™¨ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡ï¼‰
   * é€šè¿‡è°ƒç”¨ /api/system/status æ¥å£è·å–å®æ—¶æ•°æ®
   * 
   * @async
   * @returns {Promise<void>}
   * 
   * @errorHandling
   * å½“APIè¯·æ±‚å¤±è´¥æ—¶ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼ˆCPU: 25%, Memory: 65%, Disk: 40%ï¼‰
   * ç¡®ä¿UIå§‹ç»ˆèƒ½å¤Ÿæ­£å¸¸æ˜¾ç¤ºï¼Œé¿å…å› ç½‘ç»œé—®é¢˜å¯¼è‡´é¡µé¢å¼‚å¸¸
   * 
   * @performance
   * ä½¿ç”¨ useCallback ç¼“å­˜å‡½æ•°å¼•ç”¨ï¼Œé¿å…åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶é‡æ–°åˆ›å»ºå‡½æ•°
   * å‡å°‘å­ç»„ä»¶ä¸å¿…è¦çš„é‡æ¸²æŸ“
   */
  const fetchSystemStatus = useCallback(async () => {
    try {
      const response = await fetch('/api/system/status')
      const result: SystemStatusResponse = await response.json()
      
      if (result.success && result.data) {
        setSystemStatus({
          cpu: result.data.cpu || 0,
          memory: result.data.memory || 0,
          disk: result.data.disk || 0,
          loading: false
        })
      } else {
        // ä½¿ç”¨é»˜è®¤å€¼
        setSystemStatus({
          cpu: 25,
          memory: 65,
          disk: 40,
          loading: false
        })
      }
    } catch (error) {      // ä½¿ç”¨é»˜è®¤å€¼
      setSystemStatus({
        cpu: 25,
        memory: 65,
        disk: 40,
        loading: false
      })
    }
  }, [])

  /**
   * èº«ä»½éªŒè¯çŠ¶æ€æ£€æŸ¥ä¸ç”¨æˆ·æ•°æ®åˆå§‹åŒ–
   * 
   * @effect useEffect
   * @description 
   * åœ¨ç»„ä»¶æŒ‚è½½æ—¶æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
   * 1. éªŒè¯ç”¨æˆ·è®¤è¯çŠ¶æ€ï¼Œæœªç™»å½•åˆ™é‡å®šå‘åˆ°ç™»å½•é¡µ
   * 2. ä» localStorage æ¢å¤ç”¨æˆ·å¤´åƒæ•°æ®
   * 3. åŒæ­¥ç”¨æˆ·çŠ¶æ€åˆ°å…¨å±€çŠ¶æ€ç®¡ç†
   * 
   * @dependencies [isAuthenticated, router, user, updateUser]
   * @sideEffect å¯èƒ½è§¦å‘è·¯ç”±è·³è½¬æˆ–çŠ¶æ€æ›´æ–°
   */
  useEffect(() => {
    if (!isAuthenticated) {
      router.push('/login')
      return
    }

    // ä»localStorageæ¢å¤å¤´åƒ
    if (typeof window !== 'undefined' && user) {
      const savedAvatar = localStorage.getItem('userAvatar')
      if (savedAvatar && savedAvatar !== user.avatar) {
        updateUser({ avatar: savedAvatar })
      }
    }
  }, [isAuthenticated, router, user, updateUser])

  /**
   * ä¸»é¢˜ä¸è¯­è¨€è®¾ç½®åˆå§‹åŒ–
   * 
   * @effect useEffect
   * @description 
   * ä»æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ï¼ˆlocalStorageï¼‰æ¢å¤ç”¨æˆ·çš„ä¸»é¢˜å’Œè¯­è¨€åå¥½è®¾ç½®
   * è®¾ç½® Ant Design ç»„ä»¶çš„å›½é™…åŒ–é…ç½®å’Œ dayjs çš„æœ¬åœ°åŒ–è®¾ç½®
   * 
   * @dependencies [] - ä»…åœ¨ç»„ä»¶æŒ‚è½½æ—¶æ‰§è¡Œä¸€æ¬¡
   * @sideEffect æ›´æ–°ä¸»é¢˜çŠ¶æ€ã€è¯­è¨€çŠ¶æ€å’Œ Ant Design locale é…ç½®
   */
  useEffect(() => {
    const savedTheme = localStorage.getItem('themeMode')
    const lang = getCurrentLanguage()
    
    if (savedTheme === 'dark') {
      setCurrentTheme(defaultDarkTheme)
    }
    
    setCurrentLang(lang)
    if (lang === 'en') {
      setLocale(enUS)
      dayjs.locale('en')
    } else {
      setLocale(zhCN)
      dayjs.locale('zh-cn')
    }
  }, [])

  /**
   * ç³»ç»ŸçŠ¶æ€æ•°æ®å®šæ—¶è½®è¯¢
   * 
   * @effect useEffect
   * @description 
   * åœ¨ç”¨æˆ·å·²è®¤è¯çš„æƒ…å†µä¸‹ï¼Œå¯åŠ¨å®šæ—¶å™¨æ¯30ç§’è‡ªåŠ¨è·å–ä¸€æ¬¡ç³»ç»ŸçŠ¶æ€æ•°æ®
   * ç¡®ä¿ç³»ç»Ÿç›‘æ§æ•°æ®çš„å®æ—¶æ€§å’Œå‡†ç¡®æ€§
   * 
   * @dependencies [isAuthenticated, fetchSystemStatus]
   * @sideEffect åˆ›å»ºå®šæ—¶å™¨ï¼Œç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†ï¼Œé¿å…å†…å­˜æ³„æ¼
   * 
   * @performance
   * è½®è¯¢é—´éš”è®¾ç½®ä¸º30ç§’ï¼Œå¹³è¡¡æ•°æ®å®æ—¶æ€§å’ŒæœåŠ¡å™¨è´Ÿè½½
   */
  useEffect(() => {
    if (isAuthenticated) {
      fetchSystemStatus()
      const interval = setInterval(fetchSystemStatus, 30000)
      return () => clearInterval(interval)
    }
  }, [isAuthenticated, fetchSystemStatus])
  
  /**
   * ç”¨æˆ·ç™»å‡ºå¤„ç†å‡½æ•°
   * 
   * @function handleLogout
   * @description 
   * æ‰§è¡Œç”¨æˆ·ç™»å‡ºæ“ä½œï¼šæ¸…é™¤è®¤è¯çŠ¶æ€ï¼Œå¹¶é‡å®šå‘åˆ°ç™»å½•é¡µé¢
   * 
   * @returns {void}
   * 
   * @performance
   * ä½¿ç”¨ useCallback ç¼“å­˜å‡½æ•°å¼•ç”¨ï¼Œé¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
   */
  const handleLogout = useCallback(() => {
    logout()
    router.push('/login')
  }, [logout, router])

  /**
   * è·¯ç”±å¯¼èˆªå¤„ç†å‡½æ•°
   * 
   * @function handleNavigation
   * @description 
   * æ ¹æ®ä¼ å…¥çš„è·¯å¾„å‚æ•°æ‰§è¡Œç›¸åº”çš„è·¯ç”±è·³è½¬æ“ä½œ
   * æ”¯æŒå†…éƒ¨è·¯ç”±è·³è½¬å’Œå¤–éƒ¨é“¾æ¥æ‰“å¼€
   * 
   * @param {string} path - ç›®æ ‡è·¯ç”±è·¯å¾„æˆ–è·¯ç”±æ ‡è¯†ç¬¦
   * @returns {void}
   * 
   * @example
   * handleNavigation('detect') // è·³è½¬åˆ°ç»ç¼˜å­æ£€æµ‹é¡µé¢
   * handleNavigation('aboutus') // æ‰“å¼€å…³äºæˆ‘ä»¬å¤–éƒ¨é“¾æ¥
   * 
   * @performance
   * ä½¿ç”¨ useCallback ç¼“å­˜å‡½æ•°å¼•ç”¨ï¼Œå‡å°‘å­ç»„ä»¶é‡æ¸²æŸ“
   */
  const handleNavigation = useCallback((path: string) => {
    switch(path) {
      case 'detect':
        router.push('/insulator-detection')
        break
      case 'nest-detection':
        router.push('/nest-detection')
        break
      case 'settings/user':
        router.push('/settings?type=user')
        break
      case 'settings/general':
        router.push('/settings?type=general')
        break
      case 'aboutus':
        window.open('https://aboutus.rth2.xyz/about.html', '_blank')
        break
      default:
        break
    }
  }, [router])

  /**
   * ä¾§è¾¹æ èœå•é¡¹ç‚¹å‡»äº‹ä»¶å¤„ç†å‡½æ•°
   * 
   * @function handleMenuClick
   * @description 
   * å¤„ç†ä¾§è¾¹æ å¯¼èˆªèœå•çš„ç‚¹å‡»äº‹ä»¶ï¼Œæ ¹æ®èœå•é¡¹çš„ key å€¼æ‰§è¡Œç›¸åº”çš„è·¯ç”±è·³è½¬
   * 
   * @param {Object} params - èœå•ç‚¹å‡»äº‹ä»¶å‚æ•°å¯¹è±¡
   * @param {string} params.key - è¢«ç‚¹å‡»èœå•é¡¹çš„å”¯ä¸€æ ‡è¯†ç¬¦
   * @returns {void}
   * 
   * @performance
   * ä½¿ç”¨ useCallback ç¼“å­˜å‡½æ•°å¼•ç”¨ï¼Œé¿å…æ¯æ¬¡æ¸²æŸ“æ—¶é‡æ–°åˆ›å»º
   */
  const handleMenuClick = useCallback(({ key }: { key: string }) => {    if (key === 'dashboard') {
      // å·²ç»åœ¨ä»ªè¡¨ç›˜é¡µé¢ï¼Œä¸éœ€è¦è·³è½¬
      return
    } else if (key === 'detect') {
      router.push('/insulator-detection')
    } else if (key === 'nest-detection') {
      router.push('/nest-detection')
    } else if (key === 'aboutus') {
      router.push('/aboutus')
    } else if (key.startsWith('settings/')) {
      const type = key.split('/')[1]
      router.push(`/settings?type=${type}`)
    }
  }, [router])

  /**
   * è¯­è¨€åˆ‡æ¢å¤„ç†å‡½æ•°
   * 
   * @function handleLanguageChange
   * @description 
   * å¤„ç†ç”¨æˆ·è¯­è¨€åˆ‡æ¢æ“ä½œï¼Œæ›´æ–°åº”ç”¨è¯­è¨€è®¾ç½®å¹¶åŒæ­¥åˆ°æœ¬åœ°å­˜å‚¨
   * åŒæ—¶æ›´æ–° Ant Design ç»„ä»¶åº“å’Œ dayjs çš„æœ¬åœ°åŒ–é…ç½®
   * 
   * @param {RadioChangeEvent} e - Ant Design Radio ç»„ä»¶çš„å˜æ›´äº‹ä»¶å¯¹è±¡
   * @returns {void}
   * 
   * @performance
   * ä½¿ç”¨ useCallback ç¼“å­˜å‡½æ•°å¼•ç”¨ï¼Œä¼˜åŒ–äº‹ä»¶å¤„ç†æ€§èƒ½
   */
  const handleLanguageChange = useCallback((e: RadioChangeEvent) => {
    const lang = e.target.value as Language
    setCurrentLang(lang)
    setLanguage(lang) // ä¿å­˜åˆ°localStorage
    
    if (lang === 'en') {
      setLocale(enUS)
      dayjs.locale('en')
    } else {
      setLocale(zhCN)
      dayjs.locale('zh-cn')
    }
  }, [])

  /**
   * ä¸»é¢˜å¿«é€Ÿåˆ‡æ¢å¤„ç†å‡½æ•°
   * 
   * @function handleQuickThemeSwitch
   * @description 
   * åœ¨æ˜æš—ä¸»é¢˜ä¹‹é—´å¿«é€Ÿåˆ‡æ¢ï¼Œæ›´æ–°ä¸»é¢˜çŠ¶æ€å¹¶æŒä¹…åŒ–åˆ°æœ¬åœ°å­˜å‚¨
   * 
   * @returns {void}
   * 
   * @performance
   * ä½¿ç”¨ useCallback ç¼“å­˜å‡½æ•°å¼•ç”¨ï¼Œä¾èµ–é¡¹ä»…åŒ…å« currentTheme.algorithm
   * ç¡®ä¿ä¸»é¢˜åˆ‡æ¢æ—¶å‡½æ•°å¼•ç”¨ä¿æŒç¨³å®š
   */
  const handleQuickThemeSwitch = useCallback(() => {
    const newTheme = currentTheme.algorithm === 'light' ? defaultDarkTheme : defaultLightTheme
    setCurrentTheme(newTheme)
    localStorage.setItem('themeMode', newTheme.algorithm)
  }, [currentTheme.algorithm])

  /**
   * å›½é™…åŒ–æ–‡æœ¬å¯¹è±¡
   * 
   * @constant {Object} t
   * @description æ ¹æ®å½“å‰è¯­è¨€è®¾ç½®è·å–å¯¹åº”çš„å›½é™…åŒ–æ–‡æœ¬
   * 
   * @performance
   * ä½¿ç”¨ useMemo ç¼“å­˜è®¡ç®—ç»“æœï¼Œä»…åœ¨ currentLang å˜åŒ–æ—¶é‡æ–°è®¡ç®—
   */
  const t = useMemo(() => getI18nText(currentLang), [currentLang])
  
  /**
   * ä¸»é¢˜æ¨¡å¼æ ‡è¯†
   * 
   * @constant {boolean} isDark
   * @description åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºæš—è‰²ä¸»é¢˜æ¨¡å¼
   * 
   * @performance
   * ä½¿ç”¨ useMemo ç¼“å­˜è®¡ç®—ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—
   */
  const isDark = useMemo(() => currentTheme.algorithm === 'dark', [currentTheme.algorithm])

  /**
   * ç”¨æˆ·ä¸‹æ‹‰èœå•é…ç½®é¡¹
   * 
   * @constant {Array} userMenuItems
   * @description å®šä¹‰ç”¨æˆ·å¤´åƒä¸‹æ‹‰èœå•çš„èœå•é¡¹é…ç½®
   * åŒ…å«ç”¨æˆ·è®¾ç½®å’Œé€€å‡ºç™»å½•ä¸¤ä¸ªé€‰é¡¹
   * 
   * @performance
   * ä½¿ç”¨ useMemo ç¼“å­˜èœå•é¡¹æ•°ç»„ï¼Œé¿å…æ¯æ¬¡æ¸²æŸ“æ—¶é‡æ–°åˆ›å»º
   * ä¾èµ–é¡¹åŒ…å« t.userSettings, t.logout, handleNavigation, handleLogout
   */
  const userMenuItems = useMemo(() => [
    {
      key: 'settings',
      icon: <UserOutlined />,
      label: t.userSettings,
      onClick: () => handleNavigation('settings/user')
    },
    {
      key: 'divider',
      type: 'divider' as const
    },
    {
      key: 'logout',
      icon: <LogoutOutlined />,
      label: t.logout,
      onClick: handleLogout
    }
  ], [t.userSettings, t.logout, handleNavigation, handleLogout])
  
  if (!isAuthenticated) {
    return null
  }

  /**
   * ä¾§è¾¹æ å¯¼èˆªèœå•é…ç½®é¡¹
   * 
   * @constant {Array} sideMenuItems
   * @description å®šä¹‰ä¾§è¾¹æ å¯¼èˆªèœå•çš„æ‰€æœ‰èœå•é¡¹é…ç½®
   * åŒ…æ‹¬ä»ªè¡¨ç›˜ã€æ£€æµ‹åŠŸèƒ½ã€è®¾ç½®å’Œå…³äºæˆ‘ä»¬ç­‰èœå•é¡¹
   * 
   * @performance
   * ä½¿ç”¨ useMemo ç¼“å­˜èœå•é¡¹æ•°ç»„ï¼Œä»…åœ¨ç›¸å…³å›½é™…åŒ–æ–‡æœ¬å˜åŒ–æ—¶é‡æ–°åˆ›å»º
   * å‡å°‘ä¸å¿…è¦çš„æ•°ç»„é‡å»ºï¼Œæå‡æ¸²æŸ“æ€§èƒ½
   */
  const sideMenuItems = useMemo(() => [
    {
      key: 'dashboard',
      icon: <DashboardOutlined />,
      label: t.dashboard,
    },
    {
      key: 'detect',
      icon: <ThunderboltOutlined />,
      label: t.carRecognition,
    },
    {
      key: 'nest-detection',
      icon: <HomeOutlined />,
      label: t.nestDetection,
    },
    {
      key: 'settings',
      icon: <SettingOutlined />,
      label: t.systemSettings,
      children: [
        {
          key: 'settings/user',
          icon: <UserOutlined />,
          label: t.userSettings,
        },
        {
          key: 'settings/general',
          icon: <GlobalOutlined />,
          label: t.generalSettings,
        }
      ]
    },
    {
      key: 'aboutus',
      icon: <QuestionCircleOutlined />,
      label: t.aboutUs,
    }
  ], [t.dashboard, t.carRecognition, t.nestDetection, t.systemSettings, t.userSettings, t.generalSettings, t.aboutUs])

  /**
   * Ant Design ä¸»é¢˜é…ç½®å¯¹è±¡
   * 
   * @constant {Object} themeConfig
   * @description 
   * æ ¹æ®å½“å‰ä¸»é¢˜æ¨¡å¼ç”Ÿæˆ Ant Design ç»„ä»¶çš„ä¸»é¢˜é…ç½®
   * åŒ…æ‹¬é¢œè‰²ã€åœ†è§’ã€è¾¹æ¡†ã€é˜´å½±ç­‰è§†è§‰æ ·å¼å‚æ•°
   * 
   * @performance
   * ä½¿ç”¨ useMemo ç¼“å­˜ä¸»é¢˜é…ç½®å¯¹è±¡ï¼Œä»…åœ¨ä¸»é¢˜ç›¸å…³å‚æ•°å˜åŒ–æ—¶é‡æ–°è®¡ç®—
   * é¿å…æ¯æ¬¡æ¸²æŸ“æ—¶é‡æ–°åˆ›å»ºå¤§å‹é…ç½®å¯¹è±¡ï¼Œæå‡æ€§èƒ½
   */
  const themeConfig = useMemo(() => ({
    token: {
      colorPrimary: currentTheme.colorPrimary,
      borderRadius: currentTheme.borderRadius,
      colorBgLayout: currentTheme.colorBgLayout,
      colorBgContainer: currentTheme.colorBgContainer,
      colorBgElevated: isDark ? '#262626' : '#ffffff',
      colorBorder: isDark ? '#303030' : '#e1e8ed',
      colorBorderSecondary: isDark ? '#252525' : '#f0f0f0',
      colorText: isDark ? '#ffffff' : '#000000d9',
      colorTextSecondary: isDark ? '#bfbfbf' : '#00000073',
      colorTextTertiary: isDark ? '#8c8c8c' : '#00000045',
      colorFillAlter: isDark ? '#1f1f1f' : '#fafafa',
      colorFillContent: isDark ? '#262626' : '#f5f5f5',
      colorBgTextHover: isDark ? '#2a2a2a' : '#f5f5f5',
    },
    components: {
      Menu: {
        itemBg: 'transparent',
        subMenuItemBg: 'transparent',
        itemActiveBg: 'transparent',
        itemSelectedBg: 'rgba(255, 255, 255, 0.12)',
        itemHoverBg: 'rgba(255, 255, 255, 0.08)',
        subMenuBg: 'transparent',
      },
    },
    algorithm: isDark ? theme.darkAlgorithm : theme.defaultAlgorithm,
  }), [
    currentTheme.colorPrimary,
    currentTheme.borderRadius,
    currentTheme.colorBgLayout,
    currentTheme.colorBgContainer,
    isDark,
  ])
  
  return (
    <>
      {/* ä½¿ç”¨å…±äº«çš„èœå•æ ·å¼ */}
      <style jsx>{menuStyles}</style>
      <ConfigProvider locale={locale} theme={themeConfig}>
        <Layout style={{ height: '100vh', overflow: 'hidden' }}>
          {/* ä¾§è¾¹æ  */}
          <Sider 
            trigger={null} 
            collapsible 
            collapsed={collapsed}
            breakpoint="lg"
            collapsedWidth={collapsed ? 0 : siderStyles.collapsedWidth}
            width={siderStyles.width}
            style={{
              background: siderStyles.background,
              height: '100vh',
              overflow: 'auto',
              position: 'fixed',
              left: 0,
              top: 0,
              bottom: 0,
              zIndex: 999
            }}
          >
            {/* ä½¿ç”¨å…±äº«çš„ä¾§è¾¹æ å¤´éƒ¨ç»„ä»¶ */}
            <SidebarHeader
              collapsed={collapsed}
              title="å¾ªç¿¼ Aerotrace"
            />
            <Menu
              theme="dark"
              mode="inline"
              defaultSelectedKeys={['dashboard']}
              items={sideMenuItems}
              onClick={handleMenuClick}
              style={{ 
                borderRight: 0,
                background: 'transparent'
              }}
              className="custom-menu"
            />
          </Sider>

          <Layout style={{ marginLeft: collapsed ? 0 : siderStyles.width }}>
            {/* é¡¶éƒ¨å¯¼èˆªæ  */}
            <Header style={{ 
              display: 'flex', 
              alignItems: 'center',
              padding: headerStyles.padding,
              height: headerStyles.height,
              background: getHeaderBackground(isDark),
              justifyContent: 'space-between',
              boxShadow: getBoxShadow(isDark, 'header'),
              borderBottom: getBorderColor(isDark),
              backdropFilter: 'blur(12px)'
            }}>
              {/* å·¦ä¾§ï¼šæŠ˜å æŒ‰é’® */}
              <Button
                type="text"
                icon={collapsed ? <MenuUnfoldOutlined /> : <MenuFoldOutlined />}
                onClick={() => setCollapsed(!collapsed)}
                size="large"
                style={{
                  fontSize: '16px',
                  width: 40,
                  height: 40,
                  color: isDark ? '#ffffff' : '#1890ff'
                }}
              />

              {/* å³ä¾§ï¼šè¯­è¨€åˆ‡æ¢ + å¿«é€Ÿä¸»é¢˜åˆ‡æ¢ + ç”¨æˆ·ä¿¡æ¯ */}
              <Space size="middle">
                {/* è¯­è¨€åˆ‡æ¢ */}
                <Radio.Group 
                  value={currentLang} 
                  onChange={handleLanguageChange}
                  size="small"
                  buttonStyle="solid"
                >
                  <Radio.Button value="zh">ä¸­æ–‡</Radio.Button>
                  <Radio.Button value="en">EN</Radio.Button>
                </Radio.Group>

                {/* å¿«é€Ÿä¸»é¢˜åˆ‡æ¢åœ†å½¢æŒ‰é’® */}
                <Button
                  type="primary"
                  shape="circle"
                  size="large"
                  icon={isDark ? <SunOutlined /> : <MoonOutlined />}
                  onClick={handleQuickThemeSwitch}
                  style={{
                    width: 40,
                    height: 40,
                    backgroundColor: isDark ? '#faad14' : currentTheme.colorPrimary,
                    borderColor: isDark ? '#faad14' : currentTheme.colorPrimary,
                    boxShadow: isDark
                      ? '0 4px 12px rgba(250, 173, 20, 0.4)' 
                      : `0 4px 12px ${currentTheme.colorPrimary}40`
                  }}
                />

                {/* ç”¨æˆ·ä¸‹æ‹‰èœå• */}
                <Dropdown
                  menu={{ items: userMenuItems }}
                  placement="bottomRight"
                  arrow
                >
                  <Button type="text" size="large" style={{ padding: '4px 8px', height: 'auto', display: 'flex', alignItems: 'center' }}>
                    <Space align="center">
                      <AvatarUpload 
                        size={32}
                        showUpload={false}
                        style={{ backgroundColor: currentTheme.colorPrimary }}
                      />
                      <span style={{ 
                        color: isDark ? '#ffffff' : '#000000d9',
                        fontSize: '14px',
                        fontWeight: 500
                      }}>
                        {user?.username || (currentLang === 'zh' ? 'ç”¨æˆ·' : 'User')}
                      </span>
                      <DownOutlined style={{ 
                        fontSize: '12px',
                        color: isDark ? '#ffffff' : '#000000d9'
                      }} />
                    </Space>
                  </Button>
                </Dropdown>
              </Space>
            </Header>

            {/* å†…å®¹åŒºåŸŸ */}
            <Content style={{ 
              padding: '24px', 
              height: `calc(100vh - ${headerStyles.height}px)`, 
              overflow: 'hidden', 
              display: 'flex', 
              flexDirection: 'column' 
            }}>
              {/* é¢åŒ…å±‘å¯¼èˆª */}
              <Breadcrumb
                style={{ marginBottom: 16 }}
                items={[
                  { title: <HomeOutlined /> },
                  { title: (<><DashboardOutlined /><span>Dashboard</span></>) },
                  { title: t.overview },
                ]}
              />
              
              {/* ä¸»è¦å†…å®¹åŒºåŸŸ */}
              <div
                style={{
                  background: getContentBackground(isDark),
                  flex: 1,
                  padding: 24,
                  borderRadius: borderRadiusLG,
                  backdropFilter: 'blur(16px)',
                  border: getBorderColor(isDark),
                  boxShadow: getBoxShadow(isDark, 'content'),
                  overflow: 'hidden',
                  display: 'flex',
                  flexDirection: 'column'
                }}
              >
                {/* æ¬¢è¿å¡ç‰‡ - ä½¿ç”¨æ–°ç»„ä»¶ */}
                <div style={{ marginBottom: 16, flexShrink: 0 }}>
                  <WelcomeCard
                    username={user?.username}
                    email={user?.email}
                    welcomeText={t.welcomeBack}
                    adminText={t.admin}
                    onlineText={t.online}
                    isDark={isDark}
                    colorPrimary={currentTheme.colorPrimary}
                  />
                </div>
                
                {/* ç»Ÿè®¡å¡ç‰‡è¡Œ - ä½¿ç”¨æ–°ç»„ä»¶ */}
                <Row gutter={16} style={{ marginBottom: 16, flexShrink: 0 }}>
                  <Col span={6}>
                    <StatisticCard
                      title={t.todayRecognition}
                      value={30}
                      prefix={<FileSearchOutlined />}
                      valueStyle={{ color: '#3f8600' }}
                      isDark={isDark}
                    />
                  </Col>
                  <Col span={6}>
                    <StatisticCard
                      title={t.averageConfidence}
                      value={95.5}
                      precision={1}
                      suffix="%"
                      prefix={<PercentageOutlined />}
                      valueStyle={{ color: '#cf1322' }}
                      isDark={isDark}
                    />
                  </Col>
                  <Col span={6}>
                    <StatisticCard
                      title={t.onlineDevices}
                      value={1}
                      prefix={<CloudServerOutlined />}
                      valueStyle={{ color: currentTheme.colorPrimary }}
                      isDark={isDark}
                    />
                  </Col>
                  <Col span={6}>
                    <StatisticCard
                      title={t.inspectedLines}
                      value={12}
                      prefix={<LineChartOutlined />}
                      valueStyle={{ color: '#722ed1' }}
                      isDark={isDark}
                    />
                  </Col>
                </Row>
              
                {/* åŠŸèƒ½å¡ç‰‡è¡Œ - ä½¿ç”¨æ–°ç»„ä»¶ */}
                <Row gutter={16} style={{ flex: 1, minHeight: 0 }}>
                  <Col span={12}>
                    <SystemStatusCard
                      title={t.systemStatus}
                      cpuUsageText={t.cpuUsage}
                      memoryUsageText={t.memoryUsage}
                      diskUsageText={t.diskUsage}
                      cpuPercent={systemStatus.cpu}
                      memoryPercent={systemStatus.memory}
                      diskPercent={systemStatus.disk}
                      isDark={isDark}
                    />
                  </Col>
                  
                  <Col span={12}>
                    <Card
                      title={currentLang === 'zh' ? 'æ—¥å†' : 'Calendar'}
                      style={{
                        height: '100%',
                        background: getCardBackground(isDark),
                        border: getBorderColor(isDark),
                        backdropFilter: 'blur(12px)',
                        borderRadius: borderRadiusLG,
                        boxShadow: getBoxShadow(isDark, 'card')
                      }}
                      bodyStyle={{ 
                        padding: '16px',
                        height: 'calc(100% - 57px)',
                        overflow: 'hidden'
                      }}
                    >
                      <Calendar
                        fullscreen={false}
                        value={
                          // åªæœ‰å½“æŸ¥çœ‹çš„æœˆä»½ä¸é€‰ä¸­æ—¥æœŸçš„æœˆä»½ç›¸åŒæ—¶ï¼Œæ‰æ˜¾ç¤ºé€‰ä¸­çŠ¶æ€
                          // å¦åˆ™åªæ˜¾ç¤ºæœˆä»½ï¼Œä¸æ˜¾ç¤ºé€‰ä¸­çŠ¶æ€
                          calendarValue.year() === selectedDate.year() && 
                          calendarValue.month() === selectedDate.month()
                            ? selectedDate
                            : calendarValue
                        }
                        onSelect={useCallback((date: Dayjs) => {
                          setSelectedDate(date)
                          setDateInfoVisible(true)
                          // å½“é€‰æ‹©æ—¥æœŸæ—¶ï¼Œæ›´æ–°æ—¥å†æ˜¾ç¤ºåˆ°è¯¥æ—¥æœŸæ‰€åœ¨çš„æœˆä»½
                          setCalendarValue(date)
                        }, [])}
                        onPanelChange={useCallback((date: Dayjs) => {
                          setCalendarValue(date)
                        }, [])}
                        style={{
                          height: '100%'
                        }}
                      />
                    </Card>
                  </Col>
                </Row>
              </div>
            </Content>
          </Layout>
        </Layout>
      </ConfigProvider>

      {/* æ—¥æœŸä¿¡æ¯å¼¹çª— */}
      <Modal
        title={
          <Space>
            <span>{currentLang === 'zh' ? 'æ—¥æœŸä¿¡æ¯' : 'Date Information'}</span>
            <Typography.Text type="secondary" style={{ fontSize: '14px', fontWeight: 'normal' }}>
              {selectedDate.format('YYYY-MM-DD')}
            </Typography.Text>
          </Space>
        }
        open={dateInfoVisible}
        onCancel={() => setDateInfoVisible(false)}
        footer={[
          <Button key="close" type="primary" onClick={() => setDateInfoVisible(false)}>
            {currentLang === 'zh' ? 'å…³é—­' : 'Close'}
          </Button>
        ]}
        width={500}
      >
        <Descriptions column={1} bordered size="middle">
          <Descriptions.Item label={currentLang === 'zh' ? 'å…¬å†æ—¥æœŸ' : 'Gregorian Date'}>
            {currentLang === 'zh' 
              ? selectedDate.format('YYYYå¹´MMæœˆDDæ—¥')
              : selectedDate.format('MMMM DD, YYYY')
            }
          </Descriptions.Item>
          <Descriptions.Item label={currentLang === 'zh' ? 'æ˜ŸæœŸ' : 'Weekday'}>
            {currentLang === 'zh' 
              ? ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'][selectedDate.day()]
              : selectedDate.format('dddd')
            }
          </Descriptions.Item>
          <Descriptions.Item label={currentLang === 'zh' ? 'ç›¸å¯¹æ—¥æœŸ' : 'Relative Date'}>
            {(() => {
              const diff = selectedDate.diff(dayjs(), 'day')
              if (diff === 0) {
                return currentLang === 'zh' ? 'ä»Šå¤©' : 'Today'
              } else if (diff === 1) {
                return currentLang === 'zh' ? 'æ˜å¤©' : 'Tomorrow'
              } else if (diff === -1) {
                return currentLang === 'zh' ? 'æ˜¨å¤©' : 'Yesterday'
              } else if (diff > 0) {
                return currentLang === 'zh' ? `${diff}å¤©å` : `${diff} days later`
              } else {
                return currentLang === 'zh' ? `${Math.abs(diff)}å¤©å‰` : `${Math.abs(diff)} days ago`
              }
            })()}
          </Descriptions.Item>
          <Descriptions.Item label={currentLang === 'zh' ? 'å¹´ä»½' : 'Year'}>
            {selectedDate.format('YYYY')}
          </Descriptions.Item>
          <Descriptions.Item label={currentLang === 'zh' ? 'æœˆä»½' : 'Month'}>
            {currentLang === 'zh' 
              ? `${selectedDate.month() + 1}æœˆ`
              : selectedDate.format('MMMM')
            }
          </Descriptions.Item>
        </Descriptions>
      </Modal>
    </>
  )
} 


'APIå®¢æˆ·ç«¯
import axios, { AxiosInstance, AxiosResponse, AxiosRequestConfig } from 'axios'
import {
  LoginRequest,
  LoginResponse,
  RegisterRequest,
  RegisterResponse,
  ProfileResponse,
  DetailedProfileResponse,
  ProfileAvatarChangeRequest,
  ProfileAvatarChangeResponse,
  ApiResponse,
  AuthResponse,
  ApiVersionResponse,
  DetectRequest,
  DetectResponse,
  PlateInfo,
  // æ–°åç«¯ API ç±»å‹
  AutoRegisterRequest,
  AutoRegisterResponse,
  InspectionDetectResponse,
  InspectionRecordsQuery,
  InspectionRecordsResponse,
  InspectionRecord,
  UpdateRecordStatusRequest,
  StatisticsPeriod,
  StatisticsResponse,
  ConfidenceDistributionResponse,
  ApiSuccessResponse
} from '@/types/api'

// APIå®¢æˆ·ç«¯é…ç½®
interface ApiClientConfig {
  baseURL: string
  timeout?: number
  debug?: boolean
}

const DEFAULT_CONFIG: ApiClientConfig = {
  // æ–°åç«¯ API æœåŠ¡å™¨åœ°å€
  baseURL: 'https://cyzznvgauyxi.sealosbja.site',
  timeout: 30000,
  debug: process.env.NODE_ENV === 'development'
}

/**
 * TypeScript Retrofité£æ ¼çš„APIå®¢æˆ·ç«¯
 * å¯¹æ¥åç«¯ LicensePlate.Server API
 */
export class ApiClient {
  private axios: AxiosInstance
  private config: ApiClientConfig

  constructor(config: Partial<ApiClientConfig> = {}) {
    this.config = { ...DEFAULT_CONFIG, ...config }
    
    // åˆ›å»ºaxioså®ä¾‹ï¼ˆä½¿ç”¨ Session Cookie è®¤è¯ï¼‰
    this.axios = axios.create({
      baseURL: this.config.baseURL,
      timeout: this.config.timeout,
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      withCredentials: true // å¯ç”¨ Cookie è®¤è¯ï¼ˆNextAuth Sessionï¼‰
    })

    // è¯·æ±‚æ‹¦æˆªå™¨ï¼ˆæ–°åç«¯ä½¿ç”¨ Session Cookieï¼Œæ— éœ€æ‰‹åŠ¨æ·»åŠ  tokenï¼‰
    this.axios.interceptors.request.use(
      (config) => {
        // æ–°åç«¯ä½¿ç”¨ NextAuth Session Cookieï¼Œä¼šè‡ªåŠ¨æºå¸¦
        // ä¸å†éœ€è¦æ‰‹åŠ¨æ·»åŠ  Authorization token

        if (this.config.debug) {} ${config.url}`)
          if (config.data) {          }
        }

        return config
      },
      (error) => {        return Promise.reject(error)
      }
    )

    // å“åº”æ‹¦æˆªå™¨
    this.axios.interceptors.response.use(
      (response: AxiosResponse) => {
        if (this.config.debug) {        }
        return response
      },
      (error) => {        // å¤„ç†è®¤è¯é”™è¯¯
        if (error.response?.status === 401) {
          this.clearToken()
          // å¯ä»¥åœ¨è¿™é‡Œè§¦å‘ç™»å‡ºé€»è¾‘
        }

        return Promise.reject(error)
      }
    )
  }

    
  private getToken(): string | null {
    if (typeof window !== 'undefined') {
      return localStorage.getItem('auth_token')
    }
    return null
  }

  private setToken(token: string): void {
    if (typeof window !== 'undefined') {
      localStorage.setItem('auth_token', token)
    }
  }

  private clearToken(): void {
    if (typeof window !== 'undefined') {
      localStorage.removeItem('auth_token')
    }
  }

  
  /**
   * è‡ªåŠ¨æ³¨å†Œä¸´æ—¶è´¦å·ï¼ˆæ–°åç«¯ï¼‰
   * POST /api/auth/auto-register
   */
  async autoRegister(request?: AutoRegisterRequest): Promise<AutoRegisterResponse> {
    try {
      const response = await this.axios.post<ApiSuccessResponse<AutoRegisterResponse>>(
        '/api/auth/auto-register',
        request || {}
      )
      if (response.data.success) {
        return response.data.data
      }
      throw new Error('è‡ªåŠ¨æ³¨å†Œå¤±è´¥')
    } catch (error: any) {
      throw this.handleError(error, 'è‡ªåŠ¨æ³¨å†Œä¸´æ—¶è´¦å·å¤±è´¥')
    }
  }

  /**
   * ç”¨æˆ·æ³¨å†Œï¼ˆæ—§ APIï¼Œä¿ç•™å…¼å®¹ï¼‰
   * POST /api/v0/auth/register
   */
  async register(request: RegisterRequest): Promise<RegisterResponse> {
    try {
      const response = await this.axios.post<RegisterResponse>('/api/v0/auth/register', request)
      return response.data
    } catch (error: any) {
      throw this.handleError(error, 'æ³¨å†Œå¤±è´¥')
    }
  }

  /**
   * ç”¨æˆ·ç™»å½•
   * POST /api/v0/auth/login
   */
  async login(request: LoginRequest): Promise<LoginResponse> {
    try {
      const response = await this.axios.post<LoginResponse>('/api/v0/auth/login', request)
      
      // ä¿å­˜token
      if (response.data.isSuccess && response.data.token) {
        this.setToken(response.data.token)
      }
      
      return response.data
    } catch (error: any) {
      throw this.handleError(error, 'ç™»å½•å¤±è´¥')
    }
  }

  /**
   * ç”¨æˆ·ç™»å‡ºï¼ˆæ¸…é™¤æœ¬åœ°tokenï¼‰
   */
  async logout(): Promise<void> {
    this.clearToken()
  }

  
  /**
   * è·å–æŒ‡å®šç”¨æˆ·æ¡£æ¡ˆ
   * GET /api/v0/profile/{username}
   */
  async getProfile(username: string): Promise<ProfileResponse> {
    try {
      const response = await this.axios.get<ProfileResponse>(`/api/v0/profile/${username}`)
      return response.data
    } catch (error: any) {
      throw this.handleError(error, 'è·å–ç”¨æˆ·æ¡£æ¡ˆå¤±è´¥')
    }
  }

  /**
   * è·å–å½“å‰ç”¨æˆ·è¯¦ç»†æ¡£æ¡ˆ
   * GET /api/v0/profile
   */
  async getCurrentProfile(): Promise<DetailedProfileResponse> {
    try {
      const response = await this.axios.get<DetailedProfileResponse>('/api/v0/profile')
      return response.data
    } catch (error: any) {
      throw this.handleError(error, 'è·å–ç”¨æˆ·è¯¦ç»†æ¡£æ¡ˆå¤±è´¥')
    }
  }

  /**
   * è·å–æŒ‡å®šç”¨æˆ·å¤´åƒ
   * GET /api/v0/profile/{username}/avatar
   */
  async getUserAvatar(username: string): Promise<Blob> {
    try {
      const response = await this.axios.get(`/api/v0/profile/${username}/avatar`, {
        responseType: 'blob'
      })
      return response.data
    } catch (error: any) {
      throw this.handleError(error, 'è·å–ç”¨æˆ·å¤´åƒå¤±è´¥')
    }
  }

  /**
   * è·å–å½“å‰ç”¨æˆ·å¤´åƒ
   * GET /api/v0/profile/avatar
   */
  async getCurrentUserAvatar(): Promise<Blob> {
    try {
      const response = await this.axios.get('/api/v0/profile/avatar', {
        responseType: 'blob'
      })
      return response.data
    } catch (error: any) {
      throw this.handleError(error, 'è·å–ç”¨æˆ·å¤´åƒå¤±è´¥')
    }
  }

  /**
   * æ›´æ–°ç”¨æˆ·å¤´åƒ
   * POST /api/v0/profile/avatar
   */
  async updateAvatar(request: ProfileAvatarChangeRequest): Promise<ProfileAvatarChangeResponse> {
    try {
      const response = await this.axios.post<ProfileAvatarChangeResponse>('/api/v0/profile/avatar', request)
      return response.data
    } catch (error: any) {
      throw this.handleError(error, 'æ›´æ–°å¤´åƒå¤±è´¥')
    }
  }

  
  /**
   * Roboflowç»ç¼˜å­æ£€æµ‹ï¼ˆä½¿ç”¨Base64å›¾ç‰‡ï¼‰
   * POST https://serverless.roboflow.com/insulator-defect-c1kcs/1
   */
  async detectInsulatorByBase64(imageBase64: string): Promise<DetectResponse> {
    try {
      const ROBOFLOW_URL = 'https://serverless.roboflow.com/insulator-defect-c1kcs/1'
      const ROBOFLOW_API_KEY = 'cW6r5HCK2OL5sVo7ymUO'
      
      const response = await axios.post(ROBOFLOW_URL, imageBase64, {
        params: {
          api_key: ROBOFLOW_API_KEY
        },
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        timeout: 30000
      })
      
      // è½¬æ¢Roboflowå“åº”æ ¼å¼ä¸ºDetectResponseæ ¼å¼
      return this.convertRoboflowResponse(response.data)
    } catch (error: any) {
      throw this.handleError(error, 'ç»ç¼˜å­æ£€æµ‹å¤±è´¥')
    }
  }

  /**
   * Roboflowç»ç¼˜å­æ£€æµ‹ï¼ˆä½¿ç”¨å›¾ç‰‡æ–‡ä»¶ï¼‰
   */
  async detectInsulatorByImage(file: File): Promise<DetectResponse> {
    try {
      // å°†æ–‡ä»¶è½¬æ¢ä¸ºBase64ï¼ˆçº¯base64æ•°æ®ï¼Œä¸å«data:imageå‰ç¼€ï¼‰
      const base64 = await this.fileToBase64(file)
      // ç§»é™¤data:image/xxx;base64,å‰ç¼€ï¼Œåªä¿ç•™base64æ•°æ®
      const base64Data = base64.split(',')[1] || base64
      return await this.detectInsulatorByBase64(base64Data)
    } catch (error: any) {
      throw this.handleError(error, 'ç»ç¼˜å­æ£€æµ‹å¤±è´¥')
    }
  }

  /**
   * è½¬æ¢Roboflow APIå“åº”ä¸ºDetectResponseæ ¼å¼
   */
  private convertRoboflowResponse(roboflowData: any): DetectResponse {
    try {
      // Roboflowå“åº”æ ¼å¼ç¤ºä¾‹:
      // {
      //   "predictions": [
      //     {
      //       "x": 100,
      //       "y": 200,
      //       "width": 50,
      //       "height": 30,
      //       "confidence": 0.95,
      //       "class": "crack"
      //     }
      //   ],
      //   "image": {...}
      // }
      
      if (!roboflowData || !roboflowData.predictions) {
        return {
          isSuccess: false,
          messages: [{
            code: 'NO_DETECTIONS',
            description: 'æœªæ£€æµ‹åˆ°ç¼ºé™·'
          }]
        }
      }

      const predictions = roboflowData.predictions || []
      
      if (predictions.length === 0) {
        return {
          isSuccess: true,
          infos: [],
          messages: [{
            code: 'NO_DETECTIONS',
            description: 'æœªæ£€æµ‹åˆ°ç¼ºé™·'
          }]
        }
      }

      // è½¬æ¢ä¸ºPlateInfoæ ¼å¼ï¼ˆæš‚æ—¶å¤ç”¨ï¼Œåç»­å¯æ”¹ä¸ºCrackInfoï¼‰
      const infos: PlateInfo[] = predictions.map((pred: any, index: number) => {
        const className = (pred.class || '').toLowerCase()
        // åˆ¤æ–­æ˜¯ç»ç¼˜å­è¿˜æ˜¯ç¼ºé™·
        const isInsulator = className === 'insulator' || className === 'insulators' || className.includes('insulator')
        const isDefect = className === 'crack' || className === 'defect' || className.includes('crack') || className.includes('defect')
        
        // æ ¹æ®ç±»å‹è®¾ç½®ç¼–å·å’Œé¢œè‰²
        let number = ''
        let color = 'blue' // é»˜è®¤è“è‰²ï¼ˆç»ç¼˜å­ï¼‰
        
        if (isInsulator) {
          number = `ç»ç¼˜å­-${index + 1}`
          color = 'blue'
        } else {
          // å¦‚æœä¸æ˜¯ç»ç¼˜å­ï¼Œåˆ™é»˜è®¤ä¸ºç¼ºé™·
          number = `ç¼ºé™·-${index + 1}`
          color = 'red'
        }
        
        return {
          number,
          confidence: pred.confidence ? Math.round(pred.confidence * 100) : null,
          rect: {
            x: pred.x ? Math.round(pred.x - (pred.width || 0) / 2) : null,
            y: pred.y ? Math.round(pred.y - (pred.height || 0) / 2) : null,
            width: pred.width ? Math.round(pred.width) : null,
            height: pred.height ? Math.round(pred.height) : null
          },
          color,
          class: className // ä¿å­˜åŸå§‹classä¿¡æ¯
        }
      })

      return {
        isSuccess: true,
        infos: infos,
        messages: [{
          code: 'SUCCESS',
          description: `æˆåŠŸæ£€æµ‹åˆ° ${infos.length} ä¸ªç¼ºé™·`
        }]
      }
    } catch (error: any) {      return {
        isSuccess: false,
        messages: [{
          code: 'CONVERSION_ERROR',
          description: 'å“åº”æ•°æ®æ ¼å¼è½¬æ¢å¤±è´¥'
        }]
      }
    }
  }

  
  /**
   * Roboflowé¸Ÿå·¢æ£€æµ‹ï¼ˆä½¿ç”¨Base64å›¾ç‰‡ï¼‰
   * POST https://serverless.roboflow.com/birdnest-aqzoi-gelsg/1
   */
  async detectNestByBase64(imageBase64: string): Promise<DetectResponse> {
    try {
      const ROBOFLOW_URL = 'https://serverless.roboflow.com/birdnest-aqzoi-gelsg/1'
      const ROBOFLOW_API_KEY = 'cW6r5HCK2OL5sVo7ymUO'
      
      const response = await axios.post(ROBOFLOW_URL, imageBase64, {
        params: {
          api_key: ROBOFLOW_API_KEY
        },
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        timeout: 30000
      })
      
      // è½¬æ¢Roboflowå“åº”æ ¼å¼ä¸ºDetectResponseæ ¼å¼
      return this.convertRoboflowResponse(response.data)
    } catch (error: any) {
      throw this.handleError(error, 'é¸Ÿå·¢æ£€æµ‹å¤±è´¥')
    }
  }

  /**
   * Roboflowé¸Ÿå·¢æ£€æµ‹ï¼ˆä½¿ç”¨å›¾ç‰‡æ–‡ä»¶ï¼‰
   */
  async detectNestByImage(file: File): Promise<DetectResponse> {
    try {
      // å°†æ–‡ä»¶è½¬æ¢ä¸ºBase64ï¼ˆçº¯base64æ•°æ®ï¼Œä¸å«data:imageå‰ç¼€ï¼‰
      const base64 = await this.fileToBase64(file)
      // ç§»é™¤data:image/xxx;base64,å‰ç¼€ï¼Œåªä¿ç•™base64æ•°æ®
      const base64Data = base64.split(',')[1] || base64
      return await this.detectNestByBase64(base64Data)
    } catch (error: any) {
      throw this.handleError(error, 'é¸Ÿå·¢æ£€æµ‹å¤±è´¥')
    }
  }

  
  /**
   * å›¾ç‰‡ä¸Šä¼ å’Œæ£€æµ‹ï¼ˆæ–°åç«¯ - æ–‡ä»¶ä¸Šä¼ æ–¹å¼ï¼‰
   * POST /api/inspection/detect
   */
  async inspectionDetectByFile(file: File): Promise<InspectionDetectResponse> {
    try {
      const formData = new FormData()
      formData.append('image', file)

      const response = await this.axios.post<ApiSuccessResponse<InspectionDetectResponse>>(
        '/api/inspection/detect',
        formData,
        {
          headers: {
            'Content-Type': 'multipart/form-data'
          }
        }
      )

      if (response.data.success) {
        return response.data.data
      }
      throw new Error('æ£€æµ‹å¤±è´¥')
    } catch (error: any) {
      throw this.handleError(error, 'å›¾ç‰‡æ£€æµ‹å¤±è´¥')
    }
  }

  /**
   * å›¾ç‰‡ä¸Šä¼ å’Œæ£€æµ‹ï¼ˆæ–°åç«¯ - Base64æ–¹å¼ï¼‰
   * POST /api/inspection/detect
   */
  async inspectionDetectByBase64(imageBase64: string): Promise<InspectionDetectResponse> {
    try {
      // ç¡®ä¿ Base64 å­—ç¬¦ä¸²åŒ…å« data:image å‰ç¼€
      const base64Data = imageBase64.startsWith('data:image') 
        ? imageBase64 
        : `data:image/jpeg;base64,${imageBase64}`

      const response = await this.axios.post<ApiSuccessResponse<InspectionDetectResponse>>(
        '/api/inspection/detect',
        { imageBase64: base64Data },
        {
          headers: {
            'Content-Type': 'application/json'
          }
        }
      )

      if (response.data.success) {
        return response.data.data
      }
      throw new Error('æ£€æµ‹å¤±è´¥')
    } catch (error: any) {
      throw this.handleError(error, 'å›¾ç‰‡æ£€æµ‹å¤±è´¥')
    }
  }

  /**
   * è·å–æ£€æµ‹è®°å½•åˆ—è¡¨ï¼ˆæ–°åç«¯ï¼‰
   * GET /api/inspection/records
   */
  async getInspectionRecords(query?: InspectionRecordsQuery): Promise<InspectionRecordsResponse> {
    try {
      const response = await this.axios.get<ApiSuccessResponse<InspectionRecordsResponse>>(
        '/api/inspection/records',
        { params: query }
      )

      if (response.data.success) {
        return response.data.data
      }
      throw new Error('è·å–æ£€æµ‹è®°å½•å¤±è´¥')
    } catch (error: any) {
      throw this.handleError(error, 'è·å–æ£€æµ‹è®°å½•åˆ—è¡¨å¤±è´¥')
    }
  }

  /**
   * è·å–å•ä¸ªæ£€æµ‹è®°å½•ï¼ˆæ–°åç«¯ï¼‰
   * GET /api/inspection/records/:id
   */
  async getInspectionRecord(id: string): Promise<InspectionRecord> {
    try {
      const response = await this.axios.get<ApiSuccessResponse<InspectionRecord>>(
        `/api/inspection/records/${id}`
      )

      if (response.data.success) {
        return response.data.data
      }
      throw new Error('è·å–æ£€æµ‹è®°å½•å¤±è´¥')
    } catch (error: any) {
      throw this.handleError(error, 'è·å–æ£€æµ‹è®°å½•å¤±è´¥')
    }
  }

  /**
   * æ›´æ–°æ£€æµ‹è®°å½•çŠ¶æ€ï¼ˆæ–°åç«¯ï¼‰
   * PATCH /api/inspection/records/:id/status
   */
  async updateInspectionRecordStatus(
    id: string,
    request: UpdateRecordStatusRequest
  ): Promise<InspectionRecord> {
    try {
      const response = await this.axios.patch<ApiSuccessResponse<InspectionRecord>>(
        `/api/inspection/records/${id}/status`,
        request
      )

      if (response.data.success) {
        return response.data.data
      }
      throw new Error('æ›´æ–°æ£€æµ‹è®°å½•çŠ¶æ€å¤±è´¥')
    } catch (error: any) {
      throw this.handleError(error, 'æ›´æ–°æ£€æµ‹è®°å½•çŠ¶æ€å¤±è´¥')
    }
  }

  
  /**
   * è·å–ç»Ÿè®¡æ•°æ®ï¼ˆæ–°åç«¯ï¼‰
   * GET /api/statistics
   */
  async getStatistics(period: StatisticsPeriod = 'all'): Promise<StatisticsResponse> {
    try {
      const response = await this.axios.get<ApiSuccessResponse<StatisticsResponse>>(
        '/api/statistics',
        { params: { period } }
      )

      if (response.data.success) {
        return response.data.data
      }
      throw new Error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥')
    } catch (error: any) {
      throw this.handleError(error, 'è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥')
    }
  }

  /**
   * è·å–ç½®ä¿¡åº¦åˆ†å¸ƒè¯¦æƒ…ï¼ˆæ–°åç«¯ï¼‰
   * GET /api/statistics/distribution
   */
  async getConfidenceDistribution(
    period: StatisticsPeriod = 'all',
    bins: number = 10
  ): Promise<ConfidenceDistributionResponse> {
    try {
      const response = await this.axios.get<ApiSuccessResponse<ConfidenceDistributionResponse>>(
        '/api/statistics/distribution',
        { params: { period, bins } }
      )

      if (response.data.success) {
        return response.data.data
      }
      throw new Error('è·å–ç½®ä¿¡åº¦åˆ†å¸ƒå¤±è´¥')
    } catch (error: any) {
      throw this.handleError(error, 'è·å–ç½®ä¿¡åº¦åˆ†å¸ƒè¯¦æƒ…å¤±è´¥')
    }
  }

  
  /**
   * è½¦ç‰Œæ£€æµ‹ï¼ˆä½¿ç”¨Base64å›¾ç‰‡ï¼‰
   * POST /api/v0/detect
   */
  async detectPlateByBase64(imageBase64: string): Promise<DetectResponse> {
    try {
      // ç¡®ä¿æœ‰è®¤è¯ token
      await this.ensureAuthenticated()
      
      const response = await this.axios.post<DetectResponse>('/api/v0/detect', {
        imageBase64
      })
      return response.data
    } catch (error: any) {
      throw this.handleError(error, 'è½¦ç‰Œæ£€æµ‹å¤±è´¥')
    }
  }

  /**
   * è½¦ç‰Œæ£€æµ‹ï¼ˆä½¿ç”¨å›¾ç‰‡æ–‡ä»¶ï¼‰
   * POST /api/v0/detect/image
   */
  async detectPlateByImage(file: File): Promise<DetectResponse> {
    try {
      // ç¡®ä¿æœ‰è®¤è¯ token
      await this.ensureAuthenticated()
      
      // å‹ç¼©å›¾ç‰‡ï¼ˆå¦‚æœéœ€è¦ï¼‰
      const processedFile = await this.compressImageIfNeeded(file)
      
      try {
        // é¦–å…ˆå°è¯•æ–‡ä»¶ä¸Šä¼ æ–¹å¼
        const formData = new FormData()
        formData.append('file', processedFile)
        
        const response = await this.axios.post<DetectResponse>('/api/v0/detect/image', formData, {
          headers: {
            'Content-Type': 'multipart/form-data'
          }
        })
        return response.data
      } catch (fileUploadError: any) {        // å¦‚æœæ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œå°è¯•Base64æ–¹å¼
        const base64 = await this.fileToBase64(processedFile)
        return await this.detectPlateByBase64(base64)
      }
      
    } catch (error: any) {
      throw this.handleError(error, 'è½¦ç‰Œæ£€æµ‹å¤±è´¥')
    }
  }

  /**
   * å‹ç¼©å›¾ç‰‡ï¼ˆå¦‚æœæ–‡ä»¶è¿‡å¤§ï¼‰- ä¼˜åŒ–ç‰ˆæœ¬
   */
  private async compressImageIfNeeded(file: File): Promise<File> {
    const maxSize = 3 * 1024 * 1024 // æé«˜åˆ°3MBé™åˆ¶ï¼Œç»™OCRæ›´å¥½çš„å›¾ç‰‡è´¨é‡
    
    if (file.size <= maxSize) {.toFixed(2) + ' KB')
      return file
    }.toFixed(2) + ' KB')
    
    return new Promise((resolve, reject) => {
      const canvas = document.createElement('canvas')
      const ctx = canvas.getContext('2d')
      const img = new Image()
      
      img.onload = () => {
        // æ›´ä¿å®ˆçš„å‹ç¼©æ¯”ä¾‹ï¼Œä¿æŒæ›´å¥½çš„å›¾ç‰‡è´¨é‡
        const maxWidth = 2560  // æé«˜æœ€å¤§å®½åº¦
        const maxHeight = 1440 // æé«˜æœ€å¤§é«˜åº¦
        let { width, height } = img
        
        // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œä¼˜å…ˆä¿æŒå›¾ç‰‡æ¸…æ™°åº¦
        const widthRatio = maxWidth / width
        const heightRatio = maxHeight / height
        const ratio = Math.min(widthRatio, heightRatio, 1) // ä¸æ”¾å¤§å›¾ç‰‡
        
        const newWidth = Math.floor(width * ratio)
        const newHeight = Math.floor(height * ratio)
        
        canvas.width = newWidth
        canvas.height = newHeight
        
        // ä½¿ç”¨æ›´å¥½çš„å›¾ç‰‡ç»˜åˆ¶è®¾ç½®
        if (ctx) {
          ctx.imageSmoothingEnabled = true
          ctx.imageSmoothingQuality = 'high'
          ctx.drawImage(img, 0, 0, newWidth, newHeight)
        }
        
        // è½¬æ¢ä¸º Blobï¼Œä½¿ç”¨æ›´é«˜çš„èµ·å§‹è´¨é‡
        const tryCompress = (quality: number) => {
          canvas.toBlob((blob) => {
            if (blob) {
              if (blob.size <= maxSize || quality <= 0.3) { // æœ€ä½è´¨é‡æé«˜åˆ°30%
                // åˆ›å»ºæ–°çš„ File å¯¹è±¡
                const compressedFile = new File([blob], file.name, {
                  type: file.type,
                  lastModified: Date.now()
                }).toFixed(2) + ' KB',
                  'å‹ç¼©å:', (blob.size / 1024).toFixed(2) + ' KB',
                  'è´¨é‡:', Math.round(quality * 100) + '%',
                  'å°ºå¯¸:', `${newWidth}x${newHeight}`
                )
                
                resolve(compressedFile)
              } else {
                // ç»§ç»­é™ä½è´¨é‡ï¼Œä½†æ­¥é•¿æ›´å°
                tryCompress(quality - 0.05)
              }
            } else {
              reject(new Error('å›¾ç‰‡å‹ç¼©å¤±è´¥'))
            }
          }, file.type, quality)
        }
        
        // ä» 0.9 è´¨é‡å¼€å§‹å°è¯•ï¼Œæä¾›æ›´å¥½çš„å›¾ç‰‡è´¨é‡
        tryCompress(0.9)
      }
      
      img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'))
      img.src = URL.createObjectURL(file)
    })
  }

  /**
   * ç¡®ä¿å·²è®¤è¯ï¼Œå¦‚æœæ²¡æœ‰ token åˆ™è‡ªåŠ¨æ³¨å†Œå’Œç™»å½•
   */
  private async ensureAuthenticated(): Promise<void> {
    // å¦‚æœå·²æœ‰ tokenï¼Œç›´æ¥è¿”å›
    const existingToken = this.getToken()
    if (existingToken) {      return
    }    try {
      // ç”Ÿæˆä¸´æ—¶è´¦æˆ·ä¿¡æ¯
      const timestamp = Date.now()
      const tempEmail = `temp_${timestamp}@demo.com`
      const tempUsername = `temp_user_${timestamp}`
      const tempPassword = `TempPass_${timestamp}!`      // 1. å…ˆå°è¯•æ³¨å†Œ
      const registerResponse = await this.register({
        email: tempEmail,
        username: tempUsername,
        password: tempPassword
      })

      if (!registerResponse.isSuccess) {
        const errorMsg = registerResponse.messages?.[0]?.description || 'æ³¨å†Œå¤±è´¥'
        throw new Error(`æ³¨å†Œå¤±è´¥: ${errorMsg}`)
      }      // 2. æ³¨å†ŒæˆåŠŸåç«‹å³ç™»å½•
      const loginResponse = await this.login({
        email: tempEmail,
        password: tempPassword
      })

      if (!loginResponse.isSuccess || !loginResponse.token) {
        const errorMsg = loginResponse.messages?.[0]?.description || 'ç™»å½•å¤±è´¥'
        throw new Error(`ç™»å½•å¤±è´¥: ${errorMsg}`)
      }    } catch (error: any) {      throw new Error(`è®¤è¯å¤±è´¥: ${error.message}`)
    }
  }

  
  /**
   * è·å–ç”¨æˆ·å¤´åƒURLï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
   */
  getUserAvatarUrl(username: string): string {
    return `${this.config.baseURL}/api/v0/profile/${username}/avatar`
  }

  /**
   * è·å–å½“å‰ç”¨æˆ·å¤´åƒURL
   */
  getCurrentUserAvatarUrl(): string {
    return `${this.config.baseURL}/api/v0/profile/avatar`
  }

  /**
   * å°†æ–‡ä»¶è½¬æ¢ä¸ºBase64å­—ç¬¦ä¸²
   */
  async fileToBase64(file: File): Promise<string> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader()
      reader.onload = () => {
        const result = reader.result as string
        // ç§»é™¤data:image/...;base64,å‰ç¼€
        const base64 = result.split(',')[1]
        resolve(base64)
      }
      reader.onerror = reject
      reader.readAsDataURL(file)
    })
  }

  
  /**
   * å…¼å®¹ç°æœ‰ç™»å½•æ¥å£ï¼ˆæœ¬åœ°APIï¼‰
   */
  async localLogin(username: string, password: string): Promise<AuthResponse> {
    try {
      const response = await axios.post<AuthResponse>('/api/auth/login', {
        username,
        password
      })
      return response.data
    } catch (error: any) {
      throw this.handleError(error, 'æœ¬åœ°ç™»å½•å¤±è´¥')
    }
  }

  /**
   * å…¼å®¹ç°æœ‰æ³¨å†Œæ¥å£ï¼ˆæœ¬åœ°APIï¼‰
   */
  async localRegister(username: string, email: string, password: string): Promise<AuthResponse> {
    try {
      const response = await axios.post<AuthResponse>('/api/auth/register', {
        username,
        email,
        password
      })
      return response.data
    } catch (error: any) {
      throw this.handleError(error, 'æœ¬åœ°æ³¨å†Œå¤±è´¥')
    }
  }

  
  private handleError(error: any, defaultMessage: string): Error {    // æ£€æŸ¥æ˜¯å¦æœ‰å“åº”æ•°æ®
    if (error.response?.data) {
      const data = error.response.data
      
      // å¤„ç†æ–°åç«¯ API çš„é”™è¯¯æ ¼å¼ï¼ˆsuccess: false, error: stringï¼‰
      if (data.success === false && data.error) {
        return new Error(data.error)
      }
      
      // å¤„ç†åç«¯APIçš„æ ‡å‡†é”™è¯¯æ ¼å¼ï¼ˆæ—§æ ¼å¼ï¼‰
      if (data.messages && Array.isArray(data.messages) && data.messages.length > 0) {
        // åˆå¹¶æ‰€æœ‰é”™è¯¯æ¶ˆæ¯
        const messages = data.messages.map((msg: any) => msg.description || msg.code).join('; ')
        return new Error(messages)
      }

      // å¤„ç†ç®€å•çš„é”™è¯¯æ¶ˆæ¯
      if (data.message) {
        return new Error(data.message)
      }

      // å¤„ç†isSuccessä¸ºfalseçš„æƒ…å†µï¼ˆæ—§æ ¼å¼ï¼‰
      if (data.isSuccess === false) {
        return new Error(data.error || 'æ“ä½œå¤±è´¥')
      }
    }
    
    // å¤„ç† HTTP çŠ¶æ€ç é”™è¯¯
    if (error.response?.status) {
      const status = error.response.status
      if (status === 401) {
        return new Error('æœªè®¤è¯ï¼Œè¯·å…ˆç™»å½•')
      }
      if (status === 403) {
        return new Error('æƒé™ä¸è¶³')
      }
      if (status === 404) {
        return new Error('èµ„æºä¸å­˜åœ¨')
      }
      if (status === 500) {
        return new Error('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯')
      }
    }
    
    // å¤„ç†ç½‘ç»œé”™è¯¯
    if (error.code === 'NETWORK_ERROR' || error.code === 'ERR_NETWORK') {
      return new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')
    }
    
    // å¤„ç†è¶…æ—¶é”™è¯¯
    if (error.code === 'ECONNABORTED') {
      return new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•')
    }
    
    // å¤„ç†CORSé”™è¯¯
    if (error.message?.includes('CORS')) {
      return new Error('è·¨åŸŸè¯·æ±‚è¢«é˜»æ­¢ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®')
    }

    // ä½¿ç”¨åŸå§‹é”™è¯¯æ¶ˆæ¯
    if (error.message) {
      return new Error(error.message)
    }

    // ä½¿ç”¨é»˜è®¤æ¶ˆæ¯
    return new Error(defaultMessage)
  }

  
  /**
   * æ›´æ–°APIåŸºç¡€URL
   */
  setBaseURL(url: string): void {
    this.config.baseURL = url
    this.axios.defaults.baseURL = url
  }

  /**
   * è·å–å½“å‰é…ç½®
   */
  getConfig(): ApiClientConfig {
    return { ...this.config }
  }

  
  /**
   * è·å–APIç‰ˆæœ¬ä¿¡æ¯
   * GET /api/v0/info
   */
  async getApiInfo(): Promise<ApiVersionResponse> {
    try {
      const response = await this.axios.get<ApiVersionResponse>('/api/v0/info')
      return response.data
    } catch (error: any) {
      throw this.handleError(error, 'è·å–APIä¿¡æ¯å¤±è´¥')
    }
  }
}

// åˆ›å»ºé»˜è®¤å®ä¾‹
export const apiClient = new ApiClient()

// å¯¼å‡ºä¾¿æ·æ–¹æ³•
export const backendApi = {
  // APIä¿¡æ¯
  info: {
    get: () => apiClient.getApiInfo(),
  },

  // è®¤è¯
  auth: {
    login: (request: LoginRequest) => apiClient.login(request),
    register: (request: RegisterRequest) => apiClient.register(request),
    logout: () => apiClient.logout(),
    // æ–°åç«¯ï¼šè‡ªåŠ¨æ³¨å†Œä¸´æ—¶è´¦å·
    autoRegister: (request?: AutoRegisterRequest) => apiClient.autoRegister(request),
  },
  
  // ç»ç¼˜å­æ£€æµ‹ï¼ˆRoboflowï¼‰
  detect: {
    byBase64: (imageBase64: string) => apiClient.detectInsulatorByBase64(imageBase64),
    byImage: (file: File) => apiClient.detectInsulatorByImage(file),
    // ä¿ç•™åŸæœ‰çš„è½¦ç‰Œæ£€æµ‹æ–¹æ³•ï¼ˆå¦‚æœéœ€è¦ï¼‰
    plateByBase64: (imageBase64: string) => apiClient.detectPlateByBase64(imageBase64),
    plateByImage: (file: File) => apiClient.detectPlateByImage(file),
  },
  
  // é¸Ÿå·¢æ£€æµ‹ï¼ˆRoboflowï¼‰
  nestDetection: {
    byBase64: (imageBase64: string) => apiClient.detectNestByBase64(imageBase64),
    byImage: (file: File) => apiClient.detectNestByImage(file),
  },
  
  // æ–°åç«¯ï¼šæ£€æµ‹ç›¸å…³ API
  inspection: {
    // å›¾ç‰‡æ£€æµ‹ï¼ˆæ–‡ä»¶ä¸Šä¼ ï¼‰
    detectByFile: (file: File) => apiClient.inspectionDetectByFile(file),
    // å›¾ç‰‡æ£€æµ‹ï¼ˆBase64ï¼‰
    detectByBase64: (imageBase64: string) => apiClient.inspectionDetectByBase64(imageBase64),
    // è·å–æ£€æµ‹è®°å½•åˆ—è¡¨
    getRecords: (query?: InspectionRecordsQuery) => apiClient.getInspectionRecords(query),
    // è·å–å•ä¸ªæ£€æµ‹è®°å½•
    getRecord: (id: string) => apiClient.getInspectionRecord(id),
    // æ›´æ–°æ£€æµ‹è®°å½•çŠ¶æ€
    updateRecordStatus: (id: string, status: UpdateRecordStatusRequest) => 
      apiClient.updateInspectionRecordStatus(id, status),
  },
  
  // æ–°åç«¯ï¼šç»Ÿè®¡ç›¸å…³ API
  statistics: {
    // è·å–ç»Ÿè®¡æ•°æ®
    get: (period?: StatisticsPeriod) => apiClient.getStatistics(period),
    // è·å–ç½®ä¿¡åº¦åˆ†å¸ƒè¯¦æƒ…
    getDistribution: (period?: StatisticsPeriod, bins?: number) => 
      apiClient.getConfidenceDistribution(period, bins),
  },
  
  // ç”¨æˆ·æ¡£æ¡ˆ
  profile: {
    get: (username: string) => apiClient.getProfile(username),
    getCurrent: () => apiClient.getCurrentProfile(),
    getAvatar: (username: string) => apiClient.getUserAvatar(username),
    getCurrentAvatar: () => apiClient.getCurrentUserAvatar(),
    updateAvatar: (request: ProfileAvatarChangeRequest) => apiClient.updateAvatar(request),
    getAvatarUrl: (username: string) => apiClient.getUserAvatarUrl(username),
    getCurrentAvatarUrl: () => apiClient.getCurrentUserAvatarUrl(),
  },

  // æœ¬åœ°APIå…¼å®¹
  local: {
    login: (username: string, password: string) => apiClient.localLogin(username, password),
    register: (username: string, email: string, password: string) => apiClient.localRegister(username, email, password),
  },
  
  // å·¥å…·æ–¹æ³•
  utils: {
    fileToBase64: (file: File) => apiClient.fileToBase64(file),
  }
} 


'çŠ¶æ€ç®¡ç†
import { create } from 'zustand'
import { api } from './api'

// å®šä¹‰è½¦ç‰Œè¯†åˆ«è®°å½•ç±»å‹
export interface PlateRecord {
  id: string
  plateNumber: string
  timestamp: string | Date  // æ”¹ä¸ºå¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–æ—¥æœŸå¯¹è±¡
  imageUrl: string
}

// å®šä¹‰APIå“åº”ç±»å‹ - ä¿®å¤æ•°æ®ç»“æ„
interface AuthResponse {
  success: boolean
  message: string
  user?: {
    id: string
    username: string
    email: string
    avatar: string
    name: string
  }
}

interface PlateResponse extends PlateRecord {}

// å®šä¹‰è®¤è¯çŠ¶æ€
export interface AuthState {
  isAuthenticated: boolean
  user: {
    id?: string
    username?: string
    name: string
    avatar: string
    email?: string
  } | null
  login: (username: string, password: string) => Promise<boolean>
  setUser: (user: {
    id: string
    username: string
    name: string
    avatar: string
    email: string
  }) => void
  updateUser: (user: {
    id?: string
    username?: string
    name?: string
    avatar?: string
    email?: string
  }) => void
  updateAvatar: (avatarUrl: string) => void
  logout: () => void
}

// å®šä¹‰è®°å½•è¿‡æ»¤ç±»å‹
export type FilterType = 'all' | 'today' | 'week' | 'month'

// å®šä¹‰è®°å½•çŠ¶æ€
export interface RecordsState {
  records: PlateRecord[]
  isLoading: boolean
  filterType: FilterType
  setFilterType: (type: FilterType) => void
  fetchRecords: () => Promise<void>
  addRecord: (record: Omit<PlateRecord, 'id'>) => Promise<void>
  deleteRecord: (id: string) => Promise<void>
}

// åˆ›å»ºè®¤è¯å­˜å‚¨
export const useAuthStore = create<AuthState>((set, get) => {
  // åˆå§‹åŒ–æ—¶ä»localStorageæ¢å¤å¤´åƒ
  const initializeAvatar = () => {
    if (typeof window !== 'undefined') {
      const savedAvatar = localStorage.getItem('userAvatar')
      const currentUser = get().user
      if (savedAvatar && currentUser) {
        set({
          user: {
            ...currentUser,
            avatar: savedAvatar
          }
        })
      }
    }
  }
  
  return {
    isAuthenticated: false,
    user: null,
    
    login: async (username, password) => {
      try {        const response = await api.auth.login(username, password) as AuthResponse        if (response && response.success && response.user) {          set({
            isAuthenticated: true,
            user: {
              id: response.user.id,
              username: response.user.username,
              name: response.user.name || response.user.username,
              avatar: response.user.avatar || '/avatar.png',
              email: response.user.email
            }
          })
          return true
        } else {          return false
        }
      } catch (error) {        return false
      }
    },
    
    setUser: (user) => {      // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„å¤´åƒ
      let avatarUrl = user.avatar
      if (typeof window !== 'undefined') {
        const savedAvatar = localStorage.getItem('userAvatar')
        if (savedAvatar) {
          avatarUrl = savedAvatar
        }
      }
      
      set({
        isAuthenticated: true,
        user: {
          id: user.id,
          username: user.username,
          name: user.name,
          avatar: avatarUrl,
          email: user.email
        }
      })
    },
    
    updateUser: (updatedUser) => {      set((state) => ({
        user: state.user ? {
          ...state.user,
          ...updatedUser,
          name: updatedUser.name || updatedUser.username || state.user.name
        } : null
      }))
    },
    
    updateAvatar: (avatarUrl) => {      set((state) => ({
        user: state.user ? {
          ...state.user,
          avatar: avatarUrl
        } : null
      }))
      
      // åŒæ—¶ä¿å­˜åˆ°localStorageä»¥æŒä¹…åŒ–
      if (typeof window !== 'undefined') {
        localStorage.setItem('userAvatar', avatarUrl)
      }
    },
    
    logout: async () => {
      try {
        // è°ƒç”¨ç™»å‡ºAPI
        await api.auth.logout()
      } catch (error) {      } finally {
        // æ¸…é™¤å¤´åƒç¼“å­˜
        if (typeof window !== 'undefined') {
          localStorage.removeItem('userAvatar')
        }
        set({
          isAuthenticated: false,
          user: null
        })
      }
    }
  }
})

// åˆ›å»ºè®°å½•å­˜å‚¨
export const useRecordsStore = create<RecordsState>((set, get) => ({
  records: [],
  isLoading: false,
  filterType: 'all',
  
  setFilterType: (type) => set({ filterType: type }),
  
  fetchRecords: async () => {
    set({ isLoading: true })
    
    try {
      // ä½¿ç”¨çœŸå®APIè°ƒç”¨è·å–è®°å½•
      const response = await api.plates.list() as PlateRecord[]
      if (response && Array.isArray(response)) {
        set({ records: response, isLoading: false })
      } else {
        
      }
    } catch (error) {      set({ isLoading: false })
    }
  },
  
  addRecord: async (record) => {
    set({ isLoading: true })
    
    try {
      // ä½¿ç”¨çœŸå®APIè°ƒç”¨æ·»åŠ è®°å½•
      const response = await api.plates.create({
        plateNumber: record.plateNumber,
        imageUrl: record.imageUrl
      }) as PlateResponse
      
      if (response && response.id) {
        // å¦‚æœAPIè¿”å›äº†æ–°è®°å½•ï¼Œæ·»åŠ åˆ°åˆ—è¡¨ä¸­
        const newRecord: PlateRecord = {
          id: response.id,
          plateNumber: response.plateNumber,
          imageUrl: response.imageUrl,
          timestamp: typeof response.timestamp === 'object' 
            ? (response.timestamp as Date).toISOString() 
            : response.timestamp
        }
        
        set((state) => ({
          records: [newRecord, ...state.records],
          isLoading: false
        }))
      } else {
        )
    } catch (error) {      set({ isLoading: false })
      throw error
    }
  }
})) 


'ç”¨æˆ·æ•°æ®æŒä¹…åŒ–å­˜å‚¨
import fs from 'fs'
import path from 'path'

// ç”¨æˆ·æ•°æ®ç±»å‹
export interface PersistentUser {
  id: string
  username: string
  email: string
  password: string
  avatar: string
  createdAt: string
}

// æ•°æ®æ–‡ä»¶è·¯å¾„
const USERS_FILE = path.join(process.cwd(), 'data', 'users.json')

// ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨
function ensureDataDir() {
  const dataDir = path.dirname(USERS_FILE)
  if (!fs.existsSync(dataDir)) {
    fs.mkdirSync(dataDir, { recursive: true })
  }
}

// è¯»å–ç”¨æˆ·æ•°æ®
function readUsers(): PersistentUser[] {
  try {
    ensureDataDir()
    if (!fs.existsSync(USERS_FILE)) {
      return []
    }
    const data = fs.readFileSync(USERS_FILE, 'utf-8')
    return JSON.parse(data)
  } catch (error) {
    return []
  }
}

function writeUsers(users: PersistentUser[]) {
  try {
    ensureDataDir()
    fs.writeFileSync(USERS_FILE, JSON.stringify(users, null, 2))
  } catch (error) {
  }
}

// ç®€å•çš„å¯†ç å“ˆå¸Œå‡½æ•°
export function simpleHash(password: string): string {
  return Buffer.from(password).toString('base64')
}

// æŒä¹…åŒ–ç”¨æˆ·å­˜å‚¨
export const persistentUserStorage = {
  // æŸ¥æ‰¾ç”¨æˆ·ï¼ˆæŒ‰ç”¨æˆ·åï¼‰
  findByUsername: (username: string): PersistentUser | undefined => {
    const users = readUsers()    const user = users.find(user => user.username === username)    return user
  },

  // æŸ¥æ‰¾ç”¨æˆ·ï¼ˆæŒ‰é‚®ç®±ï¼‰
  findByEmail: (email: string): PersistentUser | undefined => {
    const users = readUsers()    const user = users.find(user => user.email === email)    return user
  },

  // æŸ¥æ‰¾ç”¨æˆ·ï¼ˆæŒ‰ç”¨æˆ·åæˆ–é‚®ç®±ï¼‰
  findByUsernameOrEmail: (identifier: string): PersistentUser | undefined => {
    const users = readUsers()))
    
    const user = users.find(user => 
      user.username === identifier || user.email === identifier
    )    return user
  },

  // æ·»åŠ æ–°ç”¨æˆ·
  addUser: (userData: Omit<PersistentUser, 'id' | 'createdAt'>): PersistentUser => {
    const users = readUsers()
    const newUser: PersistentUser = {
      ...userData,
      id: `id_${Date.now()}_${users.length + 1}`,
      createdAt: new Date().toISOString()
    }
    users.push(newUser)
    writeUsers(users)    return newUser
  },

  // è·å–æ‰€æœ‰ç”¨æˆ·ï¼ˆç”¨äºè°ƒè¯•ï¼‰
  getAllUsers: (): PersistentUser[] => {
    const users = readUsers()    return users
  },

  // éªŒè¯å¯†ç 
  verifyPassword: (storedPassword: string, inputPassword: string): boolean => {
    const hashedInput = simpleHash(inputPassword)
    const isValid = storedPassword === hashedInput+ '...', 
      è¾“å…¥å¯†ç å“ˆå¸Œ: hashedInput.substring(0, 10) + '...',
      éªŒè¯ç»“æœ: isValid 
    })
    return isValid
  }
} 


'å›½é™…åŒ–é…ç½®
/**
 * Internationalization (i18n) Module
 * 
 * å›½é™…åŒ–é…ç½®æ¨¡å—ï¼Œæä¾›å¤šè¯­è¨€æ”¯æŒåŠŸèƒ½
 * 
 * @module i18n
 * @description 
 * è¯¥æ¨¡å—æä¾›äº†ä»¥ä¸‹åŠŸèƒ½ï¼š
 * - å®šä¹‰æ”¯æŒçš„è¯­è¨€ç±»å‹ï¼ˆä¸­æ–‡ã€è‹±æ–‡ï¼‰
 * - å­˜å‚¨æ‰€æœ‰å›½é™…åŒ–æ–‡æœ¬å†…å®¹
 * - æä¾›è¯­è¨€è®¾ç½®å’Œè·å–çš„å®ç”¨å‡½æ•°
 * - æ”¯æŒä»æœ¬åœ°å­˜å‚¨è¯»å–å’Œä¿å­˜è¯­è¨€åå¥½
 * 
 * @author Aerotrace Development Team
 * @version 1.0.0
 */

/**
 * æ”¯æŒçš„è¯­è¨€ç±»å‹
 * 
 * @typedef {('zh' | 'en')} Language
 * @description 'zh' è¡¨ç¤ºä¸­æ–‡ï¼Œ'en' è¡¨ç¤ºè‹±æ–‡
 */
export type Language = 'zh' | 'en'

/**
 * å›½é™…åŒ–æ–‡æœ¬å†…å®¹å¯¹è±¡
 * 
 * @constant {Object} i18nTexts
 * @description 
 * åŒ…å«æ‰€æœ‰æ”¯æŒè¯­è¨€çš„æ–‡æœ¬å†…å®¹æ˜ å°„
 * æ¯ä¸ªè¯­è¨€å¯¹è±¡åŒ…å«åº”ç”¨æ‰€æœ‰é¡µé¢å’Œç»„ä»¶çš„æ–‡æœ¬å†…å®¹
 * 
 * @property {Object} zh - ä¸­æ–‡æ–‡æœ¬å†…å®¹
 * @property {Object} en - è‹±æ–‡æ–‡æœ¬å†…å®¹
 */
export const i18nTexts = {
  zh: {
    // èœå•é¡¹
    dashboard: 'ä»ªè¡¨ç›˜',
    carRecognition: 'ç»ç¼˜å­æ£€æµ‹',
    nestDetection: 'é¸Ÿå·¢æ£€æµ‹',
    configCheck: 'é…ç½®æ£€æŸ¥',
    backendDemo: 'åç«¯æ¼”ç¤º',
    systemSettings: 'ç³»ç»Ÿè®¾ç½®',
    aboutUs: 'å…³äºæˆ‘ä»¬',
    
    // ç”¨æˆ·èœå•
    profile: 'ä¸ªäººèµ„æ–™',
    userSettings: 'ç”¨æˆ·è®¾ç½®',
    generalSettings: 'é€šç”¨è®¾ç½®',
    logout: 'é€€å‡ºç™»å½•',
    
    // æ¬¢è¿åŒºåŸŸ
    welcomeBack: 'æ¬¢è¿å›æ¥',
    admin: 'ç®¡ç†å‘˜',
    online: 'åœ¨çº¿',
    
    // ç»Ÿè®¡å¡ç‰‡
    todayRecognition: 'ä»Šæ—¥æ£€æµ‹',
    averageConfidence: 'å¹³å‡ç½®ä¿¡åº¦',
    onlineDevices: 'åœ¨çº¿è®¾å¤‡',
    inspectedLines: 'å·²å·¡æ£€çº¿è·¯',
    
    // ç³»ç»ŸçŠ¶æ€
    systemStatus: 'ç³»ç»ŸçŠ¶æ€',
    cpuUsage: 'CPUä½¿ç”¨ç‡',
    memoryUsage: 'å†…å­˜ä½¿ç”¨ç‡',
    diskUsage: 'ç£ç›˜ä½¿ç”¨ç‡',
    
    // é¢åŒ…å±‘
    overview: 'æ¦‚è§ˆ',
    
    // æ£€æµ‹é¡µé¢é€šç”¨
    uploadImage: 'ä¸Šä¼ å›¾ç‰‡',
    clickOrDrag: 'ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸä¸Šä¼ ',
    supportedFormats: 'æ”¯æŒ jpgã€pngã€jpeg æ ¼å¼ï¼Œæ¨èæ–‡ä»¶å¤§å°å°äº 3MB',
    largeFileNotice: 'å¤§æ–‡ä»¶å°†è‡ªåŠ¨ä¼˜åŒ–å¤„ç†ä»¥ç¡®ä¿æœ€ä½³è¯†åˆ«æ•ˆæœ',
    fileName: 'æ–‡ä»¶å',
    fileSize: 'å¤§å°',
    fileType: 'ç±»å‹',
    startDetection: 'å¼€å§‹è¯†åˆ«',
    detecting: 'è¯†åˆ«ä¸­...',
    clear: 'æ¸…ç©º',
    readyToDetect: 'å›¾ç‰‡å·²å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹æ£€æµ‹"å³å¯æ£€æµ‹',
    
    // é¸Ÿå·¢æ£€æµ‹é¡µé¢
    nestDetectionTitle: 'é¸Ÿå·¢æ£€æµ‹',
    nestDetectionSubtitle: 'ä¸Šä¼ å›¾ç‰‡ï¼Œæ™ºèƒ½æ£€æµ‹é¸Ÿå·¢',
    nestDetectionReady: 'å›¾ç‰‡å·²å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹æ£€æµ‹"å³å¯æ£€æµ‹é¸Ÿå·¢',
    detectionResults: 'è¯†åˆ«ç»“æœ',
    noDetectionData: 'æš‚æ— æ£€æµ‹æ•°æ®',
    detectionFailed: 'è¯†åˆ«å¤±è´¥',
    detectionSuccess: 'æ£€æµ‹æˆåŠŸ',
    detectedItems: 'ä¸ªæ£€æµ‹é¡¹',
    nest: 'é¸Ÿå·¢',
    other: 'å…¶ä»–',
    confidence: 'ç½®ä¿¡åº¦',
    position: 'ä½ç½®',
    size: 'å°ºå¯¸',
    detectionTips: 'æ£€æµ‹å»ºè®®',
    detectionTipsList: [
      'ç¡®ä¿é¸Ÿå·¢æ¸…æ™°å¯è§ï¼Œæ²¡æœ‰åå…‰æˆ–æ¨¡ç³Š',
      'æ‹æ‘„æ—¶ä¿æŒé€‚å½“è·ç¦»ï¼Œé¸Ÿå·¢å å›¾ç‰‡åˆé€‚æ¯”ä¾‹',
      'é¿å…é¸Ÿå·¢è¢«é®æŒ¡ï¼ˆå¦‚æ ‘æã€æ ‘å¶ç­‰ï¼‰',
      'åœ¨å…‰çº¿å……è¶³çš„ç¯å¢ƒä¸‹æ‹æ‘„',
      'å°½é‡ä¿æŒå›¾ç‰‡æ°´å¹³ï¼Œé¿å…è¿‡åº¦å€¾æ–œ'
    ],
    
    // ç»ç¼˜å­æ£€æµ‹é¡µé¢
    insulatorDetectionTitle: 'ç»ç¼˜å­æ£€æµ‹',
    insulatorDetectionSubtitle: 'ä¸Šä¼ å›¾ç‰‡ï¼Œæ™ºèƒ½æ£€æµ‹ç»ç¼˜å­ç¼ºé™·',
    insulatorDetectionReady: 'å›¾ç‰‡å·²å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹æ£€æµ‹"å³å¯æ£€æµ‹ç»ç¼˜å­',
    insulator: 'ç»ç¼˜å­',
    defect: 'ç¼ºé™·',
    insulatorDetectionTips: [
      'ç¡®ä¿ç»ç¼˜å­æ¸…æ™°å¯è§ï¼Œæ²¡æœ‰åå…‰æˆ–æ¨¡ç³Š',
      'æ‹æ‘„æ—¶ä¿æŒé€‚å½“è·ç¦»ï¼Œç»ç¼˜å­å å›¾ç‰‡åˆé€‚æ¯”ä¾‹',
      'é¿å…ç»ç¼˜å­è¢«é®æŒ¡ï¼ˆå¦‚æ”¯æ¶ã€æ±¡æ¸ç­‰ï¼‰',
      'åœ¨å…‰çº¿å……è¶³çš„ç¯å¢ƒä¸‹æ‹æ‘„',
      'å°½é‡ä¿æŒå›¾ç‰‡æ°´å¹³ï¼Œé¿å…è¿‡åº¦å€¾æ–œ'
    ],
    
    // æ ‡ç­¾é¡µ
    request: 'Request',
    response: 'Response',
    noRequestData: 'æš‚æ— è¯·æ±‚æ•°æ®',
    noResponseData: 'æš‚æ— å“åº”æ•°æ®',
    
    // å…³äºæˆ‘ä»¬é¡µé¢
    aboutUsTitle: 'å…³äºæˆ‘ä»¬',
    aboutUsSubtitle: 'äº†è§£æˆ‘ä»¬çš„å›¢é˜Ÿå’Œäº§å“',
    companyName: 'å…¬å¸åç§°',
    companyDescription: 'å…¬å¸ç®€ä»‹',
    teamIntroduction: 'å›¢é˜Ÿä»‹ç»',
    contactUs: 'è”ç³»æˆ‘ä»¬',
    version: 'ç‰ˆæœ¬ä¿¡æ¯',
    copyright: 'ç‰ˆæƒæ‰€æœ‰'
  },
  en: {
    // èœå•é¡¹
    dashboard: 'Dashboard',
    carRecognition: 'Insulator Detection',
    nestDetection: 'Nest Detection',
    configCheck: 'Config Check',
    backendDemo: 'Backend Demo',
    systemSettings: 'System Settings',
    aboutUs: 'About Us',
    
    // ç”¨æˆ·èœå•
    profile: 'Profile',
    userSettings: 'User Settings',
    generalSettings: 'General Settings',
    logout: 'Logout',
    
    // æ¬¢è¿åŒºåŸŸ
    welcomeBack: 'Welcome back',
    admin: 'Admin',
    online: 'Online',
    
    // ç»Ÿè®¡å¡ç‰‡
    todayRecognition: "Today's Detection",
    averageConfidence: 'Average Confidence',
    onlineDevices: 'Online Devices',
    inspectedLines: 'Inspected Lines',
    
    // ç³»ç»ŸçŠ¶æ€
    systemStatus: 'System Status',
    cpuUsage: 'CPU Usage',
    memoryUsage: 'Memory Usage',
    diskUsage: 'Disk Usage',
    
    // é¢åŒ…å±‘
    overview: 'Overview',
    
    // æ£€æµ‹é¡µé¢é€šç”¨
    uploadImage: 'Upload Image',
    clickOrDrag: 'Click or drag file to this area to upload',
    supportedFormats: 'Supports jpg, png, jpeg formats, recommended file size less than 3MB',
    largeFileNotice: 'Large files will be automatically optimized for best recognition results',
    fileName: 'File Name',
    fileSize: 'Size',
    fileType: 'Type',
    startDetection: 'Start Detection',
    detecting: 'Detecting...',
    clear: 'Clear',
    readyToDetect: 'Image is ready, click "Start Detection" to detect',
    
    // é¸Ÿå·¢æ£€æµ‹é¡µé¢
    nestDetectionTitle: 'Nest Detection',
    nestDetectionSubtitle: 'Upload image to intelligently detect nests',
    nestDetectionReady: 'Image is ready, click "Start Detection" to detect nests',
    detectionResults: 'Detection Results',
    noDetectionData: 'No detection data',
    detectionFailed: 'Detection Failed',
    detectionSuccess: 'Detection Successful',
    detectedItems: 'detected items',
    nest: 'Nest',
    other: 'Other',
    confidence: 'Confidence',
    position: 'Position',
    size: 'Size',
    detectionTips: 'Detection Tips',
    detectionTipsList: [
      'Ensure the nest is clearly visible without reflection or blur',
      'Maintain appropriate distance when shooting, nest should occupy appropriate proportion of the image',
      'Avoid nest being blocked (such as branches, leaves, etc.)',
      'Shoot in well-lit environment',
      'Keep the image level as much as possible, avoid excessive tilt'
    ],
    
    // ç»ç¼˜å­æ£€æµ‹é¡µé¢
    insulatorDetectionTitle: 'Insulator Detection',
    insulatorDetectionSubtitle: 'Upload image to intelligently detect insulators defects',
    insulatorDetectionReady: 'Image is ready, click "Start Detection" to detect insulators',
    insulator: 'Insulator',
    defect: 'Defect',
    insulatorDetectionTips: [
      'Ensure the insulator is clearly visible without reflection or blur',
      'Maintain appropriate distance when shooting, insulator should occupy appropriate proportion of the image',
      'Avoid insulator being blocked (such as brackets, stains, etc.)',
      'Shoot in well-lit environment',
      'Keep the image level as much as possible, avoid excessive tilt'
    ],
    
    // æ ‡ç­¾é¡µ
    request: 'Request',
    response: 'Response',
    noRequestData: 'No request data',
    noResponseData: 'No response data',
    
    // å…³äºæˆ‘ä»¬é¡µé¢
    aboutUsTitle: 'About Us',
    aboutUsSubtitle: 'Learn about our team and products',
    companyName: 'Company Name',
    companyDescription: 'Company Description',
    teamIntroduction: 'Team Introduction',
    contactUs: 'Contact Us',
    version: 'Version',
    copyright: 'Copyright'
  }
}

/**
 * è·å–å½“å‰è¯­è¨€è®¾ç½®
 * 
 * @function getCurrentLanguage
 * @description 
 * ä»æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ï¼ˆlocalStorageï¼‰è¯»å–ç”¨æˆ·çš„è¯­è¨€åå¥½è®¾ç½®
 * å¦‚æœæœªè®¾ç½®æˆ–ä¸åœ¨æµè§ˆå™¨ç¯å¢ƒï¼Œåˆ™è¿”å›é»˜è®¤è¯­è¨€ï¼ˆä¸­æ–‡ï¼‰
 * 
 * @returns {Language} å½“å‰è¯­è¨€è®¾ç½®ï¼ˆ'zh' æˆ– 'en'ï¼‰
 * 
 * @example
 * const lang = getCurrentLanguage() // è¿”å› 'zh' æˆ– 'en'
 */
export function getCurrentLanguage(): Language {
  if (typeof window !== 'undefined') {
    const savedLang = localStorage.getItem('language')
    return (savedLang === 'en' ? 'en' : 'zh') as Language
  }
  return 'zh'
}

/**
 * è®¾ç½®è¯­è¨€åå¥½
 * 
 * @function setLanguage
 * @description 
 * å°†ç”¨æˆ·é€‰æ‹©çš„è¯­è¨€ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ï¼ˆlocalStorageï¼‰
 * ç”¨äºæŒä¹…åŒ–ç”¨æˆ·çš„è¯­è¨€åå¥½è®¾ç½®
 * 
 * @param {Language} lang - è¦è®¾ç½®çš„è¯­è¨€ï¼ˆ'zh' æˆ– 'en'ï¼‰
 * @returns {void}
 * 
 * @example
 * setLanguage('en') // è®¾ç½®è¯­è¨€ä¸ºè‹±æ–‡
 */
export function setLanguage(lang: Language): void {
  if (typeof window !== 'undefined') {
    localStorage.setItem('language', lang)
  }
}

/**
 * è·å–å›½é™…åŒ–æ–‡æœ¬å¯¹è±¡
 * 
 * @function getI18nText
 * @description 
 * æ ¹æ®æŒ‡å®šçš„è¯­è¨€è¿”å›å¯¹åº”çš„å›½é™…åŒ–æ–‡æœ¬å¯¹è±¡
 * å¦‚æœæœªæŒ‡å®šè¯­è¨€ï¼Œåˆ™ä½¿ç”¨å½“å‰è¯­è¨€è®¾ç½®
 * 
 * @param {Language} [lang] - å¯é€‰çš„è¯­è¨€å‚æ•°ï¼Œå¦‚æœä¸æä¾›åˆ™ä½¿ç”¨å½“å‰è¯­è¨€è®¾ç½®
 * @returns {Object} å¯¹åº”è¯­è¨€çš„å›½é™…åŒ–æ–‡æœ¬å¯¹è±¡
 * 
 * @example
 * const texts = getI18nText('en') // è·å–è‹±æ–‡æ–‡æœ¬å¯¹è±¡
 * const currentTexts = getI18nText() // è·å–å½“å‰è¯­è¨€çš„æ–‡æœ¬å¯¹è±¡
 */
export function getI18nText(lang?: Language) {
  const currentLang = lang || getCurrentLanguage()
  return i18nTexts[currentLang]
}



'å›¾ç‰‡å¤„ç†å·¥å…·
/**
 * å›¾ç‰‡å‹ç¼©å·¥å…·
 */

export interface CompressOptions {
  maxWidth?: number;
  maxHeight?: number;
  quality?: number;
  maxSizeKB?: number;
}

/**
 * å‹ç¼©å›¾ç‰‡
 */
export async function compressImage(
  file: File,
  options: CompressOptions = {}
): Promise<File> {
  const {
    maxWidth = 1920,
    maxHeight = 1080,
    quality = 0.8,
    maxSizeKB = 500,
  } = options;

  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        // è®¡ç®—æ–°å°ºå¯¸
        let width = img.width;
        let height = img.height;

        if (width > maxWidth || height > maxHeight) {
          const ratio = Math.min(maxWidth / width, maxHeight / height);
          width = width * ratio;
          height = height * ratio;
        }

        // åˆ›å»ºcanvasè¿›è¡Œå‹ç¼©
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        if (!ctx) {
          reject(new Error('æ— æ³•åˆ›å»ºcanvasä¸Šä¸‹æ–‡'));
          return;
        }

        ctx.drawImage(img, 0, 0, width, height);

        // è½¬æ¢ä¸ºblob
        canvas.toBlob(
          (blob) => {
            if (!blob) {
              reject(new Error('å›¾ç‰‡å‹ç¼©å¤±è´¥'));
              return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            const sizeKB = blob.size / 1024;
            if (sizeKB <= maxSizeKB) {
              const compressedFile = new File([blob], file.name, {
                type: file.type,
                lastModified: Date.now(),
              });
              resolve(compressedFile);
            } else {
              // å¦‚æœè¿˜æ˜¯å¤ªå¤§ï¼Œé™ä½è´¨é‡é‡è¯•
              canvas.toBlob(
                (smallerBlob) => {
                  if (!smallerBlob) {
                    reject(new Error('å›¾ç‰‡å‹ç¼©å¤±è´¥'));
                    return;
                  }
                  const compressedFile = new File([smallerBlob], file.name, {
                    type: file.type,
                    lastModified: Date.now(),
                  });
                  resolve(compressedFile);
                },
                file.type,
                quality * 0.7
              );
            }
          },
          file.type,
          quality
        );
      };
      img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
      img.src = e.target?.result as string;
    };
    reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
    reader.readAsDataURL(file);
  });
}

/**
 * æ–‡ä»¶è½¬Base64
 */
export function fileToBase64(file: File): Promise<string> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const base64 = reader.result as string;
      // ç§»é™¤data:image/xxx;base64,å‰ç¼€ï¼ˆå¦‚æœéœ€è¦ï¼‰
      resolve(base64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/**
 * è·å–æ–‡ä»¶å¤§å°ï¼ˆKBï¼‰
 */
export function getFileSizeKB(file: File): number {
  return file.size / 1024;
}



'æ£€æµ‹å·¥å…·å‡½æ•°
/**
 * æ£€æµ‹ç›¸å…³çš„å·¥å…·å‡½æ•°
 * æå–å…¬å…±çš„è®¡ç®—é€»è¾‘ï¼Œé¿å…é‡å¤ä»£ç 
 */

import type { PlateInfo } from '@/types/api'

/**
 * è®¡ç®—å›¾ç‰‡ç¼©æ”¾æ¯”ä¾‹
 */
export interface ImageSize {
  width: number
  height: number
  naturalWidth: number
  naturalHeight: number
}

/**
 * è®¡ç®—å›¾ç‰‡çš„ç¼©æ”¾æ¯”ä¾‹
 * @param displaySize æ˜¾ç¤ºå°ºå¯¸
 * @param naturalSize åŸå§‹å°ºå¯¸
 * @returns ç¼©æ”¾æ¯”ä¾‹ { scaleX, scaleY }
 */
export function calculateImageScale(
  displaySize: { width: number; height: number },
  naturalSize: { width: number; height: number }
): { scaleX: number; scaleY: number } {
  if (naturalSize.width > 0 && naturalSize.height > 0) {
    return {
      scaleX: displaySize.width / naturalSize.width,
      scaleY: displaySize.height / naturalSize.height,
    }
  }
  return { scaleX: 1, scaleY: 1 }
}

/**
 * åˆ¤æ–­æ£€æµ‹ç»“æœç±»å‹ï¼ˆç»ç¼˜å­æ£€æµ‹ï¼‰
 */
export function getInsulatorType(result: PlateInfo): {
  isInsulator: boolean
  isDefect: boolean
  typeLabel: string
  typeColor: string
} {
  const className = (result.class || '').toLowerCase()
  const isInsulator = className === 'insulator' || className === 'insulators' || className.includes('insulator')
  const isDefect = !isInsulator || result.color === 'red'
  
  return {
    isInsulator,
    isDefect,
    typeLabel: isInsulator ? 'insulator' : 'defect',
    typeColor: isDefect ? 'red' : 'blue',
  }
}

/**
 * åˆ¤æ–­æ£€æµ‹ç»“æœç±»å‹ï¼ˆé¸Ÿå·¢æ£€æµ‹ï¼‰
 */
export function getNestType(result: PlateInfo): {
  isNest: boolean
  isOther: boolean
  typeLabel: string
  typeColor: string
} {
  const className = (result.class || '').toLowerCase()
  const isNest = className === 'nest' || className === 'birdnest' || className.includes('nest')
  const isOther = !isNest || result.color === 'red'
  
  return {
    isNest,
    isOther,
    typeLabel: isNest ? 'nest' : 'other',
    typeColor: isNest ? 'blue' : 'red',
  }
}

/**
 * éªŒè¯æ£€æµ‹ç»“æœçš„æœ‰æ•ˆæ€§
 */
export function isValidDetectionResult(result: PlateInfo): boolean {
  return !!(
    result.rect &&
    result.rect.x !== null &&
    result.rect.y !== null &&
    result.rect.width !== null &&
    result.rect.height !== null
  )
}



'ç™»å½•ç³»ç»Ÿ
import { NextRequest, NextResponse } from 'next/server'
import { persistentUserStorage } from '@/lib/persistent-storage'

// æ·»åŠ CORSå¤„ç†
function corsHeaders() {
  return {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
  }
}

export async function OPTIONS() {
  return new NextResponse(null, {
    status: 200,
    headers: corsHeaders(),
  })
}

export async function POST(request: NextRequest) {
  try {
    const { username, password } = await request.json()
    
    if (!username || !password) {
      return NextResponse.json(
        { 
          success: false,
          message: 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ' 
        },
        { 
          status: 400,
          headers: corsHeaders()
        }
      )
      }
      
    const user = persistentUserStorage.findByUsernameOrEmail(username)
    
    if (!user) {
      return NextResponse.json(
        { 
          success: false,
          message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' 
        },
        { 
          status: 401,
          headers: corsHeaders()
        }
      )
    }
    
    const isPasswordValid = persistentUserStorage.verifyPassword(user.password, password)
    
    if (!isPasswordValid) {
      return NextResponse.json(
        { 
          success: false,
          message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' 
        },
        { 
          status: 401,
          headers: corsHeaders()
        }
      )
    }
    
    const userResponse = {
      id: user.id,
      username: user.username,
      email: user.email,
      avatar: user.avatar,
      name: user.username
    }
    
    return NextResponse.json(
      { 
        success: true,
        message: 'ç™»å½•æˆåŠŸ',
        user: userResponse,
        storage: 'file'
      },
      { 
        status: 200,
        headers: corsHeaders()
      }
    )
    
  } catch (error: any) {
    return NextResponse.json(
      { 
        success: false,
        message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' 
      },
      { 
        status: 500,
        headers: corsHeaders()
      }
    )
  }
} 


'ç³»ç»ŸçŠ¶æ€ç›‘æ§API
import { NextResponse } from 'next/server'
import { exec } from 'child_process'
import { promisify } from 'util'
import * as os from 'os'
import * as fs from 'fs'

const execAsync = promisify(exec)

// è·å–CPUä½¿ç”¨ç‡
async function getCpuUsage(): Promise<number> {
  try {
    // åœ¨Linuxç³»ç»Ÿä¸Šè·å–CPUä½¿ç”¨ç‡
    if (process.platform === 'linux') {
      const { stdout } = await execAsync("top -bn1 | grep 'Cpu(s)' | awk '{print $2}' | cut -d'%' -f1")
      const cpuUsage = parseFloat(stdout.trim())
      return isNaN(cpuUsage) ? 0 : Math.min(100, Math.max(0, cpuUsage))
    }
    
    // å¯¹äºå…¶ä»–ç³»ç»Ÿï¼Œä½¿ç”¨Node.jså†…ç½®æ–¹æ³•è®¡ç®—
    const cpus = os.cpus()
    let totalIdle = 0
    let totalTick = 0
    
    cpus.forEach(cpu => {
      for (const type in cpu.times) {
        totalTick += cpu.times[type as keyof typeof cpu.times]
      }
      totalIdle += cpu.times.idle
    })
    
    const idle = totalIdle / cpus.length
    const total = totalTick / cpus.length
    const usage = 100 - ~~(100 * idle / total)
    
    return Math.min(100, Math.max(0, usage))
  } catch (error) {    return 0 // è¿”å›10-60ä¹‹é—´çš„éšæœºå€¼ä½œä¸ºfallback
  }
}

// è·å–å†…å­˜ä½¿ç”¨ç‡
function getMemoryUsage(): number {
  try {
    const totalMem = os.totalmem()
    const freeMem = os.freemem()
    const usedMem = totalMem - freeMem
    const usage = (usedMem / totalMem) * 100
    
    return Math.min(100, Math.max(0, Math.round(usage)))
  } catch (error) {    return 0 // è¿”å›30-70ä¹‹é—´çš„éšæœºå€¼ä½œä¸ºfallback
  }
}

// è·å–ç£ç›˜ä½¿ç”¨ç‡
async function getDiskUsage(): Promise<number> {
  try {
    if (process.platform === 'linux' || process.platform === 'darwin') {
      const { stdout } = await execAsync("df / | tail -1 | awk '{print $5}' | sed 's/%//'")
      const diskUsage = parseInt(stdout.trim())
      return isNaN(diskUsage) ? 0 : Math.min(100, Math.max(0, diskUsage))
    }
    
    // Windowsç³»ç»Ÿçš„ç£ç›˜ä½¿ç”¨ç‡è·å–
    if (process.platform === 'win32') {
      const { stdout } = await execAsync('wmic logicaldisk get size,freespace,caption')
      const lines = stdout.trim().split('\n').slice(1)
      let totalSize = 0
      let totalFree = 0
      
      lines.forEach(line => {
        const parts = line.trim().split(/\s+/)
        if (parts.length >= 3) {
          const free = parseInt(parts[1])
          const size = parseInt(parts[2])
          if (!isNaN(free) && !isNaN(size)) {
            totalFree += free
            totalSize += size
          }
        }
      })
      
      if (totalSize > 0) {
        const usage = ((totalSize - totalFree) / totalSize) * 100
        return Math.min(100, Math.max(0, Math.round(usage)))
      }
    }
    
    return 0 // è¿”å›20-50ä¹‹é—´çš„éšæœºå€¼ä½œä¸ºfallback
  } catch (error) {    return 0 // è¿”å›20-50ä¹‹é—´çš„éšæœºå€¼ä½œä¸ºfallback
  }
}

export async function GET() {
  try {
    const [cpuUsage, memoryUsage, diskUsage] = await Promise.all([
      getCpuUsage(),
      getMemoryUsage(),
      getDiskUsage()
    ])

    return NextResponse.json({
      success: true,
      data: {
        cpu: cpuUsage,
        memory: memoryUsage,
        disk: diskUsage,
        timestamp: new Date().toISOString(),
        platform: process.platform,
        uptime: os.uptime()
      }
    })
  } catch (error) {    // è¿”å›æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºfallback
    return NextResponse.json({
      success: true,
      data: {
        cpu: 0,
        memory: 0,
        disk: 0,
        timestamp: new Date().toISOString(),
        platform: process.platform,
        uptime: os.uptime()
      }
    })
  }
} 


'ä¸­é—´ä»¶
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  // å¼€å‘æ¨¡å¼ä¸‹ï¼Œä¸ºé™æ€èµ„æºæ·»åŠ æ— ç¼“å­˜å¤´
  if (process.env.NODE_ENV === 'development') {
    const url = request.nextUrl.pathname
    
    // å¤„ç†é™æ€èµ„æºè¯·æ±‚
    if (
      url.startsWith('/_next/static/') ||
      url.startsWith('/_next/static/css/') ||
      url.startsWith('/_next/static/chunks/') ||
      url.startsWith('/_next/static/media/')
    ) {
      const response = NextResponse.next()
      
      // æ·»åŠ æ— ç¼“å­˜å¤´ï¼Œç¡®ä¿æµè§ˆå™¨æ€»æ˜¯è·å–æœ€æ–°èµ„æº
      response.headers.set('Cache-Control', 'no-store, must-revalidate')
      response.headers.set('Pragma', 'no-cache')
      response.headers.set('Expires', '0')
      
      return response
    }
  }
  
  return NextResponse.next()
}

export const config = {
  matcher: [
    /*
     * åŒ¹é…æ‰€æœ‰é™æ€èµ„æºè·¯å¾„
     */
    '/_next/static/:path*',
    '/_next/static/css/:path*',
    '/_next/static/chunks/:path*',
    '/_next/static/media/:path*',
  ],
}




'APIç±»å‹å®šä¹‰
// API åŸºç¡€ç±»å‹å®šä¹‰
export interface Message {
  code: string
  description: string
}

// åŸºç¡€å“åº”æ¥å£
export interface BaseResponse {
  isSuccess: boolean
  messages?: Message[]
}


// æ³¨å†Œè¯·æ±‚
export interface RegisterRequest {
  email: string
  username: string
  password: string
}

// æ³¨å†Œå“åº”
export interface RegisterResponse extends BaseResponse {
  url?: string
}

// ç™»å½•è¯·æ±‚
export interface LoginRequest {
  email: string
  password: string
}

// ç™»å½•å“åº”
export interface LoginResponse extends BaseResponse {
  id?: string
  token?: string
  expires?: string
}


// åŸºç¡€ç”¨æˆ·æ¡£æ¡ˆå“åº”
export interface ProfileResponse extends BaseResponse {
  username?: string
  avatarBase64?: string
}

// è¯¦ç»†ç”¨æˆ·æ¡£æ¡ˆå“åº”
export interface DetailedProfileResponse extends BaseResponse {
  email?: string
  username?: string
  avatarBase64?: string
}

// å¤´åƒæ›´æ”¹è¯·æ±‚
export interface ProfileAvatarChangeRequest {
  avatarBase64?: string
}

// å¤´åƒæ›´æ”¹å“åº”
export interface ProfileAvatarChangeResponse extends BaseResponse {}


// ç”¨æˆ·ä¿¡æ¯ï¼ˆæœ¬åœ°ä½¿ç”¨ï¼‰
export interface User {
  id: string
  username: string
  email: string
  avatar?: string
  name?: string
}

// è®¤è¯å“åº”ï¼ˆæœ¬åœ°APIï¼‰
export interface AuthResponse {
  success: boolean
  message: string
  user?: User
  storage?: 'file'
}

// è½¦ç‰Œè®°å½•ç±»å‹
export interface PlateRecord {
  id: string
  plateNumber: string
  timestamp: string | Date
  imageUrl: string
}


export interface ApiConfig {
  baseUrl: string
  timeout: number
  debug: boolean
}

// HTTPæ–¹æ³•ç±»å‹  
export type HttpMethod = 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH'

// è¯·æ±‚é€‰é¡¹
export interface RequestOptions {
  method?: HttpMethod
  headers?: Record<string, string>
  body?: any
  timeout?: number
}

// å“åº”ç±»å‹
export interface ApiResponse<T = any> {
  data: T
  status: number
  statusText: string
  headers: Record<string, string>
}


// APIç‰ˆæœ¬å“åº”
export interface ApiVersionResponse {
  appName: string
  version: string
}


// è½¦ç‰Œæ£€æµ‹è¯·æ±‚ï¼ˆBase64ï¼‰
export interface DetectRequest {
  imageBase64: string
}

// çŸ©å½¢ä½ç½®ä¿¡æ¯
export interface Rect {
  x: number | null
  y: number | null
  width: number | null
  height: number | null
}

// è½¦ç‰Œä¿¡æ¯ï¼ˆæš‚æ—¶å¤ç”¨ï¼Œç”¨äºç»ç¼˜å­æ£€æµ‹ï¼‰
export interface PlateInfo {
  number: string
  confidence: number | null
  rect: Rect
  color: string
  class?: string // æ·»åŠ classå­—æ®µï¼š'insulator' | 'crack' | 'defect' ç­‰
}

// è½¦ç‰Œæ£€æµ‹å“åº”
export interface DetectResponse extends BaseResponse {
  infos?: PlateInfo[]
}


// ç»Ÿä¸€å“åº”æ ¼å¼ï¼ˆæ–°åç«¯ï¼‰
export interface ApiSuccessResponse<T = any> {
  success: true
  data: T
}

export interface ApiErrorResponse {
  success: false
  error: string
}

export type BackendApiResponse<T = any> = ApiSuccessResponse<T> | ApiErrorResponse


// ç”¨æˆ·ä¿¡æ¯ï¼ˆæ–°åç«¯APIæ ¼å¼ï¼‰
export interface BackendUser {
  id: string
  email: string
  name: string | null
  role: 'USER' | 'ADMIN' | 'INSPECTOR'
  isTemporary?: boolean
  createdAt?: string
}

// ç™»å½•å“åº”æ•°æ®ï¼ˆæ–°åç«¯APIæ ¼å¼ï¼‰
export interface LoginResponseData {
  user: BackendUser
  message: string
}

// æ³¨å†Œå“åº”æ•°æ®ï¼ˆæ–°åç«¯APIæ ¼å¼ï¼‰
export interface RegisterResponseData {
  user: BackendUser
  message: string
}

// è‡ªåŠ¨æ³¨å†Œä¸´æ—¶è´¦å·è¯·æ±‚
export interface AutoRegisterRequest {
  deviceId?: string
  userAgent?: string
}

// ä¸´æ—¶ç”¨æˆ·ä¿¡æ¯
export interface TemporaryUser {
  id: string
  email: string
  name: string | null
  role: string
  isTemporary: boolean
}

// è‡ªåŠ¨æ³¨å†Œå“åº”
export interface AutoRegisterResponse {
  user: TemporaryUser
  temporaryPassword: string
  message: string
}


// æ£€æµ‹è®°å½•çŠ¶æ€
export type InspectionStatus = 'PENDING' | 'CONFIRMED' | 'REJECTED'

// æ£€æµ‹è®°å½•
export interface InspectionRecord {
  id: string
  imageUrl: string
  confidence: number
  detectedAt: string
  status: InspectionStatus
  createdAt?: string
  updatedAt?: string
  suggestions?: string[]
  originalSize?: number
  compressedSize?: number
  imageFormat?: string
  detectionMethod?: string
}

// æ£€æµ‹å“åº”ï¼ˆæ–°åç«¯ï¼‰
export interface InspectionDetectResponse {
  id: string
  imageUrl: string
  confidence: number
  detectedAt: string
  status: InspectionStatus
  suggestions?: string[]
  originalSize?: number
  compressedSize?: number
  imageFormat?: string
  detectionMethod?: string
}

// æ£€æµ‹è®°å½•åˆ—è¡¨æŸ¥è¯¢å‚æ•°
export interface InspectionRecordsQuery {
  page?: number
  limit?: number
  status?: InspectionStatus
  startDate?: string
  endDate?: string
  minConfidence?: number
  maxConfidence?: number
}

// åˆ†é¡µä¿¡æ¯
export interface PaginationInfo {
  page: number
  limit: number
  total: number
  totalPages: number
}

// æ£€æµ‹è®°å½•åˆ—è¡¨å“åº”
export interface InspectionRecordsResponse {
  records: InspectionRecord[]
  pagination: PaginationInfo
}

// æ›´æ–°æ£€æµ‹è®°å½•çŠ¶æ€è¯·æ±‚
export interface UpdateRecordStatusRequest {
  status: 'CONFIRMED' | 'REJECTED'
}


// ç»Ÿè®¡æ—¶é—´èŒƒå›´
export type StatisticsPeriod = 'today' | 'week' | 'all'

// ç½®ä¿¡åº¦åˆ†å¸ƒ
export interface ConfidenceDistribution {
  low: number    // 0.0 - 0.4
  medium: number // 0.4 - 0.7
  high: number   // 0.7 - 1.0
}

// çŠ¶æ€ç»Ÿè®¡
export interface StatusCount {
  pending: number
  confirmed: number
  rejected: number
}

// ç»Ÿè®¡æ•°æ®å“åº”
export interface StatisticsResponse {
  totalCount: number
  averageConfidence: number
  confidenceDistribution: ConfidenceDistribution
  statusCount: StatusCount
}

// ç½®ä¿¡åº¦åˆ†å¸ƒåŒºé—´
export interface ConfidenceBin {
  range: [number, number]
  count: number
}

// ç½®ä¿¡åº¦åˆ†å¸ƒè¯¦æƒ…å“åº”
export interface ConfidenceDistributionResponse {
  bins: number
  distribution: ConfidenceBin[]
} 

'ç”¨æˆ·è®¤è¯API
import { NextRequest, NextResponse } from 'next/server'
import { persistentUserStorage } from '@/lib/persistent-storage'

function corsHeaders() {
  return {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
  }
}

export async function OPTIONS() {
  return new NextResponse(null, {
    status: 200,
    headers: corsHeaders(),
  })
}

export async function POST(request: NextRequest) {
  try {    const { username, password } = await request.json()    if (!username || !password) {      return NextResponse.json(
        { 
          success: false,
          message: 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ' 
        },
        { 
          status: 400,
          headers: corsHeaders()
        }
      )
      }
      
    const user = persistentUserStorage.findByUsernameOrEmail(username)
    
    if (!user) {      return NextResponse.json(
        { 
          success: false,
          message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' 
        },
        { 
          status: 401,
          headers: corsHeaders()
        }
      )
    }
    
    const isPasswordValid = persistentUserStorage.verifyPassword(user.password, password)
    
    if (!isPasswordValid) {      return NextResponse.json(
        { 
          success: false,
          message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' 
        },
        { 
          status: 401,
          headers: corsHeaders()
        }
      )
    }    const userResponse = {
      id: user.id,
      username: user.username,
      email: user.email,
      avatar: user.avatar,
      name: user.username
    }
    
    return NextResponse.json(
      { 
        success: true,
        message: 'ç™»å½•æˆåŠŸ',
        user: userResponse,
        storage: 'file'
      },
      { 
        status: 200,
        headers: corsHeaders()
      }
    )
    
  } catch (error: any) {    return NextResponse.json(
      { 
        success: false,
        message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' 
      },
      { 
        status: 500,
        headers: corsHeaders()
      }
    )
  }
}

'ç”¨æˆ·æ•°æ®æŒä¹…åŒ–å­˜å‚¨
import fs from 'fs'
import path from 'path'

export interface PersistentUser {
  id: string
  username: string
  email: string
  password: string
  avatar: string
  createdAt: string
}

const USERS_FILE = path.join(process.cwd(), 'data', 'users.json')

function ensureDataDir() {
  const dataDir = path.dirname(USERS_FILE)
  if (!fs.existsSync(dataDir)) {
    fs.mkdirSync(dataDir, { recursive: true })
  }
}

function readUsers(): PersistentUser[] {
  try {
    ensureDataDir()
    if (!fs.existsSync(USERS_FILE)) {
      return []
    }
    const data = fs.readFileSync(USERS_FILE, 'utf-8')
    return JSON.parse(data)
  } catch (error) {    return []
  }
}

function writeUsers(users: PersistentUser[]) {
  try {
    ensureDataDir()
    fs.writeFileSync(USERS_FILE, JSON.stringify(users, null, 2))
  } catch (error) {  }
}

export function simpleHash(password: string): string {
  return Buffer.from(password).toString('base64')
}

export const persistentUserStorage = {
  findByUsername: (username: string): PersistentUser | undefined => {
    const users = readUsers()    const user = users.find(user => user.username === username)    return user
  },

  findByEmail: (email: string): PersistentUser | undefined => {
    const users = readUsers()    const user = users.find(user => user.email === email)    return user
  },

  findByUsernameOrEmail: (identifier: string): PersistentUser | undefined => {
    const users = readUsers()))
    
    const user = users.find(user => 
      user.username === identifier || user.email === identifier
    )    return user
  },

  addUser: (userData: Omit<PersistentUser, 'id' | 'createdAt'>): PersistentUser => {
    const users = readUsers()
    const newUser: PersistentUser = {
      ...userData,
      id: `id_${Date.now()}_${users.length + 1}`,
      createdAt: new Date().toISOString()
    }
    users.push(newUser)
    writeUsers(users)    return newUser
  },

  getAllUsers: (): PersistentUser[] => {
    const users = readUsers()    return users
  },

  verifyPassword: (storedPassword: string, inputPassword: string): boolean {
    const hashedInput = simpleHash(inputPassword)
    const isValid = storedPassword === hashedInput+ '...', 
      è¾“å…¥å¯†ç å“ˆå¸Œ: hashedInput.substring(0, 10) + '...',
      éªŒè¯ç»“æœ: isValid 
    })
    return isValid
  }
}

'ç³»ç»ŸçŠ¶æ€ç›‘æ§API
import { NextResponse } from 'next/server'
import { exec } from 'child_process'
import { promisify } from 'util'
import * as os from 'os'

const execAsync = promisify(exec)

async function getCpuUsage(): Promise<number> {
  try {
    if (process.platform === 'linux') {
      const { stdout } = await execAsync("top -bn1 | grep 'Cpu(s)' | awk '{print $2}' | cut -d'%' -f1")
      const cpuUsage = parseFloat(stdout.trim())
      return isNaN(cpuUsage) ? 0 : Math.min(100, Math.max(0, cpuUsage))
    }
    
    const cpus = os.cpus()
    let totalIdle = 0
    let totalTick = 0
    
    cpus.forEach(cpu => {
      for (const type in cpu.times) {
        totalTick += cpu.times[type as keyof typeof cpu.times]
      }
      totalIdle += cpu.times.idle
    })
    
    const idle = totalIdle / cpus.length
    const total = totalTick / cpus.length
    const usage = 100 - ~~(100 * idle / total)
    
    return Math.min(100, Math.max(0, usage))
  } catch (error) {
    return 0
  }
}

function getMemoryUsage(): number {
  try {
    const totalMem = os.totalmem()
    const freeMem = os.freemem()
    const usedMem = totalMem - freeMem
    const usage = (usedMem / totalMem) * 100
    
    return Math.min(100, Math.max(0, Math.round(usage)))
  } catch (error) {
    return 0
  }
}

async function getDiskUsage(): Promise<number> {
  try {
    if (process.platform === 'linux' || process.platform === 'darwin') {
      const { stdout } = await execAsync("df / | tail -1 | awk '{print $5}' | sed 's/%//'")
      const diskUsage = parseInt(stdout.trim())
      return isNaN(diskUsage) ? 0 : Math.min(100, Math.max(0, diskUsage))
    }
    
    if (process.platform === 'win32') {
      const { stdout } = await execAsync('wmic logicaldisk get size,freespace,caption')
      const lines = stdout.trim().split('\n').slice(1)
      let totalSize = 0
      let totalFree = 0
      
      lines.forEach(line => {
        const parts = line.trim().split(/\s+/)
        if (parts.length >= 3) {
          const free = parseInt(parts[1])
          const size = parseInt(parts[2])
          if (!isNaN(free) && !isNaN(size)) {
            totalFree += free
            totalSize += size
          }
        }
      })
      
      if (totalSize > 0) {
        const usage = ((totalSize - totalFree) / totalSize) * 100
        return Math.min(100, Math.max(0, Math.round(usage)))
      }
    }
    
    return 0
  } catch (error) {
    return 0
  }
}

export async function GET() {
  try {
    const [cpuUsage, memoryUsage, diskUsage] = await Promise.all([
      getCpuUsage(),
      getMemoryUsage(),
      getDiskUsage()
    ])

    return NextResponse.json({
      success: true,
      data: {
        cpu: cpuUsage,
        memory: memoryUsage,
        disk: diskUsage,
        timestamp: new Date().toISOString(),
        platform: process.platform,
        uptime: os.uptime()
      }
    })
  } catch (error) {
    return NextResponse.json({
      success: false,
      error: 'è·å–ç³»ç»ŸçŠ¶æ€å¤±è´¥',
      data: {
        cpu: 0,
        memory: 0,
        disk: 0,
        timestamp: new Date().toISOString(),
        platform: process.platform,
        uptime: os.uptime()
      }
    })
  }
}

'çŠ¶æ€ç®¡ç†
import { create } from 'zustand'
import { api } from './api'

export interface PlateRecord {
  id: string
  plateNumber: string
  timestamp: string | Date
  imageUrl: string
}

interface AuthResponse {
  success: boolean
  message: string
  user?: {
    id: string
    username: string
    email: string
    avatar: string
    name: string
  }
}

export interface AuthState {
  isAuthenticated: boolean
  user: {
    id?: string
    username?: string
    name: string
    avatar: string
    email?: string
  } | null
  login: (username: string, password: string) => Promise<boolean>
  setUser: (user: {
    id: string
    username: string
    name: string
    avatar: string
    email: string
  }) => void
  updateUser: (user: {
    id?: string
    username?: string
    name?: string
    avatar?: string
    email?: string
  }) => void
  updateAvatar: (avatarUrl: string) => void
  logout: () => void
}

export type FilterType = 'all' | 'today' | 'week' | 'month'

export interface RecordsState {
  records: PlateRecord[]
  isLoading: boolean
  filterType: FilterType
  setFilterType: (type: FilterType) => void
  fetchRecords: () => Promise<void>
  addRecord: (record: Omit<PlateRecord, 'id'>) => Promise<void>
  deleteRecord: (id: string) => Promise<void>
}

export const useAuthStore = create<AuthState>((set, get) => {
  const initializeAvatar = () => {
    if (typeof window !== 'undefined') {
      const savedAvatar = localStorage.getItem('userAvatar')
      const currentUser = get().user
      if (savedAvatar && currentUser) {
        set({
          user: {
            ...currentUser,
            avatar: savedAvatar
          }
        })
      }
    }
  }
  
  return {
    isAuthenticated: false,
    user: null,
    
    login: async (username, password) => {
      try {
        const response = await api.auth.login(username, password) as AuthResponse
        
        if (response && response.success && response.user) {
          set({
            isAuthenticated: true,
            user: {
              id: response.user.id,
              username: response.user.username,
              name: response.user.name || response.user.username,
              avatar: response.user.avatar || '/avatar.png',
              email: response.user.email
            }
          })
          return true
        } else {
          return false
        }
      } catch (error) {
        return false
      }
    },
    
    setUser: (user) => {
      let avatarUrl = user.avatar
      if (typeof window !== 'undefined') {
        const savedAvatar = localStorage.getItem('userAvatar')
        if (savedAvatar) {
          avatarUrl = savedAvatar
        }
      }
      
      set({
        isAuthenticated: true,
        user: {
          id: user.id,
          username: user.username,
          name: user.name,
          avatar: avatarUrl,
          email: user.email
        }
      })
    },
    
    updateUser: (updatedUser) => {
      set((state) => ({
        user: state.user ? {
          ...state.user,
          ...updatedUser,
          name: updatedUser.name || updatedUser.username || state.user.name
        } : null
      }))
    },
    
    updateAvatar: (avatarUrl) => {
      set((state) => ({
        user: state.user ? {
          ...state.user,
          avatar: avatarUrl
        } : null
      }))
      
      if (typeof window !== 'undefined') {
        localStorage.setItem('userAvatar', avatarUrl)
      }
    },
    
    logout: async () => {
      try {
        await api.auth.logout()
      } catch (error) {
      } finally {
        if (typeof window !== 'undefined') {
          localStorage.removeItem('userAvatar')
        }
        set({
          isAuthenticated: false,
          user: null
        })
      }
    }
  }
})

export const useRecordsStore = create<RecordsState>((set, get) => ({
  records: [],
  isLoading: false,
  filterType: 'all',
  
  setFilterType: (type) => set({ filterType: type }),
  
  fetchRecords: async () => {
    set({ isLoading: true })
    
    try {
      const response = await api.plates.list() as PlateRecord[]
      if (response && Array.isArray(response)) {
        set({ records: response, isLoading: false })
      } else {
        set({ records: [], isLoading: false })
      }
    } catch (error) {
      set({ isLoading: false })
    }
  },
  
  addRecord: async (record) => {
    set({ isLoading: true })
    
    try {
      const response = await api.plates.create({
        plateNumber: record.plateNumber,
        imageUrl: record.imageUrl
      }) as PlateRecord
      
      if (response && response.id) {
        const newRecord: PlateRecord = {
          id: response.id,
          plateNumber: response.plateNumber,
          imageUrl: response.imageUrl,
          timestamp: typeof response.timestamp === 'object' 
            ? (response.timestamp as Date).toISOString() 
            : response.timestamp
        }
        
        set((state) => ({
          records: [newRecord, ...state.records],
          isLoading: false
        }))
      } else {
        set({ isLoading: false })
      }
    } catch (error) {
      set({ isLoading: false })
      throw error
    }
  },
  
  deleteRecord: async (id) => {
    set({ isLoading: true })
    
    try {
      await api.plates.delete(id)
      
      set((state) => ({
        records: state.records.filter(record => record.id !== id),
        isLoading: false
      }))
    } catch (error) {
      set({ isLoading: false })
      throw error
    }
  }
}))

'APIå®¢æˆ·ç«¯æ ¸å¿ƒåŠŸèƒ½
import axios, { AxiosInstance, AxiosResponse } from 'axios'
import {
  LoginRequest,
  LoginResponse,
  RegisterRequest,
  RegisterResponse,
  ProfileResponse,
  DetailedProfileResponse,
  ProfileAvatarChangeRequest,
  ProfileAvatarChangeResponse,
  DetectResponse,
  PlateInfo,
  AutoRegisterRequest,
  AutoRegisterResponse,
  InspectionDetectResponse,
  InspectionRecordsQuery,
  InspectionRecordsResponse,
  InspectionRecord,
  UpdateRecordStatusRequest,
  StatisticsPeriod,
  StatisticsResponse,
  ConfidenceDistributionResponse,
  ApiSuccessResponse
} from '@/types/api'

interface ApiClientConfig {
  baseURL: string
  timeout?: number
  debug?: boolean
}

const DEFAULT_CONFIG: ApiClientConfig = {
  baseURL: 'https://cyzznvgauyxi.sealosbja.site',
  timeout: 30000,
  debug: process.env.NODE_ENV === 'development'
}

export class ApiClient {
  private axios: AxiosInstance
  private config: ApiClientConfig

  constructor(config: Partial<ApiClientConfig> = {}) {
    this.config = { ...DEFAULT_CONFIG, ...config }
    
    this.axios = axios.create({
      baseURL: this.config.baseURL,
      timeout: this.config.timeout,
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      withCredentials: true
    })

    this.axios.interceptors.request.use(
      (config) => {
        return config
      },
      (error) => {
        return Promise.reject(error)
      }
    )

    this.axios.interceptors.response.use(
      (response: AxiosResponse) => {
        return response
      },
      (error) => {
        if (error.response?.status === 401) {
          this.clearToken()
        }
        return Promise.reject(error)
      }
    )
  }

  private getToken(): string | null {
    if (typeof window !== 'undefined') {
      return localStorage.getItem('auth_token')
    }
    return null
  }

  private setToken(token: string): void {
    if (typeof window !== 'undefined') {
      localStorage.setItem('auth_token', token)
    }
  }

  private clearToken(): void {
    if (typeof window !== 'undefined') {
      localStorage.removeItem('auth_token')
    }
  }

  async autoRegister(request?: AutoRegisterRequest): Promise<AutoRegisterResponse> {
    try {
      const response = await this.axios.post<ApiSuccessResponse<AutoRegisterResponse>>(
        '/api/auth/auto-register',
        request || {}
      )
      if (response.data.success) {
        return response.data.data
      }
      throw new Error('è‡ªåŠ¨æ³¨å†Œå¤±è´¥')
    } catch (error: any) {
      throw this.handleError(error, 'è‡ªåŠ¨æ³¨å†Œä¸´æ—¶è´¦å·å¤±è´¥')
    }
  }

  async register(request: RegisterRequest): Promise<RegisterResponse> {
    try {
      const response = await this.axios.post<RegisterResponse>('/api/v0/auth/register', request)
      return response.data
    } catch (error: any) {
      throw this.handleError(error, 'æ³¨å†Œå¤±è´¥')
    }
  }

  async login(request: LoginRequest): Promise<LoginResponse> {
    try {
      const response = await this.axios.post<LoginResponse>('/api/v0/auth/login', request)
      
      if (response.data.isSuccess && response.data.token) {
        this.setToken(response.data.token)
      }
      
      return response.data
    } catch (error: any) {
      throw this.handleError(error, 'ç™»å½•å¤±è´¥')
    }
  }

  async logout(): Promise<void> {
    this.clearToken()
  }

  async getProfile(username: string): Promise<ProfileResponse> {
    try {
      const response = await this.axios.get<ProfileResponse>(`/api/v0/profile/${username}`)
      return response.data
    } catch (error: any) {
      throw this.handleError(error, 'è·å–ç”¨æˆ·æ¡£æ¡ˆå¤±è´¥')
    }
  }

  async getCurrentProfile(): Promise<DetailedProfileResponse> {
    try {
      const response = await this.axios.get<DetailedProfileResponse>('/api/v0/profile')
      return response.data
    } catch (error: any) {
      throw this.handleError(error, 'è·å–ç”¨æˆ·è¯¦ç»†æ¡£æ¡ˆå¤±è´¥')
    }
  }

  async getUserAvatar(username: string): Promise<Blob> {
    try {
      const response = await this.axios.get(`/api/v0/profile/${username}/avatar`, {
        responseType: 'blob'
      })
      return response.data
    } catch (error: any) {
      throw this.handleError(error, 'è·å–ç”¨æˆ·å¤´åƒå¤±è´¥')
    }
  }

  async getCurrentUserAvatar(): Promise<Blob> {
    try {
      const response = await this.axios.get('/api/v0/profile/avatar', {
        responseType: 'blob'
      })
      return response.data
    } catch (error: any) {
      throw this.handleError(error, 'è·å–ç”¨æˆ·å¤´åƒå¤±è´¥')
    }
  }

  async updateAvatar(request: ProfileAvatarChangeRequest): Promise<ProfileAvatarChangeResponse> {
    try {
      const response = await this.axios.post<ProfileAvatarChangeResponse>('/api/v0/profile/avatar', request)
      return response.data
    } catch (error: any) {
      throw this.handleError(error, 'æ›´æ–°å¤´åƒå¤±è´¥')
    }
  }

  async detectInsulatorByBase64(imageBase64: string): Promise<DetectResponse> {
    try {
      const ROBOFLOW_URL = 'https://serverless.roboflow.com/insulator-defect-c1kcs/1'
      const ROBOFLOW_API_KEY = 'cW6r5HCK2OL5sVo7ymUO'
      
      const response = await axios.post(ROBOFLOW_URL, imageBase64, {
        params: {
          api_key: ROBOFLOW_API_KEY
        },
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        timeout: 30000
      })
      
      return this.convertRoboflowResponse(response.data)
    } catch (error: any) {
      throw this.handleError(error, 'ç»ç¼˜å­æ£€æµ‹å¤±è´¥')
    }
  }

  async detectInsulatorByImage(file: File): Promise<DetectResponse> {
    try {
      const base64 = await this.fileToBase64(file)
      const base64Data = base64.split(',')[1] || base64
      return await this.detectInsulatorByBase64(base64Data)
    } catch (error: any) {
      throw this.handleError(error, 'ç»ç¼˜å­æ£€æµ‹å¤±è´¥')
    }
  }

  private convertRoboflowResponse(roboflowData: any): DetectResponse {
    try {
      if (!roboflowData || !roboflowData.predictions) {
        return {
          isSuccess: false,
          messages: [{
            code: 'NO_DETECTIONS',
            description: 'æœªæ£€æµ‹åˆ°ç¼ºé™·'
          }]
        }
      }

      const predictions = roboflowData.predictions || []
      
      if (predictions.length === 0) {
        return {
          isSuccess: true,
          infos: [],
          messages: [{
            code: 'NO_DETECTIONS',
            description: 'æœªæ£€æµ‹åˆ°ç¼ºé™·'
          }]
        }
      }

      const infos: PlateInfo[] = predictions.map((pred: any, index: number) => {
        const className = (pred.class || '').toLowerCase()
        const isInsulator = className === 'insulator' || className === 'insulators' || className.includes('insulator')
        const isDefect = className === 'crack' || className === 'defect' || className.includes('crack') || className.includes('defect')
        
        let number = ''
        let color = 'blue'
        
        if (isInsulator) {
          number = `ç»ç¼˜å­-${index + 1}`
          color = 'blue'
        } else {
          number = `ç¼ºé™·-${index + 1}`
          color = 'red'
        }
        
        return {
          number,
          confidence: pred.confidence ? Math.round(pred.confidence * 100) : null,
          rect: {
            x: pred.x ? Math.round(pred.x - (pred.width || 0) / 2) : null,
            y: pred.y ? Math.round(pred.y - (pred.height || 0) / 2) : null,
            width: pred.width ? Math.round(pred.width) : null,
            height: pred.height ? Math.round(pred.height) : null
          },
          color,
          class: className
        }
      })

      return {
        isSuccess: true,
        infos: infos,
        messages: [{
          code: 'SUCCESS',
          description: `æˆåŠŸæ£€æµ‹åˆ° ${infos.length} ä¸ªç¼ºé™·`
        }]
      }
    } catch (error: any) {
      return {
        isSuccess: false,
        messages: [{
          code: 'CONVERSION_ERROR',
          description: 'å“åº”æ•°æ®æ ¼å¼è½¬æ¢å¤±è´¥'
        }]
      }
    }
  }

  async detectNestByBase64(imageBase64: string): Promise<DetectResponse> {
    try {
      const ROBOFLOW_URL = 'https://serverless.roboflow.com/birdnest-aqzoi-gelsg/1'
      const ROBOFLOW_API_KEY = 'cW6r5HCK2OL5sVo7ymUO'
      
      const response = await axios.post(ROBOFLOW_URL, imageBase64, {
        params: {
          api_key: ROBOFLOW_API_KEY
        },
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        timeout: 30000
      })
      
      return this.convertRoboflowResponse(response.data)
    } catch (error: any) {
      throw this.handleError(error, 'é¸Ÿå·¢æ£€æµ‹å¤±è´¥')
    }
  }

  async detectNestByImage(file: File): Promise<DetectResponse> {
    try {
      const base64 = await this.fileToBase64(file)
      const base64Data = base64.split(',')[1] || base64
      return await this.detectNestByBase64(base64Data)
    } catch (error: any) {
      throw this.handleError(error, 'é¸Ÿå·¢æ£€æµ‹å¤±è´¥')
    }
  }

  async inspectionDetectByFile(file: File): Promise<InspectionDetectResponse> {
    try {
      const formData = new FormData()
      formData.append('image', file)

      const response = await this.axios.post<ApiSuccessResponse<InspectionDetectResponse>>(
        '/api/inspection/detect',
        formData,
        {
          headers: {
            'Content-Type': 'multipart/form-data'
          }
        }
      )

      if (response.data.success) {
        return response.data.data
      }
      throw new Error('æ£€æµ‹å¤±è´¥')
    } catch (error: any) {
      throw this.handleError(error, 'å›¾ç‰‡æ£€æµ‹å¤±è´¥')
    }
  }

  async inspectionDetectByBase64(imageBase64: string): Promise<InspectionDetectResponse> {
    try {
      const base64Data = imageBase64.startsWith('data:image') 
        ? imageBase64 
        : `data:image/jpeg;base64,${imageBase64}`

      const response = await this.axios.post<ApiSuccessResponse<InspectionDetectResponse>>(
        '/api/inspection/detect',
        { imageBase64: base64Data },
        {
          headers: {
            'Content-Type': 'application/json'
          }
        }
      )

      if (response.data.success) {
        return response.data.data
      }
      throw new Error('æ£€æµ‹å¤±è´¥')
    } catch (error: any) {
      throw this.handleError(error, 'å›¾ç‰‡æ£€æµ‹å¤±è´¥')
    }
  }

  async getInspectionRecords(query?: InspectionRecordsQuery): Promise<InspectionRecordsResponse> {
    try {
      const response = await this.axios.get<ApiSuccessResponse<InspectionRecordsResponse>>(
        '/api/inspection/records',
        { params: query }
      )

      if (response.data.success) {
        return response.data.data
      }
      throw new Error('è·å–æ£€æµ‹è®°å½•å¤±è´¥')
    } catch (error: any) {
      throw this.handleError(error, 'è·å–æ£€æµ‹è®°å½•åˆ—è¡¨å¤±è´¥')
    }
  }

  async getInspectionRecord(id: string): Promise<InspectionRecord> {
    try {
      const response = await this.axios.get<ApiSuccessResponse<InspectionRecord>>(
        `/api/inspection/records/${id}`
      )

      if (response.data.success) {
        return response.data.data
      }
      throw new Error('è·å–æ£€æµ‹è®°å½•å¤±è´¥')
    } catch (error: any) {
      throw this.handleError(error, 'è·å–æ£€æµ‹è®°å½•å¤±è´¥')
    }
  }

  async updateInspectionRecordStatus(
    id: string,
    request: UpdateRecordStatusRequest
  ): Promise<InspectionRecord> {
    try {
      const response = await this.axios.patch<ApiSuccessResponse<InspectionRecord>>(
        `/api/inspection/records/${id}/status`,
        request
      )

      if (response.data.success) {
        return response.data.data
      }
      throw new Error('æ›´æ–°æ£€æµ‹è®°å½•çŠ¶æ€å¤±è´¥')
    } catch (error: any) {
      throw this.handleError(error, 'æ›´æ–°æ£€æµ‹è®°å½•çŠ¶æ€å¤±è´¥')
    }
  }

  async getStatistics(period: StatisticsPeriod = 'all'): Promise<StatisticsResponse> {
    try {
      const response = await this.axios.get<ApiSuccessResponse<StatisticsResponse>>(
        '/api/statistics',
        { params: { period } }
      )

      if (response.data.success) {
        return response.data.data
      }
      throw new Error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥')
    } catch (error: any) {
      throw this.handleError(error, 'è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥')
    }
  }

  async getConfidenceDistribution(
    period: StatisticsPeriod = 'all',
    bins: number = 10
  ): Promise<ConfidenceDistributionResponse> {
    try {
      const response = await this.axios.get<ApiSuccessResponse<ConfidenceDistributionResponse>>(
        '/api/statistics/distribution',
        { params: { period, bins } }
      )

      if (response.data.success) {
        return response.data.data
      }
      throw new Error('è·å–ç½®ä¿¡åº¦åˆ†å¸ƒå¤±è´¥')
    } catch (error: any) {
      throw this.handleError(error, 'è·å–ç½®ä¿¡åº¦åˆ†å¸ƒè¯¦æƒ…å¤±è´¥')
    }
  }

  async fileToBase64(file: File): Promise<string> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader()
      reader.onload = () => {
        const result = reader.result as string
        const base64 = result.split(',')[1]
        resolve(base64)
      }
      reader.onerror = reject
      reader.readAsDataURL(file)
    })
  }

  getUserAvatarUrl(username: string): string {
    return `${this.config.baseURL}/api/v0/profile/${username}/avatar`
  }

  getCurrentUserAvatarUrl(): string {
    return `${this.config.baseURL}/api/v0/profile/avatar`
  }

  private handleError(error: any, defaultMessage: string): Error {
    if (error.response?.data) {
      const data = error.response.data
      
      if (data.success === false && data.error) {
        return new Error(data.error)
      }
      
      if (data.messages && Array.isArray(data.messages) && data.messages.length > 0) {
        const messages = data.messages.map((msg: any) => msg.description || msg.code).join('; ')
        return new Error(messages)
      }

      if (data.message) {
        return new Error(data.message)
      }

      if (data.isSuccess === false) {
        return new Error(data.error || 'æ“ä½œå¤±è´¥')
      }
    }
    
    if (error.response?.status) {
      const status = error.response.status
      if (status === 401) {
        return new Error('æœªè®¤è¯ï¼Œè¯·å…ˆç™»å½•')
      }
      if (status === 403) {
        return new Error('æƒé™ä¸è¶³')
      }
      if (status === 404) {
        return new Error('èµ„æºä¸å­˜åœ¨')
      }
      if (status === 500) {
        return new Error('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯')
      }
    }
    
    if (error.code === 'NETWORK_ERROR' || error.code === 'ERR_NETWORK') {
      return new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')
    }
    
    if (error.code === 'ECONNABORTED') {
      return new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•')
    }
    
    if (error.message?.includes('CORS')) {
      return new Error('è·¨åŸŸè¯·æ±‚è¢«é˜»æ­¢ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®')
    }

    if (error.message) {
      return new Error(error.message)
    }

    return new Error(defaultMessage)
  }
}

export const apiClient = new ApiClient()

export const backendApi = {
  info: {
    get: () => apiClient.getApiInfo(),
  },

  auth: {
    login: (request: LoginRequest) => apiClient.login(request),
    register: (request: RegisterRequest) => apiClient.register(request),
    logout: () => apiClient.logout(),
    autoRegister: (request?: AutoRegisterRequest) => apiClient.autoRegister(request),
  },
  
  detect: {
    byBase64: (imageBase64: string) => apiClient.detectInsulatorByBase64(imageBase64),
    byImage: (file: File) => apiClient.detectInsulatorByImage(file),
  },
  
  nestDetection: {
    byBase64: (imageBase64: string) => apiClient.detectNestByBase64(imageBase64),
    byImage: (file: File) => apiClient.detectNestByImage(file),
  },
  
  inspection: {
    detectByFile: (file: File) => apiClient.inspectionDetectByFile(file),
    detectByBase64: (imageBase64: string) => apiClient.inspectionDetectByBase64(imageBase64),
    getRecords: (query?: InspectionRecordsQuery) => apiClient.getInspectionRecords(query),
    getRecord: (id: string) => apiClient.getInspectionRecord(id),
    updateRecordStatus: (id: string, status: UpdateRecordStatusRequest) => 
      apiClient.updateInspectionRecordStatus(id, status),
  },
  
  statistics: {
    get: (period?: StatisticsPeriod) => apiClient.getStatistics(period),
    getDistribution: (period?: StatisticsPeriod, bins?: number) => 
      apiClient.getConfidenceDistribution(period, bins),
  },
  
  profile: {
    get: (username: string) => apiClient.getProfile(username),
    getCurrent: () => apiClient.getCurrentProfile(),
    getAvatar: (username: string) => apiClient.getUserAvatar(username),
    getCurrentAvatar: () => apiClient.getCurrentUserAvatar(),
    updateAvatar: (request: ProfileAvatarChangeRequest) => apiClient.updateAvatar(request),
    getAvatarUrl: (username: string) => apiClient.getUserAvatarUrl(username),
    getCurrentAvatarUrl: () => apiClient.getCurrentUserAvatarUrl(),
  },
  
  utils: {
    fileToBase64: (file: File) => apiClient.fileToBase64(file),
  }
}

'å›½é™…åŒ–é…ç½®æ¨¡å—
export type Language = 'zh' | 'en'

export const i18nTexts = {
  zh: {
    dashboard: 'ä»ªè¡¨ç›˜',
    carRecognition: 'ç»ç¼˜å­æ£€æµ‹',
    nestDetection: 'é¸Ÿå·¢æ£€æµ‹',
    systemSettings: 'ç³»ç»Ÿè®¾ç½®',
    aboutUs: 'å…³äºæˆ‘ä»¬',
    userSettings: 'ç”¨æˆ·è®¾ç½®',
    generalSettings: 'é€šç”¨è®¾ç½®',
    logout: 'é€€å‡ºç™»å½•',
    welcomeBack: 'æ¬¢è¿å›æ¥',
    admin: 'ç®¡ç†å‘˜',
    online: 'åœ¨çº¿',
    todayRecognition: 'ä»Šæ—¥æ£€æµ‹',
    averageConfidence: 'å¹³å‡ç½®ä¿¡åº¦',
    onlineDevices: 'åœ¨çº¿è®¾å¤‡',
    inspectedLines: 'å·²å·¡æ£€çº¿è·¯',
    systemStatus: 'ç³»ç»ŸçŠ¶æ€',
    cpuUsage: 'CPUä½¿ç”¨ç‡',
    memoryUsage: 'å†…å­˜ä½¿ç”¨ç‡',
    diskUsage: 'ç£ç›˜ä½¿ç”¨ç‡',
    overview: 'æ¦‚è§ˆ',
    uploadImage: 'ä¸Šä¼ å›¾ç‰‡',
    clickOrDrag: 'ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸä¸Šä¼ ',
    supportedFormats: 'æ”¯æŒ jpgã€pngã€jpeg æ ¼å¼ï¼Œæ¨èæ–‡ä»¶å¤§å°å°äº 3MB',
    largeFileNotice: 'å¤§æ–‡ä»¶å°†è‡ªåŠ¨ä¼˜åŒ–å¤„ç†ä»¥ç¡®ä¿æœ€ä½³è¯†åˆ«æ•ˆæœ',
    fileName: 'æ–‡ä»¶å',
    fileSize: 'å¤§å°',
    fileType: 'ç±»å‹',
    startDetection: 'å¼€å§‹è¯†åˆ«',
    detecting: 'è¯†åˆ«ä¸­...',
    clear: 'æ¸…ç©º',
    readyToDetect: 'å›¾ç‰‡å·²å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹æ£€æµ‹"å³å¯æ£€æµ‹',
    nestDetectionTitle: 'é¸Ÿå·¢æ£€æµ‹',
    nestDetectionSubtitle: 'ä¸Šä¼ å›¾ç‰‡ï¼Œæ™ºèƒ½æ£€æµ‹é¸Ÿå·¢',
    nestDetectionReady: 'å›¾ç‰‡å·²å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹æ£€æµ‹"å³å¯æ£€æµ‹é¸Ÿå·¢',
    detectionResults: 'è¯†åˆ«ç»“æœ',
    noDetectionData: 'æš‚æ— æ£€æµ‹æ•°æ®',
    detectionFailed: 'è¯†åˆ«å¤±è´¥',
    detectionSuccess: 'æ£€æµ‹æˆåŠŸ',
    detectedItems: 'ä¸ªæ£€æµ‹é¡¹',
    nest: 'é¸Ÿå·¢',
    other: 'å…¶ä»–',
    confidence: 'ç½®ä¿¡åº¦',
    position: 'ä½ç½®',
    size: 'å°ºå¯¸',
    detectionTips: 'æ£€æµ‹å»ºè®®',
    detectionTipsList: [
      'ç¡®ä¿é¸Ÿå·¢æ¸…æ™°å¯è§ï¼Œæ²¡æœ‰åå…‰æˆ–æ¨¡ç³Š',
      'æ‹æ‘„æ—¶ä¿æŒé€‚å½“è·ç¦»ï¼Œé¸Ÿå·¢å å›¾ç‰‡åˆé€‚æ¯”ä¾‹',
      'é¿å…é¸Ÿå·¢è¢«é®æŒ¡ï¼ˆå¦‚æ ‘æã€æ ‘å¶ç­‰ï¼‰',
      'åœ¨å…‰çº¿å……è¶³çš„ç¯å¢ƒä¸‹æ‹æ‘„',
      'å°½é‡ä¿æŒå›¾ç‰‡æ°´å¹³ï¼Œé¿å…è¿‡åº¦å€¾æ–œ'
    ],
    insulatorDetectionTitle: 'ç»ç¼˜å­æ£€æµ‹',
    insulatorDetectionSubtitle: 'ä¸Šä¼ å›¾ç‰‡ï¼Œæ™ºèƒ½æ£€æµ‹ç»ç¼˜å­ç¼ºé™·',
    insulatorDetectionReady: 'å›¾ç‰‡å·²å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹æ£€æµ‹"å³å¯æ£€æµ‹ç»ç¼˜å­',
    insulator: 'ç»ç¼˜å­',
    defect: 'ç¼ºé™·',
    insulatorDetectionTips: [
      'ç¡®ä¿ç»ç¼˜å­æ¸…æ™°å¯è§ï¼Œæ²¡æœ‰åå…‰æˆ–æ¨¡ç³Š',
      'æ‹æ‘„æ—¶ä¿æŒé€‚å½“è·ç¦»ï¼Œç»ç¼˜å­å å›¾ç‰‡åˆé€‚æ¯”ä¾‹',
      'é¿å…ç»ç¼˜å­è¢«é®æŒ¡ï¼ˆå¦‚æ”¯æ¶ã€æ±¡æ¸ç­‰ï¼‰',
      'åœ¨å…‰çº¿å……è¶³çš„ç¯å¢ƒä¸‹æ‹æ‘„',
      'å°½é‡ä¿æŒå›¾ç‰‡æ°´å¹³ï¼Œé¿å…è¿‡åº¦å€¾æ–œ'
    ],
    request: 'Request',
    response: 'Response',
    noRequestData: 'æš‚æ— è¯·æ±‚æ•°æ®',
    noResponseData: 'æš‚æ— å“åº”æ•°æ®',
    aboutUsTitle: 'å…³äºæˆ‘ä»¬',
    aboutUsSubtitle: 'äº†è§£æˆ‘ä»¬çš„å›¢é˜Ÿå’Œäº§å“',
    companyName: 'å…¬å¸åç§°',
    companyDescription: 'å…¬å¸ç®€ä»‹',
    teamIntroduction: 'å›¢é˜Ÿä»‹ç»',
    contactUs: 'è”ç³»æˆ‘ä»¬',
    version: 'ç‰ˆæœ¬ä¿¡æ¯',
    copyright: 'ç‰ˆæƒæ‰€æœ‰'
  },
  en: {
    dashboard: 'Dashboard',
    carRecognition: 'Insulator Detection',
    nestDetection: 'Nest Detection',
    systemSettings: 'System Settings',
    aboutUs: 'About Us',
    userSettings: 'User Settings',
    generalSettings: 'General Settings',
    logout: 'Logout',
    welcomeBack: 'Welcome back',
    admin: 'Admin',
    online: 'Online',
    todayRecognition: "Today's Detection",
    averageConfidence: 'Average Confidence',
    onlineDevices: 'Online Devices',
    inspectedLines: 'Inspected Lines',
    systemStatus: 'System Status',
    cpuUsage: 'CPU Usage',
    memoryUsage: 'Memory Usage',
    diskUsage: 'Disk Usage',
    overview: 'Overview',
    uploadImage: 'Upload Image',
    clickOrDrag: 'Click or drag file to this area to upload',
    supportedFormats: 'Supports jpg, png, jpeg formats, recommended file size less than 3MB',
    largeFileNotice: 'Large files will be automatically optimized for best recognition results',
    fileName: 'File Name',
    fileSize: 'Size',
    fileType: 'Type',
    startDetection: 'Start Detection',
    detecting: 'Detecting...',
    clear: 'Clear',
    readyToDetect: 'Image is ready, click "Start Detection" to detect',
    nestDetectionTitle: 'Nest Detection',
    nestDetectionSubtitle: 'Upload image to intelligently detect nests',
    nestDetectionReady: 'Image is ready, click "Start Detection" to detect nests',
    detectionResults: 'Detection Results',
    noDetectionData: 'No detection data',
    detectionFailed: 'Detection Failed',
    detectionSuccess: 'Detection Successful',
    detectedItems: 'detected items',
    nest: 'Nest',
    other: 'Other',
    confidence: 'Confidence',
    position: 'Position',
    size: 'Size',
    detectionTips: 'Detection Tips',
    detectionTipsList: [
      'Ensure the nest is clearly visible without reflection or blur',
      'Maintain appropriate distance when shooting, nest should occupy appropriate proportion of the image',
      'Avoid nest being blocked (such as branches, leaves, etc.)',
      'Shoot in well-lit environment',
      'Keep the image level as much as possible, avoid excessive tilt'
    ],
    insulatorDetectionTitle: 'Insulator Detection',
    insulatorDetectionSubtitle: 'Upload image to intelligently detect insulators defects',
    insulatorDetectionReady: 'Image is ready, click "Start Detection" to detect insulators',
    insulator: 'Insulator',
    defect: 'Defect',
    insulatorDetectionTips: [
      'Ensure the insulator is clearly visible without reflection or blur',
      'Maintain appropriate distance when shooting, insulator should occupy appropriate proportion of the image',
      'Avoid insulator being blocked (such as brackets, stains, etc.)',
      'Shoot in well-lit environment',
      'Keep the image level as much as possible, avoid excessive tilt'
    ],
    request: 'Request',
    response: 'Response',
    noRequestData: 'No request data',
    noResponseData: 'No response data',
    aboutUsTitle: 'About Us',
    aboutUsSubtitle: 'Learn about our team and products',
    companyName: 'Company Name',
    companyDescription: 'Company Description',
    teamIntroduction: 'Team Introduction',
    contactUs: 'Contact Us',
    version: 'Version',
    copyright: 'Copyright'
  }
}

export function getCurrentLanguage(): Language {
  if (typeof window !== 'undefined') {
    const savedLang = localStorage.getItem('language')
    return (savedLang === 'en' ? 'en' : 'zh') as Language
  }
  return 'zh'
}

export function setLanguage(lang: Language): void {
  if (typeof window !== 'undefined') {
    localStorage.setItem('language', lang)
  }
}

export function getI18nText(lang?: Language) {
  const currentLang = lang || getCurrentLanguage()
  return i18nTexts[currentLang]
}

'å›¾ç‰‡å¤„ç†å·¥å…·
export interface CompressOptions {
  maxWidth?: number;
  maxHeight?: number;
  quality?: number;
  maxSizeKB?: number;
}

export async function compressImage(
  file: File,
  options: CompressOptions = {}
): Promise<File> {
  const {
    maxWidth = 1920,
    maxHeight = 1080,
    quality = 0.8,
    maxSizeKB = 500,
  } = options;

  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        let width = img.width;
        let height = img.height;

        if (width > maxWidth || height > maxHeight) {
          const ratio = Math.min(maxWidth / width, maxHeight / height);
          width = width * ratio;
          height = height * ratio;
        }

        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        if (!ctx) {
          reject(new Error('æ— æ³•åˆ›å»ºcanvasä¸Šä¸‹æ–‡'));
          return;
        }

        ctx.drawImage(img, 0, 0, width, height);

        canvas.toBlob(
          (blob) => {
            if (!blob) {
              reject(new Error('å›¾ç‰‡å‹ç¼©å¤±è´¥'));
              return;
            }

            const sizeKB = blob.size / 1024;
            if (sizeKB <= maxSizeKB) {
              const compressedFile = new File([blob], file.name, {
                type: file.type,
                lastModified: Date.now(),
              });
              resolve(compressedFile);
            } else {
              canvas.toBlob(
                (smallerBlob) => {
                  if (!smallerBlob) {
                    reject(new Error('å›¾ç‰‡å‹ç¼©å¤±è´¥'));
                    return;
                  }
                  const compressedFile = new File([smallerBlob], file.name, {
                    type: file.type,
                    lastModified: Date.now(),
                  });
                  resolve(compressedFile);
                },
                file.type,
                quality * 0.7
              );
            }
          },
          file.type,
          quality
        );
      };
      img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
      img.src = e.target?.result as string;
    };
    reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
    reader.readAsDataURL(file);
  });
}

export function fileToBase64(file: File): Promise<string> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const base64 = reader.result as string;
      resolve(base64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

export function getFileSizeKB(file: File): number {
  return file.size / 1024;
}

'æ£€æµ‹å·¥å…·å‡½æ•°
import type { PlateInfo } from '@/types/api'

export interface ImageSize {
  width: number
  height: number
  naturalWidth: number
  naturalHeight: number
}

export function calculateImageScale(
  displaySize: { width: number; height: number },
  naturalSize: { width: number; height: number }
): { scaleX: number; scaleY: number } {
  if (naturalSize.width > 0 && naturalSize.height > 0) {
    return {
      scaleX: displaySize.width / naturalSize.width,
      scaleY: displaySize.height / naturalSize.height,
    }
  }
  return { scaleX: 1, scaleY: 1 }
}

export function getInsulatorType(result: PlateInfo): {
  isInsulator: boolean
  isDefect: boolean
  typeLabel: string
  typeColor: string
} {
  const className = (result.class || '').toLowerCase()
  const isInsulator = className === 'insulator' || className === 'insulators' || className.includes('insulator')
  const isDefect = !isInsulator || result.color === 'red'
  
  return {
    isInsulator,
    isDefect,
    typeLabel: isInsulator ? 'insulator' : 'defect',
    typeColor: isDefect ? 'red' : 'blue',
  }
}

export function getNestType(result: PlateInfo): {
  isNest: boolean
  isOther: boolean
  typeLabel: string
  typeColor: string
} {
  const className = (result.class || '').toLowerCase()
  const isNest = className === 'nest' || className === 'birdnest' || className.includes('nest')
  const isOther = !isNest || result.color === 'red'
  
  return {
    isNest,
    isOther,
    typeLabel: isNest ? 'nest' : 'other',
    typeColor: isNest ? 'blue' : 'red',
  }
}

export function isValidDetectionResult(result: PlateInfo): boolean {
  return !!(
    result.rect &&
    result.rect.x !== null &&
    result.rect.y !== null &&
    result.rect.width !== null &&
    result.rect.height !== null
  )
}

'ç³»ç»ŸçŠ¶æ€ç›‘æ§APIï¼ˆæ¸…ç†åï¼‰
import { NextResponse } from 'next/server'
import { exec } from 'child_process'
import { promisify } from 'util'
import * as os from 'os'

const execAsync = promisify(exec)

async function getCpuUsage(): Promise<number> {
  try {
    if (process.platform === 'linux') {
      const { stdout } = await execAsync("top -bn1 | grep 'Cpu(s)' | awk '{print $2}' | cut -d'%' -f1")
      const cpuUsage = parseFloat(stdout.trim())
      return isNaN(cpuUsage) ? 0 : Math.min(100, Math.max(0, cpuUsage))
    }
    
    const cpus = os.cpus()
    let totalIdle = 0
    let totalTick = 0
    
    cpus.forEach(cpu => {
      for (const type in cpu.times) {
        totalTick += cpu.times[type as keyof typeof cpu.times]
      }
      totalIdle += cpu.times.idle
    })
    
    const idle = totalIdle / cpus.length
    const total = totalTick / cpus.length
    const usage = 100 - ~~(100 * idle / total)
    
    return Math.min(100, Math.max(0, usage))
  } catch (error) {
    return 0
  }
}

function getMemoryUsage(): number {
  try {
    const totalMem = os.totalmem()
    const freeMem = os.freemem()
    const usedMem = totalMem - freeMem
    const usage = (usedMem / totalMem) * 100
    
    return Math.min(100, Math.max(0, Math.round(usage)))
  } catch (error) {
    return 0
  }
}

async function getDiskUsage(): Promise<number> {
  try {
    if (process.platform === 'linux' || process.platform === 'darwin') {
      const { stdout } = await execAsync("df / | tail -1 | awk '{print $5}' | sed 's/%//'")
      const diskUsage = parseInt(stdout.trim())
      return isNaN(diskUsage) ? 0 : Math.min(100, Math.max(0, diskUsage))
    }
    
    if (process.platform === 'win32') {
      const { stdout } = await execAsync('wmic logicaldisk get size,freespace,caption')
      const lines = stdout.trim().split('\n').slice(1)
      let totalSize = 0
      let totalFree = 0
      
      lines.forEach(line => {
        const parts = line.trim().split(/\s+/)
        if (parts.length >= 3) {
          const free = parseInt(parts[1])
          const size = parseInt(parts[2])
          if (!isNaN(free) && !isNaN(size)) {
            totalFree += free
            totalSize += size
          }
        }
      })
      
      if (totalSize > 0) {
        const usage = ((totalSize - totalFree) / totalSize) * 100
        return Math.min(100, Math.max(0, Math.round(usage)))
      }
    }
    
    return 0
  } catch (error) {
    return 0
  }
}

export async function GET() {
  try {
    const [cpuUsage, memoryUsage, diskUsage] = await Promise.all([
      getCpuUsage(),
      getMemoryUsage(),
      getDiskUsage()
    ])

    return NextResponse.json({
      success: true,
      data: {
        cpu: cpuUsage,
        memory: memoryUsage,
        disk: diskUsage,
        timestamp: new Date().toISOString(),
        platform: process.platform,
        uptime: os.uptime()
      }
    })
  } catch (error) {
    return NextResponse.json({
      success: false,
      error: 'è·å–ç³»ç»ŸçŠ¶æ€å¤±è´¥',
      data: {
        cpu: 0,
        memory: 0,
        disk: 0,
        timestamp: new Date().toISOString(),
        platform: process.platform,
        uptime: os.uptime()
      }
    })
  }
}

'ä¸­é—´ä»¶
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  if (process.env.NODE_ENV === 'development') {
    const url = request.nextUrl.pathname
    
    if (
      url.startsWith('/_next/static/') ||
      url.startsWith('/_next/static/css/') ||
      url.startsWith('/_next/static/chunks/') ||
      url.startsWith('/_next/static/media/')
    ) {
      const response = NextResponse.next()
      
      response.headers.set('Cache-Control', 'no-store, must-revalidate')
      response.headers.set('Pragma', 'no-cache')
      response.headers.set('Expires', '0')
      
      return response
    }
  }
  
  return NextResponse.next()
}

export const config = {
  matcher: [
    '/_next/static/:path*',
    '/_next/static/css/:path*',
    '/_next/static/chunks/:path*',
    '/_next/static/media/:path*',
  ],
}

'åº”ç”¨æ ¹å¸ƒå±€
import './globals.css'
import type { Metadata } from 'next'
import { Inter } from 'next/font/google'
import { ThemeProvider } from '@/components/theme-provider'

const inter = Inter({ subsets: ['latin'], weight: ['400', '500', '600', '700'] })

export const metadata: Metadata = {
  title: 'å¾ªç¿¼ Aerotrace',
  description: 'å¾ªç¿¼ Aerotrace - ä¸“ä¸šçš„ç”µåŠ›å·¡æ£€è§£å†³æ–¹æ¡ˆ',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="zh-CN" suppressHydrationWarning>
      <body className={`${inter.className} antialiased`}>
        <ThemeProvider
          attribute="class"
          defaultTheme="light"
          enableSystem={false}
          disableTransitionOnChange
        >
          {children}
        </ThemeProvider>
      </body>
    </html>
  )
}

'å·¥å…·å‡½æ•°
import { type ClassValue, clsx } from "clsx"
import { twMerge } from "tailwind-merge"
import { format } from "date-fns"
import { zhCN } from "date-fns/locale"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

export function formatDate(input: Date | string | number): string {
  const date = input instanceof Date ? input : new Date(input)
  
  try {
    return format(date, 'yyyyå¹´MMæœˆddæ—¥ HH:mm', { locale: zhCN })
  } catch (error) {
    return 'æ— æ•ˆæ—¥æœŸ'
  }
}

export function formatPlateNumber(plate: string): string {
  return plate.toUpperCase()
}

'ç»Ÿè®¡å¡ç‰‡ç»„ä»¶
import React from 'react'
import { Card, Statistic } from 'antd'
import { theme } from 'antd'

interface StatisticCardProps {
  title: string
  value: number | string
  prefix?: React.ReactNode
  suffix?: string
  precision?: number
  valueStyle?: React.CSSProperties
  isDark?: boolean
}

export const StatisticCard: React.FC<StatisticCardProps> = React.memo(({
  title,
  value,
  prefix,
  suffix,
  precision,
  valueStyle,
  isDark = false
}) => {
  const {
    token: { borderRadiusLG },
  } = theme.useToken()

  return (
    <Card
      style={{
        height: '100%',
        background: isDark
          ? 'linear-gradient(135deg, rgba(38,38,38,0.9) 0%, rgba(58,58,58,0.7) 100%)'
          : 'linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.8) 100%)',
        border: isDark
          ? '1px solid rgba(255,255,255,0.1)' 
          : '1px solid rgba(24, 144, 255, 0.1)',
        backdropFilter: 'blur(12px)',
        borderRadius: borderRadiusLG,
        boxShadow: isDark
          ? '0 4px 16px rgba(0,0,0,0.3)' 
          : '0 4px 16px rgba(24, 144, 255, 0.08)'
      }}
      bodyStyle={{ 
        padding: '24px', 
        height: '100%', 
        display: 'flex', 
        alignItems: 'center' 
      }}
    >
      <Statistic
        title={title}
        value={value}
        prefix={prefix}
        suffix={suffix}
        precision={precision}
        valueStyle={valueStyle}
      />
    </Card>
  )
})

StatisticCard.displayName = 'StatisticCard'



'ç”¨æˆ·æ³¨å†ŒAPI
import { NextRequest, NextResponse } from 'next/server'
import { persistentUserStorage, simpleHash } from '@/lib/persistent-storage'

export async function POST(request: NextRequest) {
  try {
    const { username, email, password } = await request.json()
    
    if (!username || !email || !password) {
      return NextResponse.json(
        { 
          success: false,
          message: 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ' 
        },
        { status: 400 }
      )
    }
    
    if (username.length < 2 || username.length > 20) {
      return NextResponse.json(
        { 
          success: false,
          message: 'ç”¨æˆ·åé•¿åº¦åº”åœ¨2-20ä¸ªå­—ç¬¦ä¹‹é—´' 
        },
        { status: 400 }
      )
    }
    
    if (password.length < 6) {
      return NextResponse.json(
        { 
          success: false,
          message: 'å¯†ç é•¿åº¦è‡³å°‘6ä¸ªå­—ç¬¦' 
        },
        { status: 400 }
      )
    }
    
    const emailRegex = /^\S+@\S+\.\S+$/
    if (!emailRegex.test(email)) {
      return NextResponse.json(
        { 
          success: false,
          message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€' 
        },
        { status: 400 }
      )
    }
    
    const existingUserByUsername = persistentUserStorage.findByUsername(username)
    if (existingUserByUsername) {
      return NextResponse.json(
        { 
          success: false,
          message: 'ç”¨æˆ·åå·²è¢«ä½¿ç”¨' 
        },
        { status: 409 }
      )
    }
    
    const existingUserByEmail = persistentUserStorage.findByEmail(email)
    if (existingUserByEmail) {
      return NextResponse.json(
        { 
          success: false,
          message: 'é‚®ç®±å·²è¢«æ³¨å†Œ' 
        },
        { status: 409 }
      )
    }
    
    const newUser = persistentUserStorage.addUser({
      username,
      email,
      password: simpleHash(password),
      avatar: '/avatar.png'
    })
    
    const userResponse = {
      id: newUser.id,
      username: newUser.username,
      email: newUser.email,
      avatar: newUser.avatar,
      createdAt: newUser.createdAt
    }
    
    return NextResponse.json(
      { 
        success: true,
        message: 'æ³¨å†ŒæˆåŠŸ',
        user: userResponse,
        storage: 'file'
      },
      { status: 201 }
    )
    
  } catch (error: any) {
    return NextResponse.json(
      { 
        success: false,
        message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' 
      },
      { status: 500 }
    )
  }
}

'ä¸»é¢˜æ ·å¼é…ç½®æ¨¡å—
/**
 * Theme Styles Module
 * 
 * ä¸»é¢˜æ ·å¼é…ç½®æ¨¡å—ï¼Œç»Ÿä¸€ç®¡ç†åº”ç”¨çš„ä¸»é¢˜ç›¸å…³æ ·å¼å¸¸é‡
 * 
 * @module theme-styles
 * @description 
 * è¯¥æ¨¡å—æä¾›äº†ä»¥ä¸‹åŠŸèƒ½ï¼š
 * - ä¾§è¾¹æ ã€å¤´éƒ¨ã€å†…å®¹åŒºåŸŸçš„æ ·å¼å¸¸é‡å®šä¹‰
 * - æ ¹æ®ä¸»é¢˜æ¨¡å¼åŠ¨æ€ç”ŸæˆèƒŒæ™¯ã€è¾¹æ¡†ã€é˜´å½±ç­‰æ ·å¼
 * - ç»Ÿä¸€çš„æ ·å¼ç®¡ç†ï¼Œé¿å…ä»£ç é‡å¤
 * 
 * @author Aerotrace Development Team
 * @version 1.0.0
 */

/**
 * ä¾§è¾¹æ æ ·å¼é…ç½®å¸¸é‡
 * 
 * @constant {Object} siderStyles
 * @property {string} background - ä¾§è¾¹æ èƒŒæ™¯æ¸å˜æ ·å¼
 * @property {number} width - ä¾§è¾¹æ å±•å¼€æ—¶çš„å®½åº¦ï¼ˆåƒç´ ï¼‰
 * @property {number} collapsedWidth - ä¾§è¾¹æ æŠ˜å æ—¶çš„å®½åº¦ï¼ˆåƒç´ ï¼‰
 * 
 * @readonly
 */
export const siderStyles = {
  background: 'linear-gradient(180deg, #1890ff 0%, #096dd9 30%, #0050b3 70%, #003a8c 100%)',
  width: 208,
  collapsedWidth: 80,
} as const

/**
 * å¤´éƒ¨å¯¼èˆªæ æ ·å¼é…ç½®å¸¸é‡
 * 
 * @constant {Object} headerStyles
 * @property {number} height - å¤´éƒ¨å¯¼èˆªæ é«˜åº¦ï¼ˆåƒç´ ï¼‰
 * @property {string} padding - å¤´éƒ¨å¯¼èˆªæ å†…è¾¹è·
 * 
 * @readonly
 */
export const headerStyles = {
  height: 64,
  padding: '0 24px',
} as const

/**
 * å†…å®¹åŒºåŸŸæ ·å¼é…ç½®å¸¸é‡
 * 
 * @constant {Object} contentStyles
 * @property {string} padding - å†…å®¹åŒºåŸŸå†…è¾¹è·
 * @property {string} borderRadius - å†…å®¹åŒºåŸŸåœ†è§’åŠå¾„
 * 
 * @readonly
 */
export const contentStyles = {
  padding: '24px',
  borderRadius: '8px',
} as const

/**
 * è·å–å¤´éƒ¨å¯¼èˆªæ èƒŒæ™¯æ¸å˜æ ·å¼
 * 
 * @function getHeaderBackground
 * @description 
 * æ ¹æ®å½“å‰ä¸»é¢˜æ¨¡å¼ï¼ˆæ˜æš—ï¼‰è¿”å›å¯¹åº”çš„å¤´éƒ¨å¯¼èˆªæ èƒŒæ™¯æ¸å˜æ ·å¼
 * 
 * @param {boolean} isDark - æ˜¯å¦ä¸ºæš—è‰²ä¸»é¢˜æ¨¡å¼
 * @returns {string} CSS æ¸å˜èƒŒæ™¯æ ·å¼å­—ç¬¦ä¸²
 * 
 * @example
 * const bg = getHeaderBackground(true) // è¿”å›æš—è‰²ä¸»é¢˜èƒŒæ™¯
 */
export function getHeaderBackground(isDark: boolean): string {
  return isDark
    ? 'linear-gradient(90deg, rgba(26,26,26,0.95) 0%, rgba(42,42,42,0.9) 50%, rgba(26,26,26,0.95) 100%)'
    : 'linear-gradient(90deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.9) 50%, rgba(255,255,255,0.95) 100%)'
}

/**
 * è·å–å†…å®¹åŒºåŸŸèƒŒæ™¯æ¸å˜æ ·å¼
 * 
 * @function getContentBackground
 * @description 
 * æ ¹æ®å½“å‰ä¸»é¢˜æ¨¡å¼ï¼ˆæ˜æš—ï¼‰è¿”å›å¯¹åº”çš„å†…å®¹åŒºåŸŸèƒŒæ™¯æ¸å˜æ ·å¼
 * 
 * @param {boolean} isDark - æ˜¯å¦ä¸ºæš—è‰²ä¸»é¢˜æ¨¡å¼
 * @returns {string} CSS æ¸å˜èƒŒæ™¯æ ·å¼å­—ç¬¦ä¸²
 * 
 * @example
 * const bg = getContentBackground(false) // è¿”å›äº®è‰²ä¸»é¢˜èƒŒæ™¯
 */
export function getContentBackground(isDark: boolean): string {
  return isDark
    ? 'linear-gradient(135deg, rgba(26,26,26,0.95) 0%, rgba(42,42,42,0.8) 25%, rgba(58,58,58,0.6) 50%, rgba(42,42,42,0.8) 75%, rgba(26,26,26,0.95) 100%)'
    : 'linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.7) 25%, rgba(240,248,255,0.5) 50%, rgba(248,250,252,0.7) 75%, rgba(255,255,255,0.9) 100%)'
}

/**
 * è·å–å¡ç‰‡èƒŒæ™¯æ¸å˜æ ·å¼
 * 
 * @function getCardBackground
 * @description 
 * æ ¹æ®å½“å‰ä¸»é¢˜æ¨¡å¼ï¼ˆæ˜æš—ï¼‰è¿”å›å¯¹åº”çš„å¡ç‰‡èƒŒæ™¯æ¸å˜æ ·å¼
 * 
 * @param {boolean} isDark - æ˜¯å¦ä¸ºæš—è‰²ä¸»é¢˜æ¨¡å¼
 * @returns {string} CSS æ¸å˜èƒŒæ™¯æ ·å¼å­—ç¬¦ä¸²
 * 
 * @example
 * const bg = getCardBackground(true) // è¿”å›æš—è‰²ä¸»é¢˜å¡ç‰‡èƒŒæ™¯
 */
export function getCardBackground(isDark: boolean): string {
  return isDark
    ? 'linear-gradient(135deg, rgba(38,38,38,0.9) 0%, rgba(58,58,58,0.7) 50%, rgba(38,38,38,0.9) 100%)'
    : 'linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.8) 50%, rgba(255,255,255,0.95) 100%)'
}

/**
 * è·å–è¾¹æ¡†é¢œè‰²æ ·å¼
 * 
 * @function getBorderColor
 * @description 
 * æ ¹æ®å½“å‰ä¸»é¢˜æ¨¡å¼ï¼ˆæ˜æš—ï¼‰è¿”å›å¯¹åº”çš„è¾¹æ¡†é¢œè‰²æ ·å¼
 * 
 * @param {boolean} isDark - æ˜¯å¦ä¸ºæš—è‰²ä¸»é¢˜æ¨¡å¼
 * @returns {string} CSS é¢œè‰²å€¼å­—ç¬¦ä¸²ï¼ˆRGBAæ ¼å¼ï¼‰
 * 
 * @example
 * const borderColor = getBorderColor(false) // è¿”å›äº®è‰²ä¸»é¢˜è¾¹æ¡†é¢œè‰²
 */
export function getBorderColor(isDark: boolean): string {
  return isDark ? 'rgba(255,255,255,0.12)' : 'rgba(24, 144, 255, 0.12)'
}

/**
 * è·å–é˜´å½±æ ·å¼
 * 
 * @function getBoxShadow
 * @description 
 * æ ¹æ®å½“å‰ä¸»é¢˜æ¨¡å¼å’Œå…ƒç´ ç±»å‹è¿”å›å¯¹åº”çš„é˜´å½±æ ·å¼
 * æ”¯æŒä¸åŒç±»å‹çš„å…ƒç´ ï¼ˆå¤´éƒ¨ã€å†…å®¹åŒºåŸŸã€å¡ç‰‡ï¼‰ä½¿ç”¨ä¸åŒçš„é˜´å½±æ•ˆæœ
 * 
 * @param {boolean} isDark - æ˜¯å¦ä¸ºæš—è‰²ä¸»é¢˜æ¨¡å¼
 * @param {'header' | 'content' | 'card'} [type='content'] - å…ƒç´ ç±»å‹ï¼Œé»˜è®¤ä¸º 'content'
 * @returns {string} CSS é˜´å½±æ ·å¼å­—ç¬¦ä¸²
 * 
 * @example
 * const shadow = getBoxShadow(true, 'card') // è¿”å›æš—è‰²ä¸»é¢˜å¡ç‰‡é˜´å½±
 * const shadow2 = getBoxShadow(false) // è¿”å›äº®è‰²ä¸»é¢˜å†…å®¹åŒºåŸŸé˜´å½±
 */
export function getBoxShadow(isDark: boolean, type: 'header' | 'content' | 'card' = 'content'): string {
  if (isDark) {
    switch (type) {
      case 'header':
        return '0 2px 8px rgba(0,0,0,0.4)'
      case 'card':
        return '0 4px 16px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1)'
      default:
        return '0 8px 32px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.1)'
    }
  } else {
    switch (type) {
      case 'header':
        return '0 2px 8px rgba(24, 144, 255, 0.08)'
      case 'card':
        return '0 4px 16px rgba(24, 144, 255, 0.1), inset 0 1px 0 rgba(255,255,255,0.9)'
      default:
        return '0 8px 32px rgba(24, 144, 255, 0.12), inset 0 1px 0 rgba(255,255,255,0.9)'
    }
  }
}

'å¤´åƒä¸Šä¼ ç»„ä»¶
"use client"

import React, { useState } from 'react'
import { Avatar, Upload, message, Modal } from 'antd'
import { UserOutlined, CameraOutlined } from '@ant-design/icons'
import { useAuthStore } from '@/lib/store'

interface AvatarUploadProps {
  size?: number
  showUpload?: boolean
  style?: React.CSSProperties
}

export function AvatarUpload({ 
  size = 32, 
  showUpload = false, 
  style = {} 
}: AvatarUploadProps) {
  const { user, updateAvatar } = useAuthStore()
  const [uploading, setUploading] = useState(false)
  const [modalVisible, setModalVisible] = useState(false)
  const [previewImage, setPreviewImage] = useState<string>('')

  // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
  const handleUpload = (file: File) => {
    // éªŒè¯æ–‡ä»¶ç±»å‹
    const isImage = file.type.startsWith('image/')
    if (!isImage) {
      message.error('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶!')
      return false
    }

    // éªŒè¯æ–‡ä»¶å¤§å° (2MB)
    const isLt2M = file.size / 1024 / 1024 < 2
    if (!isLt2M) {
      message.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 2MB!')
      return false
    }

    setUploading(true)

    // è¯»å–æ–‡ä»¶å¹¶è½¬æ¢ä¸ºBase64
    const reader = new FileReader()
    reader.onload = (e) => {
      const result = e.target?.result as string
      if (result) {
        setPreviewImage(result)
        setModalVisible(true)
        setUploading(false)
      }
    }
    reader.onerror = () => {
      message.error('æ–‡ä»¶è¯»å–å¤±è´¥!')
      setUploading(false)
    }
    reader.readAsDataURL(file)

    return false // é˜»æ­¢é»˜è®¤ä¸Šä¼ è¡Œä¸º
  }

  // ç¡®è®¤æ›´æ–°å¤´åƒ
  const handleConfirmUpdate = () => {
    if (previewImage) {
      updateAvatar(previewImage)
      message.success('å¤´åƒæ›´æ–°æˆåŠŸ!')
      setModalVisible(false)
      setPreviewImage('')
    }
  }

  // å–æ¶ˆæ›´æ–°
  const handleCancelUpdate = () => {
    setModalVisible(false)
    setPreviewImage('')
  }

  if (showUpload) {
    return (
      <>
        <div
          style={{ 
            width: size, 
            height: size,
            borderRadius: '50%',
            overflow: 'hidden',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            position: 'relative',
            cursor: 'pointer',
            ...style
          }}
          onClick={() => {
            const input = document.createElement('input')
            input.type = 'file'
            input.accept = 'image/*'
            input.style.display = 'none'
            input.onchange = (e) => {
              const target = e.target as HTMLInputElement
              const files = target.files
              if (files && files.length > 0) {
                handleUpload(files[0])
              }
              document.body.removeChild(input)
            }
            document.body.appendChild(input)
            input.click()
          }}
        >
          <Avatar 
            size={size}
            src={user?.avatar}
            style={{ backgroundColor: '#1890ff' }}
          >
            {user?.username?.charAt(0).toUpperCase() || 'U'}
          </Avatar>
          <div style={{
            position: 'absolute',
            bottom: 0,
            right: 0,
            width: size * 0.3,
            height: size * 0.3,
            background: '#1890ff',
            borderRadius: '50%',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            border: '2px solid white'
          }}>
            <CameraOutlined style={{ 
              color: 'white', 
              fontSize: size * 0.15 
            }} />
          </div>
        </div>

        <Modal
          title="æ›´æ–°å¤´åƒ"
          open={modalVisible}
          onOk={handleConfirmUpdate}
          onCancel={handleCancelUpdate}
          okText="ç¡®å®š"
          cancelText="å–æ¶ˆ"
          centered
        >
          <div style={{ 
            display: 'flex', 
            justifyContent: 'center',
            padding: '20px 0'
          }}>
            <Avatar 
              size={120}
              src={previewImage}
              style={{ backgroundColor: '#1890ff' }}
            >
              {user?.username?.charAt(0).toUpperCase() || 'U'}
            </Avatar>
          </div>
          <p style={{ textAlign: 'center', color: '#666' }}>
            ç¡®å®šè¦ä½¿ç”¨è¿™å¼ å›¾ç‰‡ä½œä¸ºå¤´åƒå—ï¼Ÿ
          </p>
        </Modal>
      </>
    )
  }

  // åªæ˜¾ç¤ºå¤´åƒï¼Œä¸æ”¯æŒä¸Šä¼ 
  return (
    <Avatar 
      size={size}
      src={user?.avatar}
      style={{ backgroundColor: '#1890ff', ...style }}
    >
      {user?.username?.charAt(0).toUpperCase() || 'U'}
    </Avatar>
  )
} 
'APIç±»å‹å®šä¹‰
// API åŸºç¡€ç±»å‹å®šä¹‰
export interface Message {
  code: string
  description: string
}

// åŸºç¡€å“åº”æ¥å£
export interface BaseResponse {
  isSuccess: boolean
  messages?: Message[]
}

// ============ è®¤è¯ç›¸å…³ç±»å‹ ============

// æ³¨å†Œè¯·æ±‚
export interface RegisterRequest {
  email: string
  username: string
  password: string
}

// æ³¨å†Œå“åº”
export interface RegisterResponse extends BaseResponse {
  url?: string
}

// ç™»å½•è¯·æ±‚
export interface LoginRequest {
  email: string
  password: string
}

// ç™»å½•å“åº”
export interface LoginResponse extends BaseResponse {
  id?: string
  token?: string
  expires?: string
}

// ============ ç”¨æˆ·æ¡£æ¡ˆç›¸å…³ç±»å‹ ============

// åŸºç¡€ç”¨æˆ·æ¡£æ¡ˆå“åº”
export interface ProfileResponse extends BaseResponse {
  username?: string
  avatarBase64?: string
}

// è¯¦ç»†ç”¨æˆ·æ¡£æ¡ˆå“åº”
export interface DetailedProfileResponse extends BaseResponse {
  email?: string
  username?: string
  avatarBase64?: string
}

// å¤´åƒæ›´æ”¹è¯·æ±‚
export interface ProfileAvatarChangeRequest {
  avatarBase64?: string
}

// å¤´åƒæ›´æ”¹å“åº”
export interface ProfileAvatarChangeResponse extends BaseResponse {}

// ============ æœ¬åœ°åº”ç”¨ç±»å‹ï¼ˆç”¨äºçŠ¶æ€ç®¡ç†ï¼‰ ============

// ç”¨æˆ·ä¿¡æ¯ï¼ˆæœ¬åœ°ä½¿ç”¨ï¼‰
export interface User {
  id: string
  username: string
  email: string
  avatar?: string
  name?: string
}

// è®¤è¯å“åº”ï¼ˆæœ¬åœ°APIï¼‰
export interface AuthResponse {
  success: boolean
  message: string
  user?: User
  storage?: 'file'
}

// è½¦ç‰Œè®°å½•ç±»å‹
export interface PlateRecord {
  id: string
  plateNumber: string
  timestamp: string | Date
  imageUrl: string
}

// ============ API é…ç½®ç±»å‹ ============

export interface ApiConfig {
  baseUrl: string
  timeout: number
  debug: boolean
}

// HTTPæ–¹æ³•ç±»å‹  
export type HttpMethod = 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH'

// è¯·æ±‚é€‰é¡¹
export interface RequestOptions {
  method?: HttpMethod
  headers?: Record<string, string>
  body?: any
  timeout?: number
}

// å“åº”ç±»å‹
export interface ApiResponse<T = any> {
  data: T
  status: number
  statusText: string
  headers: Record<string, string>
}

// ============ APIä¿¡æ¯ç›¸å…³ç±»å‹ ============

// APIç‰ˆæœ¬å“åº”
export interface ApiVersionResponse {
  appName: string
  version: string
}

// ============ è½¦ç‰Œæ£€æµ‹ç›¸å…³ç±»å‹ ============

// è½¦ç‰Œæ£€æµ‹è¯·æ±‚ï¼ˆBase64ï¼‰
export interface DetectRequest {
  imageBase64: string
}

// çŸ©å½¢ä½ç½®ä¿¡æ¯
export interface Rect {
  x: number | null
  y: number | null
  width: number | null
  height: number | null
}

// è½¦ç‰Œä¿¡æ¯ï¼ˆæš‚æ—¶å¤ç”¨ï¼Œç”¨äºç»ç¼˜å­æ£€æµ‹ï¼‰
export interface PlateInfo {
  number: string
  confidence: number | null
  rect: Rect
  color: string
  class?: string // æ·»åŠ classå­—æ®µï¼š'insulator' | 'crack' | 'defect' ç­‰
}

// è½¦ç‰Œæ£€æµ‹å“åº”
export interface DetectResponse extends BaseResponse {
  infos?: PlateInfo[]
}

// ============ æ–°åç«¯ API ç±»å‹å®šä¹‰ ============

// ç»Ÿä¸€å“åº”æ ¼å¼ï¼ˆæ–°åç«¯ï¼‰
export interface ApiSuccessResponse<T = any> {
  success: true
  data: T
}

export interface ApiErrorResponse {
  success: false
  error: string
}

export type BackendApiResponse<T = any> = ApiSuccessResponse<T> | ApiErrorResponse

// ============ è®¤è¯ç›¸å…³ç±»å‹ï¼ˆæ–°åç«¯ï¼‰ ============

// ç”¨æˆ·ä¿¡æ¯ï¼ˆæ–°åç«¯APIæ ¼å¼ï¼‰
export interface BackendUser {
  id: string
  email: string
  name: string | null
  role: 'USER' | 'ADMIN' | 'INSPECTOR'
  isTemporary?: boolean
  createdAt?: string
}

// ç™»å½•å“åº”æ•°æ®ï¼ˆæ–°åç«¯APIæ ¼å¼ï¼‰
export interface LoginResponseData {
  user: BackendUser
  message: string
}

// æ³¨å†Œå“åº”æ•°æ®ï¼ˆæ–°åç«¯APIæ ¼å¼ï¼‰
export interface RegisterResponseData {
  user: BackendUser
  message: string
}

// è‡ªåŠ¨æ³¨å†Œä¸´æ—¶è´¦å·è¯·æ±‚
export interface AutoRegisterRequest {
  deviceId?: string
  userAgent?: string
}

// ä¸´æ—¶ç”¨æˆ·ä¿¡æ¯
export interface TemporaryUser {
  id: string
  email: string
  name: string | null
  role: string
  isTemporary: boolean
}

// è‡ªåŠ¨æ³¨å†Œå“åº”
export interface AutoRegisterResponse {
  user: TemporaryUser
  temporaryPassword: string
  message: string
}

// ============ æ£€æµ‹ç›¸å…³ç±»å‹ï¼ˆæ–°åç«¯ï¼‰ ============

// æ£€æµ‹è®°å½•çŠ¶æ€
export type InspectionStatus = 'PENDING' | 'CONFIRMED' | 'REJECTED'

// æ£€æµ‹è®°å½•
export interface InspectionRecord {
  id: string
  imageUrl: string
  confidence: number
  detectedAt: string
  status: InspectionStatus
  createdAt?: string
  updatedAt?: string
  suggestions?: string[]
  originalSize?: number
  compressedSize?: number
  imageFormat?: string
  detectionMethod?: string
}

// æ£€æµ‹å“åº”ï¼ˆæ–°åç«¯ï¼‰
export interface InspectionDetectResponse {
  id: string
  imageUrl: string
  confidence: number
  detectedAt: string
  status: InspectionStatus
  suggestions?: string[]
  originalSize?: number
  compressedSize?: number
  imageFormat?: string
  detectionMethod?: string
}

// æ£€æµ‹è®°å½•åˆ—è¡¨æŸ¥è¯¢å‚æ•°
export interface InspectionRecordsQuery {
  page?: number
  limit?: number
  status?: InspectionStatus
  startDate?: string
  endDate?: string
  minConfidence?: number
  maxConfidence?: number
}

// åˆ†é¡µä¿¡æ¯
export interface PaginationInfo {
  page: number
  limit: number
  total: number
  totalPages: number
}

// æ£€æµ‹è®°å½•åˆ—è¡¨å“åº”
export interface InspectionRecordsResponse {
  records: InspectionRecord[]
  pagination: PaginationInfo
}

// æ›´æ–°æ£€æµ‹è®°å½•çŠ¶æ€è¯·æ±‚
export interface UpdateRecordStatusRequest {
  status: 'CONFIRMED' | 'REJECTED'
}

// ============ ç»Ÿè®¡ç›¸å…³ç±»å‹ï¼ˆæ–°åç«¯ï¼‰ ============

// ç»Ÿè®¡æ—¶é—´èŒƒå›´
export type StatisticsPeriod = 'today' | 'week' | 'all'

// ç½®ä¿¡åº¦åˆ†å¸ƒ
export interface ConfidenceDistribution {
  low: number    // 0.0 - 0.4
  medium: number // 0.4 - 0.7
  high: number   // 0.7 - 1.0
}

// çŠ¶æ€ç»Ÿè®¡
export interface StatusCount {
  pending: number
  confirmed: number
  rejected: number
}

// ç»Ÿè®¡æ•°æ®å“åº”
export interface StatisticsResponse {
  totalCount: number
  averageConfidence: number
  confidenceDistribution: ConfidenceDistribution
  statusCount: StatusCount
}

// ç½®ä¿¡åº¦åˆ†å¸ƒåŒºé—´
export interface ConfidenceBin {
  range: [number, number]
  count: number
}

// ç½®ä¿¡åº¦åˆ†å¸ƒè¯¦æƒ…å“åº”
export interface ConfidenceDistributionResponse {
  bins: number
  distribution: ConfidenceBin[]
} 
'æ£€æµ‹å†å²é¡µé¢
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { useAuthStore } from '@/lib/store';
import { Clock, CheckCircle, XCircle } from 'lucide-react';

interface HistoryItem {
  id: string;
  timestamp: string;
  success: boolean;
  cracksCount: number;
  imageUrl?: string;
}

export default function HistoryPage() {
  const router = useRouter();
  const [history, setHistory] = useState<HistoryItem[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  const { isAuthenticated } = useAuthStore();
  
  useEffect(() => {
    if (!isAuthenticated) {
      router.push('/login');
      return;
    }

    const fetchHistory = async () => {
      try {
        const response = await fetch('/api/history');
        if (response.ok) {
          const data = await response.json();
          setHistory(data.records || []);
        }
      } catch (error) {
        setHistory([]);
      } finally {
        setIsLoading(false);
      }
    };

    fetchHistory();
  }, [router, isAuthenticated]);

  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleString('zh-CN');
  };

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="container mx-auto px-4 py-8">
        <div className="mb-8">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">æ£€æµ‹å†å²</h1>
          <p className="text-gray-600">æŸ¥çœ‹æ‚¨çš„æ‰€æœ‰æ£€æµ‹è®°å½•</p>
        </div>

        {isLoading ? (
          <div className="text-center py-12">
            <p className="text-gray-500">åŠ è½½ä¸­...</p>
          </div>
        ) : history.length === 0 ? (
          <div className="text-center py-12 bg-white rounded-lg shadow">
            <p className="text-gray-500">æš‚æ— æ£€æµ‹è®°å½•</p>
          </div>
        ) : (
          <div className="bg-white rounded-lg shadow-lg overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      æ—¶é—´
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      çŠ¶æ€
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      è£‚ç—•æ•°é‡
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      æ“ä½œ
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {history.map((item) => (
                    <tr key={item.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="flex items-center">
                          <Clock className="h-4 w-4 text-gray-400 mr-2" />
                          <span className="text-sm text-gray-900">
                            {formatDate(item.timestamp)}
                          </span>
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        {item.success ? (
                          <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <CheckCircle className="h-3 w-3 mr-1" />
                            æˆåŠŸ
                          </span>
                        ) : (
                          <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            <XCircle className="h-3 w-3 mr-1" />
                            å¤±è´¥
                          </span>
                        )}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {item.cracksCount}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button className="text-blue-600 hover:text-blue-900">
                          æŸ¥çœ‹è¯¦æƒ…
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

'è®¾ç½®é¡µé¢
"use client"

import React, { useState, useEffect, Suspense } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import { useAuthStore } from '@/lib/store'
import { 
  Layout, 
  Menu, 
  Button, 
  Space, 
  Typography, 
  Breadcrumb, 
  Card,
  Form,
  Input,
  Select,
  Radio,
  theme,
  ConfigProvider,
  message,
  Divider,
  Row,
  Col,
  Spin
} from 'antd'
import type { ConfigProviderProps } from 'antd'
import {
  MenuFoldOutlined,
  MenuUnfoldOutlined,
  HomeOutlined,
  SettingOutlined,
  QuestionCircleOutlined,
  DashboardOutlined,
  ThunderboltOutlined,
  SunOutlined,
  MoonOutlined,
  UserOutlined,
  SaveOutlined,
  GlobalOutlined,
  LoadingOutlined
} from '@ant-design/icons'
import { AvatarUpload } from '@/components/avatar-upload'
import enUS from 'antd/locale/en_US'
import zhCN from 'antd/locale/zh_CN'
import { getI18nText, getCurrentLanguage, setLanguage, type Language } from '@/lib/i18n'

const { Header, Sider, Content } = Layout
const { Title, Text } = Typography
const { Option } = Select

type Locale = ConfigProviderProps['locale']

// è®¾ç½®é¡µé¢ä¸“ç”¨çš„å›½é™…åŒ–æ–‡æœ¬ï¼ˆæ‰©å±•å…±äº«é…ç½®ï¼‰
const settingsI18nTexts = {
  zh: {
    // é¡µé¢æ ‡é¢˜å’Œæè¿°
    userSettingsDesc: 'ç®¡ç†æ‚¨çš„ä¸ªäººä¿¡æ¯å’Œå¤´åƒ',
    generalSettingsDesc: 'é…ç½®ç³»ç»Ÿå¤–è§‚å’Œè¯­è¨€åå¥½',
    
    // è¡¨å•æ ‡ç­¾
    personalInfo: 'ä¸ªäººä¿¡æ¯',
    avatarTip: 'ç‚¹å‡»å¤´åƒå¯ä»¥æ›´æ¢',
    username: 'ç”¨æˆ·å',
    displayName: 'æ˜¾ç¤ºåç§°',
    email: 'é‚®ç®±',
    passwordSettings: 'å¯†ç è®¾ç½®',
    currentPassword: 'å½“å‰å¯†ç ',
    newPassword: 'æ–°å¯†ç ',
    confirmPassword: 'ç¡®è®¤æ–°å¯†ç ',
    saveSettings: 'ä¿å­˜è®¾ç½®',
    
    // å ä½ç¬¦
    currentPasswordPlaceholder: 'å¦‚éœ€ä¿®æ”¹å¯†ç è¯·è¾“å…¥å½“å‰å¯†ç ',
    newPasswordPlaceholder: 'è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰',
    confirmPasswordPlaceholder: 'è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ',
    
    // å¤–è§‚è®¾ç½®
    appearanceSettings: 'å¤–è§‚è®¾ç½®',
    themeMode: 'ä¸»é¢˜æ¨¡å¼',
    lightMode: 'æµ…è‰²æ¨¡å¼',
    darkMode: 'æ·±è‰²æ¨¡å¼',
    languageSettings: 'è¯­è¨€è®¾ç½®',
    
    // éªŒè¯æ¶ˆæ¯
    usernameRequired: 'è¯·è¾“å…¥ç”¨æˆ·å',
    displayNameRequired: 'è¯·è¾“å…¥æ˜¾ç¤ºåç§°',
    emailRequired: 'è¯·è¾“å…¥é‚®ç®±',
    emailInvalid: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€',
    currentPasswordRequired: 'ä¿®æ”¹å¯†ç æ—¶è¯·è¾“å…¥å½“å‰å¯†ç ',
    newPasswordRequired: 'è¯·è¾“å…¥æ–°å¯†ç ',
    passwordTooShort: 'å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½',
    confirmPasswordRequired: 'è¯·ç¡®è®¤æ–°å¯†ç ',
    passwordMismatch: 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´',
    
    // æˆåŠŸæ¶ˆæ¯
    userInfoUpdated: 'ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ!',
    userInfoAndPasswordUpdated: 'ç”¨æˆ·ä¿¡æ¯å’Œå¯†ç æ›´æ–°æˆåŠŸ!',
    generalSettingsSaved: 'é€šç”¨è®¾ç½®å·²ä¿å­˜!',
    languageChanged: 'è¯­è¨€å·²åˆ‡æ¢ï¼'
  },
  en: {
    // é¡µé¢æ ‡é¢˜å’Œæè¿°
    userSettingsDesc: 'Manage your personal information and avatar',
    generalSettingsDesc: 'Configure system appearance and language preferences',
    
    // è¡¨å•æ ‡ç­¾
    personalInfo: 'Personal Information',
    avatarTip: 'Click avatar to change',
    username: 'Username',
    displayName: 'Display Name',
    email: 'Email',
    passwordSettings: 'Password Settings',
    currentPassword: 'Current Password',
    newPassword: 'New Password',
    confirmPassword: 'Confirm Password',
    saveSettings: 'Save Settings',
    
    // å ä½ç¬¦
    currentPasswordPlaceholder: 'Enter current password to change password',
    newPasswordPlaceholder: 'Enter new password (at least 6 characters)',
    confirmPasswordPlaceholder: 'Re-enter new password',
    
    // å¤–è§‚è®¾ç½®
    appearanceSettings: 'Appearance Settings',
    themeMode: 'Theme Mode',
    lightMode: 'Light Mode',
    darkMode: 'Dark Mode',
    languageSettings: 'Language Settings',
    
    // éªŒè¯æ¶ˆæ¯
    usernameRequired: 'Please enter username',
    displayNameRequired: 'Please enter display name',
    emailRequired: 'Please enter email',
    emailInvalid: 'Please enter a valid email address',
    currentPasswordRequired: 'Please enter current password when changing password',
    newPasswordRequired: 'Please enter new password',
    passwordTooShort: 'Password must be at least 6 characters',
    confirmPasswordRequired: 'Please confirm new password',
    passwordMismatch: 'The two passwords do not match',
    
    // æˆåŠŸæ¶ˆæ¯
    userInfoUpdated: 'User information updated successfully!',
    userInfoAndPasswordUpdated: 'User information and password updated successfully!',
    generalSettingsSaved: 'General settings saved!',
    languageChanged: 'Language switched!'
  }
}

// ä¸»é¢˜é…ç½® - ä¸dashboardä¿æŒä¸€è‡´
type ThemeData = {
  borderRadius: number;
  colorPrimary: string;
  colorBgLayout: string;
  colorBgContainer: string;
  algorithm: 'light' | 'dark';
}

const defaultLightTheme: ThemeData = {
  borderRadius: 6,
  colorPrimary: '#1890ff',
  colorBgLayout: '#f0f4f8',
  colorBgContainer: '#ffffff',
  algorithm: 'light',
}

const defaultDarkTheme: ThemeData = {
  borderRadius: 6,
  colorPrimary: '#177ddc',
  colorBgLayout: '#0a0a0a',
  colorBgContainer: '#1a1a1a',
  algorithm: 'dark',
}

// Loading ç»„ä»¶
function SettingsLoading() {
  return (
    <div style={{ 
      display: 'flex', 
      justifyContent: 'center', 
      alignItems: 'center', 
      height: '100vh',
      flexDirection: 'column'
    }}>
      <Spin 
        indicator={<LoadingOutlined style={{ fontSize: 24 }} spin />}
        tip="åŠ è½½è®¾ç½®é¡µé¢..."
      />
    </div>
  )
}

// åŸæœ‰çš„è®¾ç½®é¡µé¢å†…å®¹ç»„ä»¶
function SettingsPageContent() {
  const router = useRouter()
  const searchParams = useSearchParams()
  const { isAuthenticated, user, updateUser } = useAuthStore()
  const [collapsed, setCollapsed] = useState(false)
  const [currentTheme, setCurrentTheme] = useState<ThemeData>(defaultLightTheme)
  const [currentLang, setCurrentLang] = useState<Language>(getCurrentLanguage())
  const [locale, setLocale] = useState<Locale>(zhCN)
  const [userForm] = Form.useForm()
  const [systemForm] = Form.useForm()

  // ä»URLå‚æ•°è·å–å½“å‰è®¾ç½®ç±»å‹ï¼Œé»˜è®¤ä¸ºç”¨æˆ·è®¾ç½®
  const settingsType = searchParams.get('type') || 'user'

  const {
    token: { colorBgContainer, borderRadiusLG },
  } = theme.useToken()

  // è·å–å½“å‰è¯­è¨€çš„æ–‡æœ¬ï¼ˆåˆå¹¶å…±äº«é…ç½®å’Œè®¾ç½®é¡µé¢ä¸“ç”¨é…ç½®ï¼‰
  const sharedT = getI18nText(currentLang)
  const settingsT = settingsI18nTexts[currentLang]
  const t = { ...sharedT, ...settingsT }

  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  useEffect(() => {
    if (!isAuthenticated) {
      router.push('/login')
    }
  }, [isAuthenticated, router])

  // åŠ è½½è¯­è¨€åå¥½
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const lang = getCurrentLanguage()
      setCurrentLang(lang)
      setLocale(lang === 'zh' ? zhCN : enUS)
    }
  }, [])

  // åŠ è½½ä¸»é¢˜åå¥½
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const savedTheme = localStorage.getItem('themeMode')
      if (savedTheme === 'dark') {
        setCurrentTheme(defaultDarkTheme)
      } else {
        setCurrentTheme(defaultLightTheme)
      }
    }
  }, [])

  // åˆå§‹åŒ–è¡¨å•æ•°æ®
  useEffect(() => {
    if (user) {
      userForm.setFieldsValue({
        username: user.username,
        name: user.name,
        email: user.email
      })
    }
  }, [user, userForm])

  const isDark = currentTheme.algorithm === 'dark'

  const handleLanguageChange = (value: Language) => {
    setCurrentLang(value)
    setLocale(value === 'zh' ? zhCN : enUS)
    setLanguage(value) // ä½¿ç”¨å…±äº«å‡½æ•°ä¿å­˜è¯­è¨€è®¾ç½®
    message.success(settingsI18nTexts[value].languageChanged)
  }

  const handleNavigation = (path: string) => {
    if (path.startsWith('settings/')) {
      const type = path.split('/')[1]
      router.push(`/settings?type=${type}`)
    } else if (path === 'detect') {
      router.push('/insulator-detection')
    } else {
      router.push(`/${path}`)
    }
  }

  const handleQuickThemeSwitch = () => {
    const newTheme = currentTheme.algorithm === 'light' ? defaultDarkTheme : defaultLightTheme
    setCurrentTheme(newTheme)
    localStorage.setItem('themeMode', newTheme.algorithm)
  }

  // ä¸»ä¾§è¾¹æ èœå•é¡¹ - åŒ…å«è®¾ç½®å­èœå•
  const sideMenuItems = [
    {
      key: 'dashboard',
      icon: <DashboardOutlined />,
      label: t.dashboard,
      onClick: () => handleNavigation('dashboard')
    },
    {
      key: 'detect',
      icon: <ThunderboltOutlined />,
      label: t.carRecognition,
      onClick: () => handleNavigation('detect')
    },
    {
      key: 'nest-detection',
      icon: <HomeOutlined />,
      label: t.nestDetection,
      onClick: () => handleNavigation('nest-detection')
    },
    {
      key: 'settings',
      icon: <SettingOutlined />,
      label: t.systemSettings,
      children: [
        {
          key: 'settings/user',
          icon: <UserOutlined />,
          label: t.userSettings,
          onClick: () => handleNavigation('settings/user')
        },
        {
          key: 'settings/general',
          icon: <GlobalOutlined />,
          label: t.generalSettings,
          onClick: () => handleNavigation('settings/general')
        }
      ]
    },
    {
      key: 'aboutus',
      icon: <QuestionCircleOutlined />,
      label: t.aboutUs,
      onClick: () => handleNavigation('aboutus')
    }
  ]

  const handleUserFormSubmit = (values: any) => {
    // æ›´æ–°åŸºæœ¬ç”¨æˆ·ä¿¡æ¯
    updateUser({
      username: values.username,
      name: values.name,
      email: values.email
    })

    // å¦‚æœå¡«å†™äº†å¯†ç ç›¸å…³å­—æ®µï¼Œå¤„ç†å¯†ç ä¿®æ”¹
    if (values.currentPassword && values.newPassword && values.confirmPassword) {
      // è¿™é‡Œåº”è¯¥è°ƒç”¨APIæ¥ä¿®æ”¹å¯†ç 
        currentPassword: values.currentPassword,
        newPassword: values.newPassword
      })
      
      // å¯†ç ä¿®æ”¹æˆåŠŸåæ¸…ç©ºå¯†ç å­—æ®µ
      userForm.setFieldsValue({
        currentPassword: '',
        newPassword: '',
        confirmPassword: ''
      })
      
      message.success(t.userInfoAndPasswordUpdated)
    } else {
      message.success(t.userInfoUpdated)
    }
  }

  const handleSystemFormSubmit = (values: any) => {
    message.success(t.generalSettingsSaved)
  }

  // æ¸²æŸ“ç”¨æˆ·è®¾ç½®å†…å®¹
  const renderUserSettings = () => (
    <Card 
      title={t.personalInfo}
      style={{ 
        background: isDark
          ? 'linear-gradient(135deg, rgba(38,38,38,0.9) 0%, rgba(58,58,58,0.7) 50%, rgba(38,38,38,0.9) 100%)'
          : 'linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.8) 50%, rgba(255,255,255,0.95) 100%)',
        border: isDark
          ? '1px solid rgba(255,255,255,0.12)' 
          : '1px solid rgba(24, 144, 255, 0.12)',
        backdropFilter: 'blur(12px)',
        borderRadius: borderRadiusLG,
        boxShadow: isDark
          ? '0 4px 16px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1)' 
          : '0 4px 16px rgba(24, 144, 255, 0.1), inset 0 1px 0 rgba(255,255,255,0.9)'
      }}
    >
      <div style={{ marginBottom: '24px', textAlign: 'center', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
        <AvatarUpload size={80} showUpload={true} />
        <div style={{ marginTop: '12px' }}>
          <Text type="secondary">{t.avatarTip}</Text>
        </div>
          </div>

      <Divider />
      
      <Form
        form={userForm}
        layout="vertical"
        onFinish={handleUserFormSubmit}
        style={{ maxWidth: '500px', margin: '0 auto' }}
      >
        <Form.Item
          label={t.username}
          name="username"
          rules={[{ required: true, message: t.usernameRequired }]}
        >
          <Input prefix={<UserOutlined />} />
        </Form.Item>

        <Form.Item
          label={t.displayName}
          name="name"
          rules={[{ required: true, message: t.displayNameRequired }]}
        >
          <Input />
        </Form.Item>

        <Form.Item
          label={t.email}
          name="email"
          rules={[
            { required: true, message: t.emailRequired },
            { type: 'email', message: t.emailInvalid }
          ]}
        >
          <Input />
        </Form.Item>

        <Divider>{t.passwordSettings}</Divider>

        <Form.Item
          label={t.currentPassword}
          name="currentPassword"
          rules={[
            {
              validator: (_, value) => {
                if (userForm.getFieldValue('newPassword') && !value) {
                  return Promise.reject(new Error(t.currentPasswordRequired))
                }
                return Promise.resolve()
              }
            }
          ]}
        >
          <Input.Password placeholder={t.currentPasswordPlaceholder} />
        </Form.Item>

        <Form.Item
          label={t.newPassword}
          name="newPassword"
          rules={[
            {
              validator: (_, value) => {
                if (userForm.getFieldValue('currentPassword') && !value) {
                  return Promise.reject(new Error(t.newPasswordRequired))
                }
                if (value && value.length < 6) {
                  return Promise.reject(new Error(t.passwordTooShort))
                }
                return Promise.resolve()
              }
            }
          ]}
        >
          <Input.Password placeholder={t.newPasswordPlaceholder} />
        </Form.Item>

        <Form.Item
          label={t.confirmPassword}
          name="confirmPassword"
          dependencies={['newPassword']}
          rules={[
            {
              validator: (_, value) => {
                const newPassword = userForm.getFieldValue('newPassword')
                if (newPassword && !value) {
                  return Promise.reject(new Error(t.confirmPasswordRequired))
                }
                if (newPassword && value && newPassword !== value) {
                  return Promise.reject(new Error(t.passwordMismatch))
                }
                return Promise.resolve()
              }
            }
          ]}
        >
          <Input.Password placeholder={t.confirmPasswordPlaceholder} />
        </Form.Item>

        <Form.Item>
          <Button 
            type="primary" 
            htmlType="submit" 
            icon={<SaveOutlined />}
            style={{ width: '100%' }}
          >
            {t.saveSettings}
          </Button>
        </Form.Item>
      </Form>
    </Card>
  )

  // æ¸²æŸ“é€šç”¨è®¾ç½®å†…å®¹
  const renderGeneralSettings = () => (
    <Row gutter={[16, 16]}>
      <Col span={24}>
        <Card 
          title={t.appearanceSettings}
          style={{ 
            background: isDark
              ? 'linear-gradient(135deg, rgba(38,38,38,0.9) 0%, rgba(58,58,58,0.7) 50%, rgba(38,38,38,0.9) 100%)'
              : 'linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.8) 50%, rgba(255,255,255,0.95) 100%)',
            border: isDark
              ? '1px solid rgba(255,255,255,0.12)' 
              : '1px solid rgba(24, 144, 255, 0.12)',
            backdropFilter: 'blur(12px)',
            borderRadius: borderRadiusLG,
            boxShadow: isDark
              ? '0 4px 16px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1)' 
              : '0 4px 16px rgba(24, 144, 255, 0.1), inset 0 1px 0 rgba(255,255,255,0.9)'
          }}
        >
          <Form layout="vertical">
            <Form.Item label={t.themeMode}>
              <Radio.Group value={isDark ? 'dark' : 'light'} onChange={(e) => {
                const newTheme = e.target.value === 'dark' ? defaultDarkTheme : defaultLightTheme
                setCurrentTheme(newTheme)
                localStorage.setItem('themeMode', newTheme.algorithm)
              }}>
                <Radio value="light">{t.lightMode}</Radio>
                <Radio value="dark">{t.darkMode}</Radio>
              </Radio.Group>
            </Form.Item>
            
            <Form.Item label={t.languageSettings}>
              <Select 
                value={currentLang} 
                onChange={handleLanguageChange}
                style={{ width: '200px' }}
              >
                <Option value="zh">ä¸­æ–‡ (ç®€ä½“)</Option>
                <Option value="en">English</Option>
              </Select>
            </Form.Item>
          </Form>
        </Card>
      </Col>
    </Row>
  )

  // è·å–å½“å‰é€‰ä¸­çš„èœå•é”®
  const getSelectedKeys = () => {
    if (settingsType === 'general') {
      return ['settings/general']
    }
    return ['settings/user']
  }

  // è·å–å±•å¼€çš„èœå•é”®
  const getOpenKeys = () => {
    return ['settings']
  }

  if (!isAuthenticated) {
    return null
  }

  return (
    <>
      <style jsx>{`
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-item),
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-submenu-title) {
          background-color: transparent !important;
        }
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-item:hover),
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-submenu-title:hover) {
          background-color: rgba(255, 255, 255, 0.08) !important;
        }
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-item-selected) {
          background-color: rgba(255, 255, 255, 0.12) !important;
        }
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-submenu-selected > .ant-menu-submenu-title),
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-submenu-open > .ant-menu-submenu-title),
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-submenu-active > .ant-menu-submenu-title),
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-submenu-title:active),
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-submenu-title:focus) {
          background-color: transparent !important;
        }
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-sub) {
          background-color: transparent !important;
        }
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-sub .ant-menu-item) {
          background-color: transparent !important;
        }
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-sub .ant-menu-item:hover) {
          background-color: rgba(255, 255, 255, 0.08) !important;
        }
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-sub .ant-menu-item-selected),
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-sub .ant-menu-item-active) {
          background-color: rgba(255, 255, 255, 0.12) !important;
        }
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub) {
          background-color: transparent !important;
        }
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub .ant-menu-item) {
          background-color: transparent !important;
        }
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub .ant-menu-item:hover) {
          background-color: rgba(255, 255, 255, 0.08) !important;
        }
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub .ant-menu-item-selected),
        :global(.custom-settings-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub .ant-menu-item-active) {
          background-color: rgba(255, 255, 255, 0.12) !important;
        }
      `}</style>
      <ConfigProvider
        locale={locale}
        theme={{
          token: {
            colorPrimary: currentTheme.colorPrimary,
            borderRadius: currentTheme.borderRadius,
            colorBgLayout: currentTheme.colorBgLayout,
            colorBgContainer: currentTheme.colorBgContainer,
            colorBgElevated: isDark ? '#262626' : '#ffffff',
            colorBorder: isDark ? '#303030' : '#e1e8ed',
            colorBorderSecondary: isDark ? '#252525' : '#f0f0f0',
            colorText: isDark ? '#ffffff' : '#000000d9',
            colorTextSecondary: isDark ? '#bfbfbf' : '#00000073',
            colorTextTertiary: isDark ? '#8c8c8c' : '#00000045',
            colorFillAlter: isDark ? '#1f1f1f' : '#fafafa',
            colorFillContent: isDark ? '#262626' : '#f5f5f5',
            colorBgTextHover: isDark ? '#2a2a2a' : '#f5f5f5',
          },
          components: {
            Menu: {
              itemBg: 'transparent',
              subMenuItemBg: 'transparent',
              itemActiveBg: 'transparent',
              itemSelectedBg: isDark ? 'rgba(255, 255, 255, 0.12)' : 'rgba(255, 255, 255, 0.12)',
              itemHoverBg: isDark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(255, 255, 255, 0.08)',
            },
          },
          algorithm: isDark ? theme.darkAlgorithm : theme.defaultAlgorithm,
        }}
      >
        <Layout style={{ height: '100vh', overflow: 'hidden' }}>
          {/* ä¸»ä¾§è¾¹æ  - 208px (200+8Ã—1) */}
          <Sider 
            trigger={null} 
            collapsible 
            collapsed={collapsed}
            breakpoint="lg"
            collapsedWidth={collapsed ? 0 : 80}
            width={208}
            style={{
              background: 'linear-gradient(180deg, #1890ff 0%, #096dd9 30%, #0050b3 70%, #003a8c 100%)',
              height: '100vh',
              overflow: 'auto',
              position: 'fixed',
              left: 0,
              top: 0,
              bottom: 0,
              zIndex: 999
            }}
          >
            <div style={{ 
              height: 64, 
              margin: '16px', 
              display: 'flex', 
              alignItems: 'center',
              justifyContent: collapsed ? 'center' : 'flex-start',
              borderBottom: '1px solid rgba(255,255,255,0.1)',
              paddingBottom: 16
            }}>
              {settingsType === 'general' ? (
                <GlobalOutlined style={{ fontSize: '24px', color: '#fff' }} />
              ) : (
                <UserOutlined style={{ fontSize: '24px', color: '#fff' }} />
              )}
              {!collapsed && (
                <Title level={4} style={{ margin: '0 0 0 12px', color: '#fff', fontSize: '16px' }}>
                  {settingsType === 'general' ? t.generalSettings : t.userSettings}
                </Title>
              )}
            </div>
            <Menu
              theme="dark"
              mode="inline"
              selectedKeys={getSelectedKeys()}
              openKeys={getOpenKeys()}
              items={sideMenuItems}
              style={{ 
                borderRight: 0,
                background: 'transparent'
              }}
              className="custom-settings-menu"
            />
          </Sider>

          <Layout style={{ marginLeft: collapsed ? 0 : 208 }}>
            {/* é¡¶éƒ¨å¯¼èˆªæ  - 64px (48+8Ã—2) */}
            <Header style={{ 
              display: 'flex', 
              alignItems: 'center',
              padding: '0 24px',
              height: 64,
              background: isDark
                ? 'linear-gradient(90deg, rgba(26,26,26,0.95) 0%, rgba(42,42,42,0.9) 50%, rgba(26,26,26,0.95) 100%)'
                : 'linear-gradient(90deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.9) 50%, rgba(255,255,255,0.95) 100%)',
              justifyContent: 'space-between',
              boxShadow: isDark
                ? '0 2px 8px rgba(0,0,0,0.4)' 
                : '0 2px 8px rgba(24, 144, 255, 0.08)',
              borderBottom: isDark
                ? '1px solid rgba(255,255,255,0.1)' 
                : '1px solid rgba(24, 144, 255, 0.08)',
              backdropFilter: 'blur(12px)'
            }}>
              <Space>
                <Button
                  type="text"
                  icon={collapsed ? <MenuUnfoldOutlined /> : <MenuFoldOutlined />}
                  onClick={() => setCollapsed(!collapsed)}
                  size="large"
                  style={{
                    fontSize: '16px',
                    width: 40,
                    height: 40,
                    color: isDark ? '#ffffff' : '#1890ff'
                  }}
                />
                
                <Breadcrumb
                  items={[
                    {
                      href: '/dashboard',
                      title: <HomeOutlined />
                    },
                    {
                      title: t.systemSettings
                    },
                    {
                      title: settingsType === 'general' ? t.generalSettings : t.userSettings
                    }
                  ]}
                />
              </Space>

              <Button
                type="primary"
                shape="circle"
                size="large"
                icon={isDark ? <SunOutlined /> : <MoonOutlined />}
                onClick={handleQuickThemeSwitch}
                style={{
                  width: 40,
                  height: 40,
                  backgroundColor: isDark ? '#faad14' : currentTheme.colorPrimary,
                  borderColor: isDark ? '#faad14' : currentTheme.colorPrimary,
                  boxShadow: isDark
                    ? '0 4px 12px rgba(250, 173, 20, 0.4)' 
                    : `0 4px 12px ${currentTheme.colorPrimary}40`
                }}
              />
            </Header>

            {/* è®¾ç½®å†…å®¹åŒºåŸŸ */}
            <Content style={{ 
              margin: '24px',
              padding: '24px',
              background: isDark
                ? 'linear-gradient(135deg, rgba(26,26,26,0.95) 0%, rgba(42,42,42,0.8) 25%, rgba(58,58,58,0.6) 50%, rgba(42,42,42,0.8) 75%, rgba(26,26,26,0.95) 100%)'
                : 'linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.7) 25%, rgba(240,248,255,0.5) 50%, rgba(248,250,252,0.7) 75%, rgba(255,255,255,0.9) 100%)',
              borderRadius: borderRadiusLG,
              backdropFilter: 'blur(16px)',
              border: isDark
                ? '1px solid rgba(255,255,255,0.1)' 
                : '1px solid rgba(24, 144, 255, 0.12)',
              boxShadow: isDark
                ? '0 8px 32px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.1)' 
                : '0 8px 32px rgba(24, 144, 255, 0.12), inset 0 1px 0 rgba(255,255,255,0.9)',
              overflow: 'auto',
              height: 'calc(100vh - 112px)'
            }}>
              <div style={{ marginBottom: '24px' }}>
                <Title level={2} style={{ margin: 0, display: 'flex', alignItems: 'center' }}>
                  {settingsType === 'general' ? (
                    <>
                      <GlobalOutlined style={{ marginRight: '12px', color: currentTheme.colorPrimary }} />
                      {t.generalSettings}
                    </>
                  ) : (
                    <>
                      <UserOutlined style={{ marginRight: '12px', color: currentTheme.colorPrimary }} />
                      {t.userSettings}
                    </>
                  )}
                </Title>
                <Text type="secondary">
                  {settingsType === 'general' ? t.generalSettingsDesc : t.userSettingsDesc}
                </Text>
          </div>

              {settingsType === 'user' && renderUserSettings()}
              {settingsType === 'general' && renderGeneralSettings()}
            </Content>
          </Layout>
        </Layout>
      </ConfigProvider>
    </>
  )
}

// ä¸»å¯¼å‡ºç»„ä»¶ - ä½¿ç”¨ Suspense åŒ…è£…
export default function SettingsPage() {
  return (
    <Suspense fallback={<SettingsLoading />}>
      <SettingsPageContent />
    </Suspense>
  )
} 
'é¸Ÿå·¢æ£€æµ‹é¡µé¢
"use client"

import React, { useState, useRef, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { useAuthStore } from '@/lib/store'
import { backendApi } from '@/lib/api-client'
import type { DetectResponse, PlateInfo } from '@/types/api'
// æ³¨æ„ï¼šPlateInfoç±»å‹æš‚æ—¶ä¿ç•™ï¼Œåç»­å¯æ”¹ä¸ºCrackInfo
import { 
  Layout, 
  Menu, 
  Button, 
  Space, 
  Typography, 
  Breadcrumb, 
  Upload,
  Card,
  Tabs,
  Alert,
  List,
  Tag,
  Divider,
  theme,
  ConfigProvider,
  message,
  Row,
  Col
} from 'antd'
import {
  MenuFoldOutlined,
  MenuUnfoldOutlined,
  HomeOutlined,
  SettingOutlined,
  QuestionCircleOutlined,
  DashboardOutlined,
  ThunderboltOutlined,
  UploadOutlined,
  InboxOutlined,
  SunOutlined,
  MoonOutlined,
  FileImageOutlined,
  ApiOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  CloudUploadOutlined,
  UserOutlined,
  GlobalOutlined
} from '@ant-design/icons'
import { getI18nText, getCurrentLanguage, type Language } from '@/lib/i18n'

const { Header, Sider, Content } = Layout
const { Title, Text } = Typography
const { Dragger } = Upload
const { TabPane } = Tabs

// ä¸»é¢˜é…ç½® - ä¸dashboardä¿æŒä¸€è‡´
type ThemeData = {
  borderRadius: number;
  colorPrimary: string;
  colorBgLayout: string;
  colorBgContainer: string;
  algorithm: 'light' | 'dark';
}

const defaultLightTheme: ThemeData = {
  borderRadius: 6,
  colorPrimary: '#1890ff',
  colorBgLayout: '#f0f4f8',
  colorBgContainer: '#ffffff',
  algorithm: 'light',
}

const defaultDarkTheme: ThemeData = {
  borderRadius: 6,
  colorPrimary: '#177ddc',
  colorBgLayout: '#0a0a0a',
  colorBgContainer: '#1a1a1a',
  algorithm: 'dark',
}

export default function NestDetectionPage() {
  const router = useRouter()
  const { isAuthenticated, user, updateUser } = useAuthStore()
  const [collapsed, setCollapsed] = useState(false)
  const [currentTheme, setCurrentTheme] = useState<ThemeData>(defaultLightTheme)
  const [currentLang, setCurrentLang] = useState<Language>(getCurrentLanguage())
  
  const [selectedFile, setSelectedFile] = useState<File | null>(null)
  const [previewUrl, setPreviewUrl] = useState<string>('')
  const [isDetecting, setIsDetecting] = useState(false)
  const [detectionResults, setDetectionResults] = useState<PlateInfo[]>([]) // æš‚æ—¶ä½¿ç”¨PlateInfoç±»å‹ï¼Œåç»­å¯æ”¹ä¸ºCrackInfo
  const [error, setError] = useState('')
  const [requestData, setRequestData] = useState<any>(null)
  const [responseData, setResponseData] = useState<any>(null)
  const [activeTab, setActiveTab] = useState('1')
  const [imageSize, setImageSize] = useState<{ width: number; height: number; naturalWidth: number; naturalHeight: number } | null>(null)
  const resultImageRef = useRef<HTMLImageElement>(null)
  const visualizationImageRef = useRef<HTMLImageElement>(null)
  const previewImageRef = useRef<HTMLImageElement>(null)
  const [previewImageSize, setPreviewImageSize] = useState<{ width: number; height: number; naturalWidth: number; naturalHeight: number } | null>(null)

  const {
    token: { colorBgContainer, borderRadiusLG },
  } = theme.useToken()

  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  useEffect(() => {
    if (!isAuthenticated) {
      router.push('/login')
      return
    }

    // ä»localStorageæ¢å¤å¤´åƒ
    if (typeof window !== 'undefined' && user) {
      const savedAvatar = localStorage.getItem('userAvatar')
      if (savedAvatar && savedAvatar !== user.avatar) {
        updateUser({ avatar: savedAvatar })
      }
    }
  }, [isAuthenticated, router, user, updateUser])

  // åŠ è½½ä¸»é¢˜å’Œè¯­è¨€åå¥½
  useEffect(() => {
    if (typeof window !== 'undefined') {
      // ä»localStorageæ¢å¤ä¸»é¢˜è®¾ç½® - ä¸dashboardä¿æŒä¸€è‡´
      const savedTheme = localStorage.getItem('themeMode')
      const lang = getCurrentLanguage()
      
      setCurrentLang(lang)
      
      if (savedTheme === 'dark') {
        setCurrentTheme(defaultDarkTheme)
      } else {
        setCurrentTheme(defaultLightTheme)
      }
    }
  }, [])

  // ç»„ä»¶å¸è½½æ—¶æ¸…ç†å†…å­˜
  useEffect(() => {
    return () => {
      if (previewUrl) {
        URL.revokeObjectURL(previewUrl)
      }
    }
  }, [previewUrl])

  const isDark = currentTheme.algorithm === 'dark'
  const t = getI18nText(currentLang)

  const handleNavigation = (path: string) => {
    if (path.startsWith('settings/')) {
      const type = path.split('/')[1]
      router.push(`/settings?type=${type}`)
    } else if (path === 'detect') {
      router.push('/insulator-detection')
    } else {
      router.push(`/${path}`)
    }
  }

  // å¤„ç†èœå•é¡¹ç‚¹å‡»
  const handleMenuClick = ({ key }: { key: string }) => {
    if (key === 'dashboard') {
      router.push('/dashboard')
    } else if (key === 'detect') {
      router.push('/insulator-detection')
    } else if (key === 'nest-detection') {
      router.push('/nest-detection')
    } else if (key === 'aboutus') {
      router.push('/aboutus')
    } else if (key.startsWith('settings/')) {
      const type = key.split('/')[1]
      router.push(`/settings?type=${type}`)
    }
  }

  const handleQuickThemeSwitch = () => {
    const newTheme = currentTheme.algorithm === 'light' ? defaultDarkTheme : defaultLightTheme
    setCurrentTheme(newTheme)
    // ä¸dashboardä¿æŒä¸€è‡´çš„localStorageé”®å
    localStorage.setItem('themeMode', newTheme.algorithm)
  }

  // ä¾§è¾¹æ èœå•é¡¹
  const sideMenuItems = [
    {
      key: 'dashboard',
      icon: <DashboardOutlined />,
      label: t.dashboard,
    },
    {
      key: 'detect',
      icon: <ThunderboltOutlined />,
      label: t.carRecognition,
    },
    {
      key: 'nest-detection',
      icon: <HomeOutlined />,
      label: t.nestDetection,
    },
    {
      key: 'settings',
      icon: <SettingOutlined />,
      label: t.systemSettings,
      children: [
        {
          key: 'settings/user',
          icon: <UserOutlined />,
          label: t.userSettings,
        },
        {
          key: 'settings/general',
          icon: <GlobalOutlined />,
          label: t.generalSettings,
        }
      ]
    },
    {
      key: 'aboutus',
      icon: <QuestionCircleOutlined />,
      label: t.aboutUs,
    }
  ]

  // ç®€åŒ–å¹¶ä¼˜åŒ–æ–‡ä»¶ä¸Šä¼ å¤„ç†
  const handleFileSelect = (file: File) => {
    
    setSelectedFile(file)
    setError('')
    setDetectionResults([])
    setRequestData(null)
    setResponseData(null)
    setActiveTab('1')
    
    // ç”Ÿæˆé¢„è§ˆURL
    const url = URL.createObjectURL(file)
    setPreviewUrl(url)
    
    // æ ¹æ®æ–‡ä»¶å¤§å°ç»™å‡ºä¸åŒæç¤º
    if (file.size > 3 * 1024 * 1024) {
      message.warning(`æ–‡ä»¶è¾ƒå¤§ (${(file.size / 1024 / 1024).toFixed(1)}MB)ï¼Œè¯†åˆ«æ—¶å°†è‡ªåŠ¨ä¼˜åŒ–å¤„ç†ä»¥ç¡®ä¿æœ€ä½³è¯†åˆ«æ•ˆæœ`)
    } else {
      message.success(`å›¾ç‰‡ "${file.name}" ä¸Šä¼ æˆåŠŸï¼Œå¯ä»¥å¼€å§‹è¯†åˆ«äº†`)
    }
    
  }

  // å¤„ç†æ–‡ä»¶æ‹–æ‹½ä¸Šä¼ 
  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault()
    e.stopPropagation()
    
    const files = e.dataTransfer.files
    if (files.length > 0) {
      const file = files[0]
      
      // éªŒè¯æ–‡ä»¶ç±»å‹
      const isImage = file.type.startsWith('image/')
      if (!isImage) {
        message.error('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶!')
        return
      }
      
      // è®¾ç½®æœ€å¤§æ–‡ä»¶å¤§å°ä¸º50MBï¼ˆå‹ç¼©åä¼šå°äº2MBï¼‰
      const isLt50M = file.size / 1024 / 1024 < 50
      if (!isLt50M) {
        message.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 50MB!')
        return
      }
      
      handleFileSelect(file)
    }
  }

  // å¤„ç†æ–‡ä»¶æ‹–æ‹½æ‚¬åœ
  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault()
    e.stopPropagation()
  }

  // å¤„ç†ç‚¹å‡»ä¸Šä¼ 
  const handleClickUpload = () => {
    const input = document.createElement('input')
    input.type = 'file'
    input.accept = 'image/*,.jpg,.jpeg,.png'
    input.style.display = 'none'
    
    input.onchange = (e) => {
      const target = e.target as HTMLInputElement
      const files = target.files
      if (files && files.length > 0) {
        const file = files[0]
        
        // éªŒè¯æ–‡ä»¶ç±»å‹
        const isImage = file.type.startsWith('image/')
        if (!isImage) {
          message.error('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶!')
          return
        }
        
        // è®¾ç½®æœ€å¤§æ–‡ä»¶å¤§å°ä¸º50MBï¼ˆå‹ç¼©åä¼šå°äº2MBï¼‰
        const isLt50M = file.size / 1024 / 1024 < 50
        if (!isLt50M) {
          message.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 50MB!')
          return
        }
        
        handleFileSelect(file)
      }
      
      // æ¸…ç†inputå…ƒç´ 
      document.body.removeChild(input)
    }
    
    document.body.appendChild(input)
    input.click()
  }

  // é¸Ÿå·¢æ£€æµ‹
  const handleDetection = async () => {
    
    if (!selectedFile) {
      message.error('è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶')
      return
    }

    // éªŒè¯æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ
    if (!(selectedFile instanceof File)) {
      message.error('æ–‡ä»¶æ ¼å¼æ— æ•ˆï¼Œè¯·é‡æ–°é€‰æ‹©')
      setSelectedFile(null)
      setPreviewUrl('')
      return
    }

    setIsDetecting(true)
    setError('')
    setDetectionResults([])
    setActiveTab('1')

    try {
        name: selectedFile.name,
        size: selectedFile.size,
        type: selectedFile.type
      })
      
      // å°†æ–‡ä»¶è½¬æ¢ä¸ºBase64ï¼ˆRoboflow APIéœ€è¦ï¼‰
      const base64 = await backendApi.utils.fileToBase64(selectedFile)
      // ç§»é™¤data:image/xxx;base64,å‰ç¼€ï¼Œåªä¿ç•™base64æ•°æ®
      const base64Data = base64.split(',')[1] || base64
      
      // è®°å½•è¯·æ±‚æ•°æ®
      setRequestData({
        method: 'POST',
        url: 'https://serverless.roboflow.com/birdnest-aqzoi-gelsg/1',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        params: {
          api_key: 'cW6r5HCK2OL5sVo7ymUO'
        },
        body: {
          file: selectedFile.name,
          size: `${(selectedFile.size / 1024).toFixed(2)} KB`,
          type: selectedFile.type,
          base64Length: base64Data.length,
          timestamp: new Date().toISOString()
        }
      })
      
      // ä½¿ç”¨Roboflow APIè¿›è¡Œé¸Ÿå·¢æ£€æµ‹
      const response: DetectResponse = await backendApi.nestDetection.byImage(selectedFile)
      
      
      // è®°å½•å“åº”æ•°æ®
      setResponseData(response)

      if (response.isSuccess && response.infos) {
        setDetectionResults(response.infos)
      } else {
        const errorMessage = response.messages?.[0]?.description || 'é¸Ÿå·¢æ£€æµ‹å¤±è´¥'
        setError(errorMessage)
        message.error(errorMessage)
      }
    } catch (error: any) {
      
      let errorMsg = 'æ£€æµ‹è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯'
      
      // é’ˆå¯¹ä¸åŒç±»å‹çš„é”™è¯¯æä¾›ä¸åŒçš„å¤„ç†
      if (error.message?.includes('è®¤è¯å¤±è´¥') || error.message?.includes('401') || error.message?.includes('Unauthorized')) {
        errorMsg = 'è®¤è¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
        message.error(errorMsg)
      } else if (error.message?.includes('è¯†åˆ«å¤±è´¥')) {
        errorMsg = 'å›¾ç‰‡ä¸­æœªèƒ½è¯†åˆ«å‡ºé¸Ÿå·¢ï¼Œè¯·ç¡®ä¿ï¼š\n1. å›¾ç‰‡ä¸­åŒ…å«æ¸…æ™°å¯è§çš„é¸Ÿå·¢\n2. é¸Ÿå·¢æ²¡æœ‰è¢«é®æŒ¡\n3. å›¾ç‰‡å…‰çº¿å……è¶³ã€å¯¹æ¯”åº¦è‰¯å¥½'
        message.error(errorMsg)
      } else if (error.message?.includes('æ–‡ä»¶å¤ªå¤§') || error.message?.includes('400')) {
        errorMsg = 'å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·å°è¯•ä½¿ç”¨æ›´å°æˆ–è´¨é‡æ›´å¥½çš„å›¾ç‰‡æ–‡ä»¶'
        message.error(errorMsg)
      } else if (error.message?.includes('å‹ç¼©å¤±è´¥') || error.message?.includes('å›¾ç‰‡åŠ è½½å¤±è´¥')) {
        errorMsg = 'å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆæ”¯æŒJPGã€PNGæ ¼å¼ï¼‰'
        message.error(errorMsg)
      } else if (error.message?.includes('Network') || error.message?.includes('ç½‘ç»œ')) {
        errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•'
        message.error(errorMsg)
      } else if (error.message?.includes('timeout') || error.message?.includes('è¶…æ—¶')) {
        errorMsg = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•'
        message.error(errorMsg)
      } else {
        errorMsg = error.message || 'æ£€æµ‹è¿‡ç¨‹ä¸­å‡ºç°æœªçŸ¥é”™è¯¯'
        message.error(errorMsg)
      }
      
      setError(errorMsg)
      setResponseData({
        isSuccess: false,
        error: errorMsg,
        timestamp: new Date().toISOString(),
        messages: [{
          code: 'DETECTION_ERROR',
          description: errorMsg
        }]
      })
    } finally {
      setIsDetecting(false)
    }
  }

  // æ¸…ç©ºç»“æœ
  const handleClear = () => {
    // æ¸…ç†å†…å­˜ä¸­çš„URL
    if (previewUrl) {
      URL.revokeObjectURL(previewUrl)
    }
    
    setSelectedFile(null)
    setPreviewUrl('')
    setDetectionResults([])
    setError('')
    setRequestData(null)
    setResponseData(null)
    setActiveTab('1')
    setPreviewImageSize(null)
    
    message.info('å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®')
  }

  if (!isAuthenticated) {
    return null
  }

  return (
    <>
      <style jsx>{`
        :global(.custom-menu.ant-menu-dark .ant-menu-item),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-title) {
          background-color: transparent !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-item:hover),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-title:hover) {
          background-color: rgba(255, 255, 255, 0.08) !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-item-selected) {
          background-color: rgba(255, 255, 255, 0.12) !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-selected > .ant-menu-submenu-title),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-open > .ant-menu-submenu-title),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-active > .ant-menu-submenu-title),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-title:active),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-title:focus) {
          background-color: transparent !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-sub) {
          background-color: transparent !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-sub .ant-menu-item) {
          background-color: transparent !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-sub .ant-menu-item:hover) {
          background-color: rgba(255, 255, 255, 0.08) !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-sub .ant-menu-item-selected),
        :global(.custom-menu.ant-menu-dark .ant-menu-sub .ant-menu-item-active) {
          background-color: rgba(255, 255, 255, 0.12) !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub) {
          background-color: transparent !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub .ant-menu-item) {
          background-color: transparent !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub .ant-menu-item:hover) {
          background-color: rgba(255, 255, 255, 0.08) !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub .ant-menu-item-selected),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub .ant-menu-item-active) {
          background-color: rgba(255, 255, 255, 0.12) !important;
        }
      `}</style>
      <ConfigProvider
        theme={{
          token: {
            colorPrimary: currentTheme.colorPrimary,
            borderRadius: currentTheme.borderRadius,
            colorBgLayout: currentTheme.colorBgLayout,
            colorBgContainer: currentTheme.colorBgContainer,
            colorBgElevated: isDark ? '#262626' : '#ffffff',
            colorBorder: isDark ? '#303030' : '#e1e8ed',
            colorBorderSecondary: isDark ? '#252525' : '#f0f0f0',
            colorText: isDark ? '#ffffff' : '#000000d9',
            colorTextSecondary: isDark ? '#bfbfbf' : '#00000073',
            colorTextTertiary: isDark ? '#8c8c8c' : '#00000045',
            colorFillAlter: isDark ? '#1f1f1f' : '#fafafa',
            colorFillContent: isDark ? '#262626' : '#f5f5f5',
            colorBgTextHover: isDark ? '#2a2a2a' : '#f5f5f5',
          },
          components: {
            Menu: {
              itemBg: 'transparent',
              subMenuItemBg: 'transparent',
              itemActiveBg: 'transparent',
              itemSelectedBg: isDark ? 'rgba(255, 255, 255, 0.12)' : 'rgba(255, 255, 255, 0.12)',
              itemHoverBg: isDark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(255, 255, 255, 0.08)',
            },
          },
          algorithm: isDark ? theme.darkAlgorithm : theme.defaultAlgorithm,
        }}
      >
        <Layout style={{ height: '100vh', overflow: 'hidden' }}>
          {/* ä¾§è¾¹æ  - 208px (200+8Ã—1) */}
          <Sider 
            trigger={null} 
            collapsible 
            collapsed={collapsed}
            breakpoint="lg"
            collapsedWidth={collapsed ? 0 : 80}
            width={208}
            style={{
              background: 'linear-gradient(180deg, #1890ff 0%, #096dd9 30%, #0050b3 70%, #003a8c 100%)',
              height: '100vh',
              overflow: 'auto',
              position: 'fixed',
              left: 0,
              top: 0,
              bottom: 0,
              zIndex: 999
            }}
          >
            <div style={{ 
              height: 64, 
              margin: '16px', 
              display: 'flex', 
              alignItems: 'center',
              justifyContent: collapsed ? 'center' : 'flex-start',
              borderBottom: '1px solid rgba(255,255,255,0.1)',
              paddingBottom: 16
            }}>
              <HomeOutlined style={{ fontSize: '24px', color: '#fff' }} />
              {!collapsed && (
                <Title level={4} style={{ margin: '0 0 0 12px', color: '#fff', fontSize: '16px' }}>
                  {t.nestDetectionTitle}
                </Title>
              )}
            </div>
            <Menu
              theme="dark"
              mode="inline"
              defaultSelectedKeys={['nest-detection']}
              selectedKeys={['nest-detection']}
              items={sideMenuItems}
              onClick={handleMenuClick}
              style={{ 
                borderRight: 0,
                background: 'transparent'
              }}
              className="custom-menu"
            />
          </Sider>

          <Layout style={{ marginLeft: collapsed ? 0 : 208 }}>
            {/* é¡¶éƒ¨å¯¼èˆªæ  - 64px (48+8Ã—2) */}
            <Header style={{ 
              display: 'flex', 
              alignItems: 'center',
              padding: '0 24px',
              height: 64,
              background: isDark
                ? 'linear-gradient(90deg, rgba(26,26,26,0.95) 0%, rgba(42,42,42,0.9) 50%, rgba(26,26,26,0.95) 100%)'
                : 'linear-gradient(90deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.9) 50%, rgba(255,255,255,0.95) 100%)',
              justifyContent: 'space-between',
              boxShadow: isDark
                ? '0 2px 8px rgba(0,0,0,0.4)' 
                : '0 2px 8px rgba(24, 144, 255, 0.08)',
              borderBottom: isDark
                ? '1px solid rgba(255,255,255,0.1)' 
                : '1px solid rgba(24, 144, 255, 0.08)',
              backdropFilter: 'blur(12px)'
            }}>
              {/* å·¦ä¾§ï¼šæŠ˜å æŒ‰é’® + é¢åŒ…å±‘ */}
              <Space>
                <Button
                  type="text"
                  icon={collapsed ? <MenuUnfoldOutlined /> : <MenuFoldOutlined />}
                  onClick={() => setCollapsed(!collapsed)}
                  size="large"
                  style={{
                    fontSize: '16px',
                    width: 40,
                    height: 40,
                    color: isDark ? '#ffffff' : '#1890ff'
                  }}
                />
                
                <Breadcrumb
                  items={[
                    {
                      href: '/dashboard',
                      title: <HomeOutlined />
                    },
                    {
                      title: t.nestDetectionTitle
                    }
                  ]}
                />
              </Space>

              {/* å³ä¾§ï¼šå¿«é€Ÿä¸»é¢˜åˆ‡æ¢ */}
              <Button
                type="primary"
                shape="circle"
                size="large"
                icon={isDark ? <SunOutlined /> : <MoonOutlined />}
                onClick={handleQuickThemeSwitch}
                style={{
                  width: 40,
                  height: 40,
                  backgroundColor: isDark ? '#faad14' : currentTheme.colorPrimary,
                  borderColor: isDark ? '#faad14' : currentTheme.colorPrimary,
                  boxShadow: isDark
                    ? '0 4px 12px rgba(250, 173, 20, 0.4)' 
                    : `0 4px 12px ${currentTheme.colorPrimary}40`
                }}
              />
            </Header>

            {/* ä¸»è¦å†…å®¹åŒºåŸŸ */}
            <Content style={{ 
              margin: '24px',
              padding: '24px',
              background: isDark
                ? 'linear-gradient(135deg, rgba(26,26,26,0.95) 0%, rgba(42,42,42,0.8) 25%, rgba(58,58,58,0.6) 50%, rgba(42,42,42,0.8) 75%, rgba(26,26,26,0.95) 100%)'
                : 'linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.7) 25%, rgba(240,248,255,0.5) 50%, rgba(248,250,252,0.7) 75%, rgba(255,255,255,0.9) 100%)',
              borderRadius: borderRadiusLG,
              backdropFilter: 'blur(16px)',
              border: isDark
                ? '1px solid rgba(255,255,255,0.1)' 
                : '1px solid rgba(24, 144, 255, 0.12)',
              boxShadow: isDark
                ? '0 8px 32px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.1)' 
                : '0 8px 32px rgba(24, 144, 255, 0.12), inset 0 1px 0 rgba(255,255,255,0.9)',
              overflow: 'auto',
              height: 'calc(100vh - 112px)'
            }}>
              <div style={{ marginBottom: '24px' }}>
                <Title level={2} style={{ margin: 0, display: 'flex', alignItems: 'center' }}>
                  <HomeOutlined style={{ marginRight: '12px', color: currentTheme.colorPrimary }} />
                  {t.nestDetectionTitle}
                </Title>
                <Text type="secondary">{t.nestDetectionSubtitle}</Text>
              </div>

              {/* å·¦å³å¯¹ç§°å¸ƒå±€ */}
              <Row gutter={24} style={{ height: 'calc(100% - 80px)' }}>
                {/* å·¦ä¾§ï¼šä¸Šä¼ åŒºåŸŸ */}
                <Col xs={24} lg={12} style={{ height: '100%' }}>
                  <Card 
                    style={{ 
                      height: '100%', 
                      display: 'flex',
                      flexDirection: 'column',
                      background: isDark
                        ? 'linear-gradient(135deg, rgba(38,38,38,0.9) 0%, rgba(58,58,58,0.7) 50%, rgba(38,38,38,0.9) 100%)'
                        : 'linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.8) 50%, rgba(255,255,255,0.95) 100%)',
                      border: isDark
                        ? '1px solid rgba(255,255,255,0.12)' 
                        : '1px solid rgba(24, 144, 255, 0.12)',
                      backdropFilter: 'blur(12px)',
                      borderRadius: borderRadiusLG,
                      boxShadow: isDark
                        ? '0 4px 16px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1)' 
                        : '0 4px 16px rgba(24, 144, 255, 0.1), inset 0 1px 0 rgba(255,255,255,0.9)'
                    }}
                    bodyStyle={{ 
                      flex: 1,
                      display: 'flex',
                      flexDirection: 'column',
                      justifyContent: 'center',
                      padding: '24px'
                    }}
                  >
                    {!previewUrl ? (
                      <div 
                        style={{ 
                          width: '100%',
                          height: '100%',
                          minHeight: '400px',
                          background: isDark ? '#1a1a1a' : '#fafafa',
                          borderRadius: '8px',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          cursor: 'pointer',
                          transition: 'all 0.3s ease'
                        }}
                        onClick={handleClickUpload}
                        onDrop={handleDrop}
                        onDragOver={handleDragOver}
                        onDragEnter={handleDragOver}
                      >
                        <div style={{ textAlign: 'center', padding: '40px 20px' }}>
                          <CloudUploadOutlined style={{ 
                            fontSize: '64px', 
                            color: currentTheme.colorPrimary,
                            marginBottom: '16px',
                            display: 'block'
                          }} />
                          <p style={{ 
                            fontSize: '18px', 
                            margin: '16px 0',
                            fontWeight: 500,
                            color: isDark ? '#ffffff' : '#000000d9'
                          }}>
                            {t.clickOrDrag}
                          </p>
                          <p style={{
                            color: isDark ? '#8c8c8c' : '#666',
                            fontSize: '14px',
                            margin: 0
                          }}>
                            {t.supportedFormats}
                            <br />
                            <span style={{ fontSize: '12px', color: isDark ? '#666' : '#999' }}>
                              {t.largeFileNotice}
                            </span>
                          </p>
                        </div>
                      </div>
                    ) : (
                      <div style={{ 
                        width: '100%',
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        justifyContent: 'center',
                        height: '100%'
                      }}>
                        {/* æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º */}
                        {selectedFile && (
                          <div style={{
                            width: '100%',
                            padding: '12px',
                            background: isDark ? '#262626' : '#f0f8ff',
                            border: isDark ? '1px solid #303030' : '1px solid #d6e4ff',
                            borderRadius: '6px',
                            marginBottom: '16px',
                            fontSize: '13px'
                          }}>
                            <div style={{ marginBottom: '4px' }}>
                              <Text strong>{t.fileName}ï¼š</Text>
                              <Text>{selectedFile.name}</Text>
                            </div>
                            <div style={{ marginBottom: '4px' }}>
                              <Text strong>{t.fileSize}ï¼š</Text>
                              <Text>{(selectedFile.size / 1024).toFixed(2)} KB</Text>
                            </div>
                            <div>
                              <Text strong>{t.fileType}ï¼š</Text>
                              <Text>{selectedFile.type}</Text>
                            </div>
                          </div>
                        )}
                        
                        <div style={{
                          position: 'relative',
                          display: 'inline-block',
                          width: '100%',
                          marginBottom: '20px'
                        }}>
                          <img
                            ref={previewImageRef}
                            src={previewUrl}
                            alt="é¢„è§ˆ"
                            style={{
                              maxWidth: '100%',
                              maxHeight: '500px',
                              borderRadius: '8px',
                              objectFit: 'contain',
                              display: 'block'
                            }}
                            onLoad={(e) => {
                              // å›¾ç‰‡åŠ è½½å®Œæˆåï¼Œè·å–å®é™…å°ºå¯¸ç”¨äºç¼©æ”¾è®¡ç®—
                              const img = e.currentTarget
                              const displayWidth = img.clientWidth
                              const displayHeight = img.clientHeight
                              const naturalWidth = img.naturalWidth
                              const naturalHeight = img.naturalHeight
                              
                              setPreviewImageSize({
                                width: displayWidth,
                                height: displayHeight,
                                naturalWidth: naturalWidth,
                                naturalHeight: naturalHeight
                              })
                            }}
                          />
                          {/* åœ¨é¢„è§ˆå›¾ç‰‡ä¸Šç»˜åˆ¶æ£€æµ‹æ¡† */}
                          {previewImageSize && detectionResults.length > 0 && detectionResults.map((result, index) => {
                            if (!result.rect || result.rect.x === null || result.rect.y === null || 
                                result.rect.width === null || result.rect.height === null) {
                              return null
                            }
                            
                            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼šæ˜¾ç¤ºå°ºå¯¸ / åŸå§‹å°ºå¯¸
                            let scaleX = 1
                            let scaleY = 1
                            
                            if (previewImageSize.naturalWidth > 0 && previewImageSize.naturalHeight > 0) {
                              scaleX = previewImageSize.width / previewImageSize.naturalWidth
                              scaleY = previewImageSize.height / previewImageSize.naturalHeight
                            } else if (previewImageRef.current) {
                              const img = previewImageRef.current
                              if (img.naturalWidth > 0 && img.naturalHeight > 0) {
                                scaleX = img.clientWidth / img.naturalWidth
                                scaleY = img.clientHeight / img.naturalHeight
                              }
                            }
                            
                            // åº”ç”¨ç¼©æ”¾æ¯”ä¾‹
                            const x = result.rect.x * scaleX
                            const y = result.rect.y * scaleY
                            const width = result.rect.width * scaleX
                            const height = result.rect.height * scaleY
                            
                            // æ ¹æ®classå’Œcolorå­—æ®µåˆ¤æ–­ç±»å‹
                            const className = (result.class || '').toLowerCase()
                            const isNest = className === 'nest' || className === 'birdnest' || className.includes('nest')
                            // å¦‚æœä¸æ˜¯é¸Ÿå·¢ï¼Œåˆ™é»˜è®¤ä¸ºå…¶ä»–ç‰©ä½“
                            const isOther = !isNest || result.color === 'red'
                            
                            // å…¶ä»–ç‰©ä½“ç”¨çº¢è‰²ï¼Œé¸Ÿå·¢ç”¨è“è‰²
                            const boxColor = isNest ? '#1890ff' : '#ff4d4f'
                            const confidence = result.confidence || 0
                            
                            return (
                              <div
                                key={index}
                                style={{
                                  position: 'absolute',
                                  left: `${x}px`,
                                  top: `${y}px`,
                                  width: `${width}px`,
                                  height: `${height}px`,
                                  border: `1px solid ${boxColor}`,
                                  borderRadius: '2px',
                                  pointerEvents: 'none',
                                  backgroundColor: 'transparent'
                                }}
                              >
                                {/* ç½®ä¿¡åº¦æ ‡ç­¾ - åªæ˜¾ç¤ºç™¾åˆ†æ¯” */}
                                {confidence > 0 && (
                                  <div
                                    style={{
                                      position: 'absolute',
                                      top: '-20px',
                                      left: '0',
                                      background: boxColor,
                                      color: '#fff',
                                      padding: '2px 6px',
                                      borderRadius: '2px',
                                      fontSize: '11px',
                                      fontWeight: '500',
                                      whiteSpace: 'nowrap',
                                      lineHeight: '1.2',
                                      minWidth: '35px',
                                      textAlign: 'center'
                                    }}
                                  >
                                    {confidence}%
                                  </div>
                                )}
                              </div>
                            )
                          })}
                        </div>
                        <Space size="large">
                          <Button
                            type="primary"
                            size="large"
                            loading={isDetecting}
                            onClick={handleDetection}
                            icon={<ApiOutlined />}
                            disabled={!selectedFile}
                            style={{
                              minWidth: '120px',
                              height: '40px'
                            }}
                          >
                            {isDetecting ? t.detecting : t.startDetection}
                          </Button>
                          
                          <Button
                            size="large"
                            onClick={handleClear}
                            style={{
                              minWidth: '80px',
                              height: '40px'
                            }}
                          >
                            {t.clear}
                          </Button>
                        </Space>
                        
                        {/* çŠ¶æ€æç¤º */}
                        {selectedFile && !isDetecting && (
                          <div style={{
                            marginTop: '12px',
                            padding: '8px 12px',
                            background: isDark ? '#1f4838' : '#f6ffed',
                            border: isDark ? '1px solid #274916' : '1px solid #b7eb8f',
                            borderRadius: '4px',
                            fontSize: '12px',
                            color: isDark ? '#95de64' : '#389e0d'
                          }}>
                            âœ“ {t.nestDetectionReady}
                          </div>
                        )}
                      </div>
                    )}
                  </Card>
                </Col>

                {/* å³ä¾§ï¼šæ ‡ç­¾é¡µåŒºåŸŸ */}
                <Col xs={24} lg={12} style={{ height: '100%' }}>
                  <Card 
                    style={{ 
                      height: '100%',
                      display: 'flex',
                      flexDirection: 'column',
                      background: isDark
                        ? 'linear-gradient(135deg, rgba(38,38,38,0.9) 0%, rgba(58,58,58,0.7) 50%, rgba(38,38,38,0.9) 100%)'
                        : 'linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.8) 50%, rgba(255,255,255,0.95) 100%)',
                      border: isDark
                        ? '1px solid rgba(255,255,255,0.12)' 
                        : '1px solid rgba(24, 144, 255, 0.12)',
                      backdropFilter: 'blur(12px)',
                      borderRadius: borderRadiusLG,
                      boxShadow: isDark
                        ? '0 4px 16px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1)' 
                        : '0 4px 16px rgba(24, 144, 255, 0.1), inset 0 1px 0 rgba(255,255,255,0.9)'
                    }}
                    bodyStyle={{ 
                      flex: 1,
                      padding: 0
                    }}
                  >
                    <Tabs 
                      activeKey={activeTab} 
                      onChange={setActiveTab}
                      style={{ height: '100%' }}
                      tabBarStyle={{ 
                        padding: '0 24px',
                        margin: 0,
                        borderBottom: isDark ? '1px solid #303030' : '1px solid #f0f0f0'
                      }}
                      items={[
                        {
                          key: '1',
                          label: t.detectionResults,
                          children: (
                            <div style={{ 
                              padding: '24px',
                              height: 'calc(100% - 48px)',
                              overflow: 'auto'
                            }}>
                              {error && (
                                <Alert
                                  message={t.detectionFailed}
                                  description={
                                    <div>
                                      <div style={{ marginBottom: '8px' }}>{error}</div>
                                      {error.includes('è¯†åˆ«å¤±è´¥') && (
                                        <div style={{ 
                                          padding: '8px 12px', 
                                          background: isDark ? '#1f1f1f' : '#f6ffed',
                                          border: isDark ? '1px solid #303030' : '1px solid #b7eb8f',
                                          borderRadius: '4px',
                                          fontSize: '12px',
                                          marginTop: '8px'
                                        }}>
                                          <strong>ğŸ’¡ {t.detectionTips}ï¼š</strong>
                                          <ul style={{ margin: '4px 0', paddingLeft: '16px' }}>
                                            {t.detectionTipsList.map((tip, index) => (
                                              <li key={index}>{tip}</li>
                                            ))}
                                          </ul>
                                        </div>
                                      )}
                                    </div>
                                  }
                                  type="error"
                                  showIcon
                                  style={{ marginBottom: '16px' }}
                                />
                              )}
                              
                              {detectionResults.length > 0 && (
                                <div>
                                  <div style={{ 
                                    display: 'flex', 
                                    alignItems: 'center',
                                    marginBottom: '16px'
                                  }}>
                                    <CheckCircleOutlined style={{ 
                                      color: '#52c41a',
                                      fontSize: '18px',
                                      marginRight: '8px'
                                    }} />
                                    <Text strong style={{ fontSize: '16px' }}>
                                      {t.detectionResults} ({detectionResults.length} {t.detectedItems})
                                    </Text>
                                  </div>
                                  
                                  <List
                                    dataSource={detectionResults}
                                    renderItem={(result, index) => {
                                      // åˆ¤æ–­ç±»å‹
                                      const className = (result.class || '').toLowerCase()
                                      const isNest = className === 'nest' || className === 'birdnest' || className.includes('nest')
                                      // å¦‚æœä¸æ˜¯é¸Ÿå·¢ï¼Œåˆ™é»˜è®¤ä¸ºå…¶ä»–ç‰©ä½“
                                      const isOther = !isNest || result.color === 'red'
                                      
                                      const typeLabel = isNest ? t.nest : t.other
                                      const typeColor = isNest ? 'blue' : 'red'
                                      const itemTitle = isNest ? `${t.nest} #${index + 1}` : `${t.other} #${index + 1}`
                                      
                                      return (
                                        <List.Item 
                                          key={index}
                                          style={{
                                            border: isDark ? '1px solid #303030' : '1px solid #f0f0f0',
                                            borderRadius: '8px',
                                            marginBottom: '12px',
                                            padding: '16px',
                                            background: isDark ? '#262626' : '#fafafa'
                                          }}
                                        >
                                          <List.Item.Meta
                                            avatar={
                                              <FileImageOutlined style={{ 
                                                fontSize: '24px', 
                                                color: isNest ? '#1890ff' : '#ff4d4f'
                                              }} />
                                            }
                                            title={
                                              <Space>
                                                <Text strong style={{ fontSize: '18px' }}>
                                                  {itemTitle}
                                                </Text>
                                                <Tag color={typeColor}>{typeLabel}</Tag>
                                              </Space>
                                            }
                                            description={
                                              <div>
                                                <div style={{ marginBottom: '8px' }}>
                                                  <Text type="secondary">{t.confidence}: </Text>
                                                  <Text style={{ marginLeft: '4px', fontWeight: 500 }}>
                                                    {result.confidence ? `${result.confidence}%` : (currentLang === 'en' ? 'Unknown' : 'æœªçŸ¥')}
                                                  </Text>
                                                </div>
                                                {result.rect && (
                                                  <Text type="secondary" style={{ fontSize: '12px' }}>
                                                    {t.position}: ({result.rect.x}, {result.rect.y}) | 
                                                    {t.size}: {result.rect.width} Ã— {result.rect.height}
                                                  </Text>
                                                )}
                                              </div>
                                            }
                                          />
                                        </List.Item>
                                      )
                                    }}
                                  />
                                </div>
                              )}
                              
                              {!isDetecting && !error && detectionResults.length === 0 && (
                                <div style={{ 
                                  textAlign: 'center', 
                                  padding: '60px 20px', 
                                  color: '#999',
                                  height: '100%',
                                  display: 'flex',
                                  flexDirection: 'column',
                                  justifyContent: 'center',
                                  alignItems: 'center'
                                }}>
                                  <FileImageOutlined style={{ 
                                    fontSize: '48px', 
                                    marginBottom: '16px',
                                    color: '#ccc'
                                  }} />
                                  <p style={{ fontSize: '16px', margin: 0 }}>{t.noDetectionData}</p>
                                </div>
                              )}
                            </div>
                          )
                        },
                        {
                          key: '2',
                          label: t.request,
                          children: (
                            <div style={{ 
                              padding: '24px',
                              height: 'calc(100% - 48px)',
                              overflow: 'auto'
                            }}>
                              {requestData ? (
                                <pre style={{ 
                                  background: isDark ? '#1a1a1a' : '#f5f5f5',
                                  padding: '16px',
                                  borderRadius: '4px',
                                  overflow: 'auto',
                                  border: isDark ? '1px solid #303030' : '1px solid #e1e8ed',
                                  fontSize: '13px',
                                  lineHeight: '1.5'
                                }}>
                                  {JSON.stringify(requestData, null, 2)}
                                </pre>
                              ) : (
                                <div style={{ 
                                  textAlign: 'center', 
                                  padding: '60px 20px', 
                                  color: '#999',
                                  height: '100%',
                                  display: 'flex',
                                  flexDirection: 'column',
                                  justifyContent: 'center',
                                  alignItems: 'center'
                                }}>
                                  <ApiOutlined style={{ 
                                    fontSize: '48px', 
                                    marginBottom: '16px',
                                    color: '#ccc'
                                  }} />
                                  <p style={{ fontSize: '16px', margin: 0 }}>{t.noRequestData}</p>
                                </div>
                              )}
                            </div>
                          )
                        },
                        {
                          key: '3',
                          label: t.response,
                          children: (
                            <div style={{ 
                              padding: '24px',
                              height: 'calc(100% - 48px)',
                              overflow: 'auto',
                              display: 'flex',
                              flexDirection: 'column'
                            }}>
                              {responseData ? (
                                <>
                                  <pre style={{ 
                                    background: isDark ? '#1a1a1a' : '#f5f5f5',
                                    padding: '16px',
                                    borderRadius: '4px',
                                    overflow: 'auto',
                                    border: isDark ? '1px solid #303030' : '1px solid #e1e8ed',
                                    fontSize: '13px',
                                    lineHeight: '1.5',
                                    marginBottom: '24px',
                                    maxHeight: '300px'
                                  }}>
                                    {JSON.stringify(responseData, null, 2)}
                                  </pre>
                                  
                                </>
                              ) : (
                                <div style={{ 
                                  textAlign: 'center', 
                                  padding: '60px 20px', 
                                  color: '#999',
                                  height: '100%',
                                  display: 'flex',
                                  flexDirection: 'column',
                                  justifyContent: 'center',
                                  alignItems: 'center'
                                }}>
                                  <ApiOutlined style={{ 
                                    fontSize: '48px', 
                                    marginBottom: '16px',
                                    color: '#ccc'
                                  }} />
                                  <p style={{ fontSize: '16px', margin: 0 }}>{t.noResponseData}</p>
                                </div>
                              )}
                            </div>
                          )
                        }
                      ]}
                    />
                  </Card>
                </Col>
              </Row>
            </Content>
          </Layout>
        </Layout>
      </ConfigProvider>
    </>
  )
}

'ç»ç¼˜å­æ£€æµ‹é¡µé¢
"use client"

import React, { useState, useRef, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { useAuthStore } from '@/lib/store'
import { backendApi } from '@/lib/api-client'
import type { DetectResponse, PlateInfo } from '@/types/api'
// æ³¨æ„ï¼šPlateInfoç±»å‹æš‚æ—¶ä¿ç•™ï¼Œåç»­å¯æ”¹ä¸ºCrackInfo
import { 
  Layout, 
  Menu, 
  Button, 
  Space, 
  Typography, 
  Breadcrumb, 
  Upload,
  Card,
  Tabs,
  Alert,
  List,
  Tag,
  Divider,
  theme,
  ConfigProvider,
  message,
  Row,
  Col
} from 'antd'
import {
  MenuFoldOutlined,
  MenuUnfoldOutlined,
  HomeOutlined,
  SettingOutlined,
  QuestionCircleOutlined,
  DashboardOutlined,
  ThunderboltOutlined,
  UploadOutlined,
  InboxOutlined,
  SunOutlined,
  MoonOutlined,
  FileImageOutlined,
  ApiOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  CloudUploadOutlined,
  UserOutlined,
  GlobalOutlined
} from '@ant-design/icons'
import { getI18nText, getCurrentLanguage, type Language } from '@/lib/i18n'

const { Header, Sider, Content } = Layout
const { Title, Text } = Typography
const { Dragger } = Upload
const { TabPane } = Tabs

// ä¸»é¢˜é…ç½® - ä¸dashboardä¿æŒä¸€è‡´
type ThemeData = {
  borderRadius: number;
  colorPrimary: string;
  colorBgLayout: string;
  colorBgContainer: string;
  algorithm: 'light' | 'dark';
}

const defaultLightTheme: ThemeData = {
  borderRadius: 6,
  colorPrimary: '#1890ff',
  colorBgLayout: '#f0f4f8',
  colorBgContainer: '#ffffff',
  algorithm: 'light',
}

const defaultDarkTheme: ThemeData = {
  borderRadius: 6,
  colorPrimary: '#177ddc',
  colorBgLayout: '#0a0a0a',
  colorBgContainer: '#1a1a1a',
  algorithm: 'dark',
}

export default function InsulatorDetectionPage() {
  const router = useRouter()
  const { isAuthenticated, user, updateUser } = useAuthStore()
  const [collapsed, setCollapsed] = useState(false)
  const [currentTheme, setCurrentTheme] = useState<ThemeData>(defaultLightTheme)
  const [currentLang, setCurrentLang] = useState<Language>(getCurrentLanguage())
  
  const [selectedFile, setSelectedFile] = useState<File | null>(null)
  const [previewUrl, setPreviewUrl] = useState<string>('')
  const [isDetecting, setIsDetecting] = useState(false)
  const [detectionResults, setDetectionResults] = useState<PlateInfo[]>([]) // æš‚æ—¶ä½¿ç”¨PlateInfoç±»å‹ï¼Œåç»­æ”¹ä¸ºCrackInfo
  const [error, setError] = useState('')
  const [requestData, setRequestData] = useState<any>(null)
  const [responseData, setResponseData] = useState<any>(null)
  const [activeTab, setActiveTab] = useState('1')
  const [imageSize, setImageSize] = useState<{ width: number; height: number; naturalWidth: number; naturalHeight: number } | null>(null)
  const resultImageRef = useRef<HTMLImageElement>(null)
  const visualizationImageRef = useRef<HTMLImageElement>(null)
  const previewImageRef = useRef<HTMLImageElement>(null)
  const [previewImageSize, setPreviewImageSize] = useState<{ width: number; height: number; naturalWidth: number; naturalHeight: number } | null>(null)

  const {
    token: { colorBgContainer, borderRadiusLG },
  } = theme.useToken()

  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  useEffect(() => {
    if (!isAuthenticated) {
      router.push('/login')
      return
    }

    // ä»localStorageæ¢å¤å¤´åƒ
    if (typeof window !== 'undefined' && user) {
      const savedAvatar = localStorage.getItem('userAvatar')
      if (savedAvatar && savedAvatar !== user.avatar) {
        updateUser({ avatar: savedAvatar })
      }
    }
  }, [isAuthenticated, router, user, updateUser])

  // åŠ è½½ä¸»é¢˜åå¥½
  useEffect(() => {
    if (typeof window !== 'undefined') {
      // ä»localStorageæ¢å¤ä¸»é¢˜è®¾ç½® - ä¸dashboardä¿æŒä¸€è‡´
      const savedTheme = localStorage.getItem('themeMode')
      
      if (savedTheme === 'dark') {
        setCurrentTheme(defaultDarkTheme)
      } else {
        setCurrentTheme(defaultLightTheme)
      }
    }
  }, [])

  // ç»„ä»¶å¸è½½æ—¶æ¸…ç†å†…å­˜
  useEffect(() => {
    return () => {
      if (previewUrl) {
        URL.revokeObjectURL(previewUrl)
      }
    }
  }, [previewUrl])

  const isDark = currentTheme.algorithm === 'dark'
  const t = getI18nText(currentLang)

  const handleNavigation = (path: string) => {
    if (path.startsWith('settings/')) {
      const type = path.split('/')[1]
      router.push(`/settings?type=${type}`)
    } else if (path === 'detect') {
      router.push('/insulator-detection')
    } else {
      router.push(`/${path}`)
    }
  }

  const handleQuickThemeSwitch = () => {
    const newTheme = currentTheme.algorithm === 'light' ? defaultDarkTheme : defaultLightTheme
    setCurrentTheme(newTheme)
    // ä¸dashboardä¿æŒä¸€è‡´çš„localStorageé”®å
    localStorage.setItem('themeMode', newTheme.algorithm)
  }

  // ä¾§è¾¹æ èœå•é¡¹
  const sideMenuItems = [
    {
      key: 'dashboard',
      icon: <DashboardOutlined />,
      label: t.dashboard,
      onClick: () => handleNavigation('dashboard')
    },
    {
      key: 'detect',
      icon: <ThunderboltOutlined />,
      label: t.carRecognition,
    },
    {
      key: 'nest-detection',
      icon: <HomeOutlined />,
      label: t.nestDetection,
      onClick: () => handleNavigation('nest-detection')
    },
    {
      key: 'settings',
      icon: <SettingOutlined />,
      label: t.systemSettings,
      children: [
        {
          key: 'settings/user',
          icon: <UserOutlined />,
          label: t.userSettings,
          onClick: () => handleNavigation('settings/user')
        },
        {
          key: 'settings/general',
          icon: <GlobalOutlined />,
          label: t.generalSettings,
          onClick: () => handleNavigation('settings/general')
        }
      ]
    },
    {
      key: 'aboutus',
      icon: <QuestionCircleOutlined />,
      label: t.aboutUs,
      onClick: () => handleNavigation('aboutus')
    }
  ]

  // ç®€åŒ–å¹¶ä¼˜åŒ–æ–‡ä»¶ä¸Šä¼ å¤„ç†
  const handleFileSelect = (file: File) => {
    
    setSelectedFile(file)
    setError('')
    setDetectionResults([])
    setRequestData(null)
    setResponseData(null)
    setActiveTab('1')
    
    // ç”Ÿæˆé¢„è§ˆURL
    const url = URL.createObjectURL(file)
    setPreviewUrl(url)
    
    // æ ¹æ®æ–‡ä»¶å¤§å°ç»™å‡ºä¸åŒæç¤º
    if (file.size > 3 * 1024 * 1024) {
      message.warning(`æ–‡ä»¶è¾ƒå¤§ (${(file.size / 1024 / 1024).toFixed(1)}MB)ï¼Œè¯†åˆ«æ—¶å°†è‡ªåŠ¨ä¼˜åŒ–å¤„ç†ä»¥ç¡®ä¿æœ€ä½³è¯†åˆ«æ•ˆæœ`)
    } else {
      message.success(`å›¾ç‰‡ "${file.name}" ä¸Šä¼ æˆåŠŸï¼Œå¯ä»¥å¼€å§‹è¯†åˆ«äº†`)
    }
    
  }

  // å¤„ç†æ–‡ä»¶æ‹–æ‹½ä¸Šä¼ 
  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault()
    e.stopPropagation()
    
    const files = e.dataTransfer.files
    if (files.length > 0) {
      const file = files[0]
      
      // éªŒè¯æ–‡ä»¶ç±»å‹
      const isImage = file.type.startsWith('image/')
      if (!isImage) {
        message.error('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶!')
        return
      }
      
      // è®¾ç½®æœ€å¤§æ–‡ä»¶å¤§å°ä¸º50MBï¼ˆå‹ç¼©åä¼šå°äº2MBï¼‰
      const isLt50M = file.size / 1024 / 1024 < 50
      if (!isLt50M) {
        message.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 50MB!')
        return
      }
      
      handleFileSelect(file)
    }
  }

  // å¤„ç†æ–‡ä»¶æ‹–æ‹½æ‚¬åœ
  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault()
    e.stopPropagation()
  }

  // å¤„ç†ç‚¹å‡»ä¸Šä¼ 
  const handleClickUpload = () => {
    const input = document.createElement('input')
    input.type = 'file'
    input.accept = 'image/*,.jpg,.jpeg,.png'
    input.style.display = 'none'
    
    input.onchange = (e) => {
      const target = e.target as HTMLInputElement
      const files = target.files
      if (files && files.length > 0) {
        const file = files[0]
        
        // éªŒè¯æ–‡ä»¶ç±»å‹
        const isImage = file.type.startsWith('image/')
        if (!isImage) {
          message.error('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶!')
          return
        }
        
        // è®¾ç½®æœ€å¤§æ–‡ä»¶å¤§å°ä¸º50MBï¼ˆå‹ç¼©åä¼šå°äº2MBï¼‰
        const isLt50M = file.size / 1024 / 1024 < 50
        if (!isLt50M) {
          message.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 50MB!')
          return
        }
        
        handleFileSelect(file)
      }
      
      // æ¸…ç†inputå…ƒç´ 
      document.body.removeChild(input)
    }
    
    document.body.appendChild(input)
    input.click()
  }

  /**
   * ç»ç¼˜å­æ£€æµ‹
   * ä¸Šä¼ å›¾ç‰‡å¹¶è°ƒç”¨APIè¿›è¡Œæ£€æµ‹
   */
  const handleDetection = async () => {
    
    if (!selectedFile) {
      message.error('è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶')
      return
    }

    // éªŒè¯æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ
    if (!(selectedFile instanceof File)) {
      message.error('æ–‡ä»¶æ ¼å¼æ— æ•ˆï¼Œè¯·é‡æ–°é€‰æ‹©')
      setSelectedFile(null)
      setPreviewUrl('')
      return
    }

    setIsDetecting(true)
    setError('')
    setDetectionResults([])
    setActiveTab('1')

    try {
        name: selectedFile.name,
        size: selectedFile.size,
        type: selectedFile.type
      })
      
      // å°†æ–‡ä»¶è½¬æ¢ä¸ºBase64ï¼ˆRoboflow APIéœ€è¦ï¼‰
      const base64 = await backendApi.utils.fileToBase64(selectedFile)
      // ç§»é™¤data:image/xxx;base64,å‰ç¼€ï¼Œåªä¿ç•™base64æ•°æ®
      const base64Data = base64.split(',')[1] || base64
      
      // è®°å½•è¯·æ±‚æ•°æ®
      setRequestData({
        method: 'POST',
        url: 'https://serverless.roboflow.com/insulator-defect-c1kcs/1',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        params: {
          api_key: 'cW6r5HCK2OL5sVo7ymUO'
        },
        body: {
          file: selectedFile.name,
          size: `${(selectedFile.size / 1024).toFixed(2)} KB`,
          type: selectedFile.type,
          base64Length: base64Data.length,
          timestamp: new Date().toISOString()
        }
      })
      
      // ä½¿ç”¨Roboflow APIè¿›è¡Œæ£€æµ‹
      const response: DetectResponse = await backendApi.detect.byImage(selectedFile)
      
      
      // è®°å½•å“åº”æ•°æ®
      setResponseData(response)

      if (response.isSuccess && response.infos) {
        setDetectionResults(response.infos)
      } else {
        const errorMessage = response.messages?.[0]?.description || 'ç»ç¼˜å­æ£€æµ‹å¤±è´¥'
        setError(errorMessage)
        message.error(errorMessage)
      }
    } catch (error: any) {
      
      let errorMsg = 'æ£€æµ‹è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯'
      
      // é’ˆå¯¹ä¸åŒç±»å‹çš„é”™è¯¯æä¾›ä¸åŒçš„å¤„ç†
      if (error.message?.includes('è®¤è¯å¤±è´¥') || error.message?.includes('401') || error.message?.includes('Unauthorized')) {
        errorMsg = 'è®¤è¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
        message.error(errorMsg)
      } else if (error.message?.includes('è¯†åˆ«å¤±è´¥')) {
        errorMsg = 'å›¾ç‰‡ä¸­æœªèƒ½è¯†åˆ«å‡ºç¼ºé™·ï¼Œè¯·ç¡®ä¿ï¼š\n1. å›¾ç‰‡ä¸­åŒ…å«æ¸…æ™°å¯è§çš„ç»ç¼˜å­\n2. ç»ç¼˜å­æ²¡æœ‰è¢«é®æŒ¡\n3. å›¾ç‰‡å…‰çº¿å……è¶³ã€å¯¹æ¯”åº¦è‰¯å¥½'
        message.error(errorMsg)
      } else if (error.message?.includes('æ–‡ä»¶å¤ªå¤§') || error.message?.includes('400')) {
        errorMsg = 'å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·å°è¯•ä½¿ç”¨æ›´å°æˆ–è´¨é‡æ›´å¥½çš„å›¾ç‰‡æ–‡ä»¶'
        message.error(errorMsg)
      } else if (error.message?.includes('å‹ç¼©å¤±è´¥') || error.message?.includes('å›¾ç‰‡åŠ è½½å¤±è´¥')) {
        errorMsg = 'å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆæ”¯æŒJPGã€PNGæ ¼å¼ï¼‰'
        message.error(errorMsg)
      } else if (error.message?.includes('Network') || error.message?.includes('ç½‘ç»œ')) {
        errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•'
        message.error(errorMsg)
      } else if (error.message?.includes('timeout') || error.message?.includes('è¶…æ—¶')) {
        errorMsg = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•'
        message.error(errorMsg)
      } else {
        errorMsg = error.message || 'æ£€æµ‹è¿‡ç¨‹ä¸­å‡ºç°æœªçŸ¥é”™è¯¯'
        message.error(errorMsg)
      }
      
      setError(errorMsg)
      setResponseData({
        isSuccess: false,
        error: errorMsg,
        timestamp: new Date().toISOString(),
        messages: [{
          code: 'DETECTION_ERROR',
          description: errorMsg
        }]
      })
    } finally {
      setIsDetecting(false)
    }
  }

  // æ¸…ç©ºç»“æœ
  const handleClear = () => {
    // æ¸…ç†å†…å­˜ä¸­çš„URL
    if (previewUrl) {
      URL.revokeObjectURL(previewUrl)
    }
    
    setSelectedFile(null)
    setPreviewUrl('')
    setDetectionResults([])
    setError('')
    setRequestData(null)
    setResponseData(null)
    setActiveTab('1')
    setPreviewImageSize(null)
    
    message.info('å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®')
  }

  if (!isAuthenticated) {
    return null
  }

  return (
    <>
      <style jsx>{`
        :global(.custom-menu.ant-menu-dark .ant-menu-item),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-title) {
          background-color: transparent !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-item:hover),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-title:hover) {
          background-color: rgba(255, 255, 255, 0.08) !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-item-selected) {
          background-color: rgba(255, 255, 255, 0.12) !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-selected > .ant-menu-submenu-title),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-open > .ant-menu-submenu-title),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-active > .ant-menu-submenu-title),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-title:active),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-title:focus) {
          background-color: transparent !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-sub) {
          background-color: transparent !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-sub .ant-menu-item) {
          background-color: transparent !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-sub .ant-menu-item:hover) {
          background-color: rgba(255, 255, 255, 0.08) !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-sub .ant-menu-item-selected),
        :global(.custom-menu.ant-menu-dark .ant-menu-sub .ant-menu-item-active) {
          background-color: rgba(255, 255, 255, 0.12) !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub) {
          background-color: transparent !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub .ant-menu-item) {
          background-color: transparent !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub .ant-menu-item:hover) {
          background-color: rgba(255, 255, 255, 0.08) !important;
        }
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub .ant-menu-item-selected),
        :global(.custom-menu.ant-menu-dark .ant-menu-submenu-open .ant-menu-sub .ant-menu-item-active) {
          background-color: rgba(255, 255, 255, 0.12) !important;
        }
      `}</style>
      <ConfigProvider
        theme={{
          token: {
            colorPrimary: currentTheme.colorPrimary,
            borderRadius: currentTheme.borderRadius,
            colorBgLayout: currentTheme.colorBgLayout,
            colorBgContainer: currentTheme.colorBgContainer,
            colorBgElevated: isDark ? '#262626' : '#ffffff',
            colorBorder: isDark ? '#303030' : '#e1e8ed',
            colorBorderSecondary: isDark ? '#252525' : '#f0f0f0',
            colorText: isDark ? '#ffffff' : '#000000d9',
            colorTextSecondary: isDark ? '#bfbfbf' : '#00000073',
            colorTextTertiary: isDark ? '#8c8c8c' : '#00000045',
            colorFillAlter: isDark ? '#1f1f1f' : '#fafafa',
            colorFillContent: isDark ? '#262626' : '#f5f5f5',
            colorBgTextHover: isDark ? '#2a2a2a' : '#f5f5f5',
          },
          components: {
            Menu: {
              itemBg: 'transparent',
              subMenuItemBg: 'transparent',
              itemActiveBg: 'transparent',
              itemSelectedBg: isDark ? 'rgba(255, 255, 255, 0.12)' : 'rgba(255, 255, 255, 0.12)',
              itemHoverBg: isDark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(255, 255, 255, 0.08)',
            },
          },
          algorithm: isDark ? theme.darkAlgorithm : theme.defaultAlgorithm,
        }}
      >
        <Layout style={{ height: '100vh', overflow: 'hidden' }}>
          {/* ä¾§è¾¹æ  - 208px (200+8Ã—1) */}
          <Sider 
            trigger={null} 
            collapsible 
            collapsed={collapsed}
            breakpoint="lg"
            collapsedWidth={collapsed ? 0 : 80}
            width={208}
            style={{
              background: 'linear-gradient(180deg, #1890ff 0%, #096dd9 30%, #0050b3 70%, #003a8c 100%)',
              height: '100vh',
              overflow: 'auto',
              position: 'fixed',
              left: 0,
              top: 0,
              bottom: 0,
              zIndex: 999
            }}
          >
            <div style={{ 
              height: 64, 
              margin: '16px', 
              display: 'flex', 
              alignItems: 'center',
              justifyContent: collapsed ? 'center' : 'flex-start',
              borderBottom: '1px solid rgba(255,255,255,0.1)',
              paddingBottom: 16
            }}>
              <ThunderboltOutlined style={{ fontSize: '24px', color: '#fff' }} />
              {!collapsed && (
                <Title level={4} style={{ margin: '0 0 0 12px', color: '#fff', fontSize: '16px' }}>
                  {t.carRecognition}
                </Title>
              )}
            </div>
            <Menu
              theme="dark"
              mode="inline"
              defaultSelectedKeys={['detect']}
              items={sideMenuItems}
              style={{ 
                borderRight: 0,
                background: 'transparent'
              }}
              className="custom-menu"
            />
          </Sider>

          <Layout style={{ marginLeft: collapsed ? 0 : 208 }}>
            {/* é¡¶éƒ¨å¯¼èˆªæ  - 64px (48+8Ã—2) */}
            <Header style={{ 
              display: 'flex', 
              alignItems: 'center',
              padding: '0 24px',
              height: 64,
              background: isDark
                ? 'linear-gradient(90deg, rgba(26,26,26,0.95) 0%, rgba(42,42,42,0.9) 50%, rgba(26,26,26,0.95) 100%)'
                : 'linear-gradient(90deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.9) 50%, rgba(255,255,255,0.95) 100%)',
              justifyContent: 'space-between',
              boxShadow: isDark
                ? '0 2px 8px rgba(0,0,0,0.4)' 
                : '0 2px 8px rgba(24, 144, 255, 0.08)',
              borderBottom: isDark
                ? '1px solid rgba(255,255,255,0.1)' 
                : '1px solid rgba(24, 144, 255, 0.08)',
              backdropFilter: 'blur(12px)'
            }}>
              {/* å·¦ä¾§ï¼šæŠ˜å æŒ‰é’® + é¢åŒ…å±‘ */}
              <Space>
                <Button
                  type="text"
                  icon={collapsed ? <MenuUnfoldOutlined /> : <MenuFoldOutlined />}
                  onClick={() => setCollapsed(!collapsed)}
                  size="large"
                  style={{
                    fontSize: '16px',
                    width: 40,
                    height: 40,
                    color: isDark ? '#ffffff' : '#1890ff'
                  }}
                />
                
                <Breadcrumb
                  items={[
                    {
                      href: '/dashboard',
                      title: <HomeOutlined />
                    },
                    {
                      title: t.carRecognition
                    }
                  ]}
                />
              </Space>

              {/* å³ä¾§ï¼šå¿«é€Ÿä¸»é¢˜åˆ‡æ¢ */}
              <Button
                type="primary"
                shape="circle"
                size="large"
                icon={isDark ? <SunOutlined /> : <MoonOutlined />}
                onClick={handleQuickThemeSwitch}
                style={{
                  width: 40,
                  height: 40,
                  backgroundColor: isDark ? '#faad14' : currentTheme.colorPrimary,
                  borderColor: isDark ? '#faad14' : currentTheme.colorPrimary,
                  boxShadow: isDark
                    ? '0 4px 12px rgba(250, 173, 20, 0.4)' 
                    : `0 4px 12px ${currentTheme.colorPrimary}40`
                }}
              />
            </Header>

            {/* ä¸»è¦å†…å®¹åŒºåŸŸ */}
            <Content style={{ 
              margin: '24px',
              padding: '24px',
              background: isDark
                ? 'linear-gradient(135deg, rgba(26,26,26,0.95) 0%, rgba(42,42,42,0.8) 25%, rgba(58,58,58,0.6) 50%, rgba(42,42,42,0.8) 75%, rgba(26,26,26,0.95) 100%)'
                : 'linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.7) 25%, rgba(240,248,255,0.5) 50%, rgba(248,250,252,0.7) 75%, rgba(255,255,255,0.9) 100%)',
              borderRadius: borderRadiusLG,
              backdropFilter: 'blur(16px)',
              border: isDark
                ? '1px solid rgba(255,255,255,0.1)' 
                : '1px solid rgba(24, 144, 255, 0.12)',
              boxShadow: isDark
                ? '0 8px 32px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.1)' 
                : '0 8px 32px rgba(24, 144, 255, 0.12), inset 0 1px 0 rgba(255,255,255,0.9)',
              overflow: 'auto',
              height: 'calc(100vh - 112px)'
            }}>
              <div style={{ marginBottom: '24px' }}>
                <Title level={2} style={{ margin: 0, display: 'flex', alignItems: 'center' }}>
                  <ThunderboltOutlined style={{ marginRight: '12px', color: currentTheme.colorPrimary }} />
                  {t.insulatorDetectionTitle}
                </Title>
                <Text type="secondary">{t.insulatorDetectionSubtitle}</Text>
              </div>

              {/* å·¦å³å¯¹ç§°å¸ƒå±€ */}
              <Row gutter={24} style={{ height: 'calc(100% - 80px)' }}>
                {/* å·¦ä¾§ï¼šä¸Šä¼ åŒºåŸŸ */}
                <Col xs={24} lg={12} style={{ height: '100%' }}>
                  <Card 
                    style={{ 
                      height: '100%', 
                      display: 'flex',
                      flexDirection: 'column',
                      background: isDark
                        ? 'linear-gradient(135deg, rgba(38,38,38,0.9) 0%, rgba(58,58,58,0.7) 50%, rgba(38,38,38,0.9) 100%)'
                        : 'linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.8) 50%, rgba(255,255,255,0.95) 100%)',
                      border: isDark
                        ? '1px solid rgba(255,255,255,0.12)' 
                        : '1px solid rgba(24, 144, 255, 0.12)',
                      backdropFilter: 'blur(12px)',
                      borderRadius: borderRadiusLG,
                      boxShadow: isDark
                        ? '0 4px 16px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1)' 
                        : '0 4px 16px rgba(24, 144, 255, 0.1), inset 0 1px 0 rgba(255,255,255,0.9)'
                    }}
                    bodyStyle={{ 
                      flex: 1,
                      display: 'flex',
                      flexDirection: 'column',
                      justifyContent: 'center',
                      padding: '24px'
                    }}
                  >
                    {!previewUrl ? (
                      <div 
                        style={{ 
                          width: '100%',
                          height: '100%',
                          minHeight: '400px',
                          background: isDark ? '#1a1a1a' : '#fafafa',
                          borderRadius: '8px',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          cursor: 'pointer',
                          transition: 'all 0.3s ease'
                        }}
                        onClick={handleClickUpload}
                        onDrop={handleDrop}
                        onDragOver={handleDragOver}
                        onDragEnter={handleDragOver}
                      >
                        <div style={{ textAlign: 'center', padding: '40px 20px' }}>
                          <CloudUploadOutlined style={{ 
                            fontSize: '64px', 
                            color: currentTheme.colorPrimary,
                            marginBottom: '16px',
                            display: 'block'
                          }} />
                          <p style={{ 
                            fontSize: '18px', 
                            margin: '16px 0',
                            fontWeight: 500,
                            color: isDark ? '#ffffff' : '#000000d9'
                          }}>
                            {t.clickOrDrag}
                          </p>
                          <p style={{
                            color: isDark ? '#8c8c8c' : '#666',
                            fontSize: '14px',
                            margin: 0
                          }}>
                            {t.supportedFormats}
                            <br />
                            <span style={{ fontSize: '12px', color: isDark ? '#666' : '#999' }}>
                              {t.largeFileNotice}
                            </span>
                          </p>
                        </div>
                      </div>
                    ) : (
                      <div style={{ 
                        width: '100%',
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        justifyContent: 'center',
                        height: '100%'
                      }}>
                        {/* æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º */}
                        {selectedFile && (
                          <div style={{
                            width: '100%',
                            padding: '12px',
                            background: isDark ? '#262626' : '#f0f8ff',
                            border: isDark ? '1px solid #303030' : '1px solid #d6e4ff',
                            borderRadius: '6px',
                            marginBottom: '16px',
                            fontSize: '13px'
                          }}>
                            <div style={{ marginBottom: '4px' }}>
                              <Text strong>{t.fileName}ï¼š</Text>
                              <Text>{selectedFile.name}</Text>
                            </div>
                            <div style={{ marginBottom: '4px' }}>
                              <Text strong>{t.fileSize}ï¼š</Text>
                              <Text>{(selectedFile.size / 1024).toFixed(2)} KB</Text>
                            </div>
                            <div>
                              <Text strong>{t.fileType}ï¼š</Text>
                              <Text>{selectedFile.type}</Text>
                            </div>
                          </div>
                        )}
                        
                        <div style={{
                          position: 'relative',
                          display: 'inline-block',
                          width: '100%',
                          marginBottom: '20px'
                        }}>
                          <img
                            ref={previewImageRef}
                            src={previewUrl}
                            alt="é¢„è§ˆ"
                            style={{
                              maxWidth: '100%',
                              maxHeight: '500px',
                              borderRadius: '8px',
                              objectFit: 'contain',
                              display: 'block'
                            }}
                            onLoad={(e) => {
                              // å›¾ç‰‡åŠ è½½å®Œæˆåï¼Œè·å–å®é™…å°ºå¯¸ç”¨äºç¼©æ”¾è®¡ç®—
                              const img = e.currentTarget
                              const displayWidth = img.clientWidth
                              const displayHeight = img.clientHeight
                              const naturalWidth = img.naturalWidth
                              const naturalHeight = img.naturalHeight
                              
                              setPreviewImageSize({
                                width: displayWidth,
                                height: displayHeight,
                                naturalWidth: naturalWidth,
                                naturalHeight: naturalHeight
                              })
                            }}
                          />
                          {/* åœ¨é¢„è§ˆå›¾ç‰‡ä¸Šç»˜åˆ¶æ£€æµ‹æ¡† */}
                          {previewImageSize && detectionResults.length > 0 && detectionResults.map((result, index) => {
                            if (!result.rect || result.rect.x === null || result.rect.y === null || 
                                result.rect.width === null || result.rect.height === null) {
                              return null
                            }
                            
                            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼šæ˜¾ç¤ºå°ºå¯¸ / åŸå§‹å°ºå¯¸
                            let scaleX = 1
                            let scaleY = 1
                            
                            if (previewImageSize.naturalWidth > 0 && previewImageSize.naturalHeight > 0) {
                              scaleX = previewImageSize.width / previewImageSize.naturalWidth
                              scaleY = previewImageSize.height / previewImageSize.naturalHeight
                            } else if (previewImageRef.current) {
                              const img = previewImageRef.current
                              if (img.naturalWidth > 0 && img.naturalHeight > 0) {
                                scaleX = img.clientWidth / img.naturalWidth
                                scaleY = img.clientHeight / img.naturalHeight
                              }
                            }
                            
                            // åº”ç”¨ç¼©æ”¾æ¯”ä¾‹
                            const x = result.rect.x * scaleX
                            const y = result.rect.y * scaleY
                            const width = result.rect.width * scaleX
                            const height = result.rect.height * scaleY
                            
                            // æ ¹æ®classå’Œcolorå­—æ®µåˆ¤æ–­ç±»å‹
                            const className = (result.class || '').toLowerCase()
                            const isInsulator = className === 'insulator' || className === 'insulators' || className.includes('insulator')
                            // å¦‚æœä¸æ˜¯ç»ç¼˜å­ï¼Œåˆ™é»˜è®¤ä¸ºç¼ºé™·
                            const isDefect = !isInsulator || result.color === 'red'
                            
                            // ç¼ºé™·ç”¨çº¢è‰²ï¼Œç»ç¼˜å­ç”¨è“è‰²
                            const boxColor = isDefect ? '#ff4d4f' : '#1890ff'
                            const confidence = result.confidence || 0
                            
                            return (
                              <div
                                key={index}
                                style={{
                                  position: 'absolute',
                                  left: `${x}px`,
                                  top: `${y}px`,
                                  width: `${width}px`,
                                  height: `${height}px`,
                                  border: `1px solid ${boxColor}`,
                                  borderRadius: '2px',
                                  pointerEvents: 'none',
                                  backgroundColor: 'transparent'
                                }}
                              >
                                {/* ç½®ä¿¡åº¦æ ‡ç­¾ - åªæ˜¾ç¤ºç™¾åˆ†æ¯” */}
                                {confidence > 0 && (
                                  <div
                                    style={{
                                      position: 'absolute',
                                      top: '-20px',
                                      left: '0',
                                      background: boxColor,
                                      color: '#fff',
                                      padding: '2px 6px',
                                      borderRadius: '2px',
                                      fontSize: '11px',
                                      fontWeight: '500',
                                      whiteSpace: 'nowrap',
                                      lineHeight: '1.2',
                                      minWidth: '35px',
                                      textAlign: 'center'
                                    }}
                                  >
                                    {confidence}%
                                  </div>
                                )}
                              </div>
                            )
                          })}
                        </div>
                        <Space size="large">
                          <Button
                            type="primary"
                            size="large"
                            loading={isDetecting}
                            onClick={handleDetection}
                            icon={<ApiOutlined />}
                            disabled={!selectedFile}
                            style={{
                              minWidth: '120px',
                              height: '40px'
                            }}
                          >
                            {isDetecting ? t.detecting : t.startDetection}
                          </Button>
                          
                          <Button
                            size="large"
                            onClick={handleClear}
                            style={{
                              minWidth: '80px',
                              height: '40px'
                            }}
                          >
                            {t.clear}
                          </Button>
                        </Space>
                        
                        {/* çŠ¶æ€æç¤º */}
                        {selectedFile && !isDetecting && (
                          <div style={{
                            marginTop: '12px',
                            padding: '8px 12px',
                            background: isDark ? '#1f4838' : '#f6ffed',
                            border: isDark ? '1px solid #274916' : '1px solid #b7eb8f',
                            borderRadius: '4px',
                            fontSize: '12px',
                            color: isDark ? '#95de64' : '#389e0d'
                          }}>
                            âœ“ {t.insulatorDetectionReady}
                          </div>
                        )}
                      </div>
                    )}
                  </Card>
                </Col>

                {/* å³ä¾§ï¼šæ ‡ç­¾é¡µåŒºåŸŸ */}
                <Col xs={24} lg={12} style={{ height: '100%' }}>
                  <Card 
                    style={{ 
                      height: '100%',
                      display: 'flex',
                      flexDirection: 'column',
                      background: isDark
                        ? 'linear-gradient(135deg, rgba(38,38,38,0.9) 0%, rgba(58,58,58,0.7) 50%, rgba(38,38,38,0.9) 100%)'
                        : 'linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.8) 50%, rgba(255,255,255,0.95) 100%)',
                      border: isDark
                        ? '1px solid rgba(255,255,255,0.12)' 
                        : '1px solid rgba(24, 144, 255, 0.12)',
                      backdropFilter: 'blur(12px)',
                      borderRadius: borderRadiusLG,
                      boxShadow: isDark
                        ? '0 4px 16px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1)' 
                        : '0 4px 16px rgba(24, 144, 255, 0.1), inset 0 1px 0 rgba(255,255,255,0.9)'
                    }}
                    bodyStyle={{ 
                      flex: 1,
                      padding: 0
                    }}
                  >
                    <Tabs 
                      activeKey={activeTab} 
                      onChange={setActiveTab}
                      style={{ height: '100%' }}
                      tabBarStyle={{ 
                        padding: '0 24px',
                        margin: 0,
                        borderBottom: isDark ? '1px solid #303030' : '1px solid #f0f0f0'
                      }}
                      items={[
                        {
                          key: '1',
                          label: t.detectionResults,
                          children: (
                            <div style={{ 
                              padding: '24px',
                              height: 'calc(100% - 48px)',
                              overflow: 'auto'
                            }}>
                              {error && (
                                <Alert
                                  message={t.detectionFailed}
                                  description={
                                    <div>
                                      <div style={{ marginBottom: '8px' }}>{error}</div>
                                      {error.includes('è¯†åˆ«å¤±è´¥') && (
                                        <div style={{ 
                                          padding: '8px 12px', 
                                          background: isDark ? '#1f1f1f' : '#f6ffed',
                                          border: isDark ? '1px solid #303030' : '1px solid #b7eb8f',
                                          borderRadius: '4px',
                                          fontSize: '12px',
                                          marginTop: '8px'
                                        }}>
                                          <strong>ğŸ’¡ {t.detectionTips}ï¼š</strong>
                                          <ul style={{ margin: '4px 0', paddingLeft: '16px' }}>
                                            {t.insulatorDetectionTips.map((tip, index) => (
                                              <li key={index}>{tip}</li>
                                            ))}
                                          </ul>
                                        </div>
                                      )}
                                    </div>
                                  }
                                  type="error"
                                  showIcon
                                  style={{ marginBottom: '16px' }}
                                />
                              )}
                              
                              {detectionResults.length > 0 && (
                                <div>
                                  <div style={{ 
                                    display: 'flex', 
                                    alignItems: 'center',
                                    marginBottom: '16px'
                                  }}>
                                    <CheckCircleOutlined style={{ 
                                      color: '#52c41a',
                                      fontSize: '18px',
                                      marginRight: '8px'
                                    }} />
                                    <Text strong style={{ fontSize: '16px' }}>
                                      {t.detectionResults} ({detectionResults.length} {t.detectedItems})
                                    </Text>
                                  </div>
                                  
                                  <List
                                    dataSource={detectionResults}
                                    renderItem={(result, index) => {
                                      // åˆ¤æ–­ç±»å‹
                                      const className = (result.class || '').toLowerCase()
                                      const isInsulator = className === 'insulator' || className === 'insulators' || className.includes('insulator')
                                      // å¦‚æœä¸æ˜¯ç»ç¼˜å­ï¼Œåˆ™é»˜è®¤ä¸ºç¼ºé™·
                                      const isDefect = !isInsulator || result.color === 'red'
                                      
                                      const typeLabel = isInsulator ? t.insulator : t.defect
                                      const typeColor = isInsulator ? 'blue' : 'red'
                                      const itemTitle = isInsulator ? `${t.insulator} #${index + 1}` : `${t.defect} #${index + 1}`
                                      
                                      return (
                                        <List.Item 
                                          key={index}
                                          style={{
                                            border: isDark ? '1px solid #303030' : '1px solid #f0f0f0',
                                            borderRadius: '8px',
                                            marginBottom: '12px',
                                            padding: '16px',
                                            background: isDark ? '#262626' : '#fafafa'
                                          }}
                                        >
                                          <List.Item.Meta
                                            avatar={
                                              <FileImageOutlined style={{ 
                                                fontSize: '24px', 
                                                color: isInsulator ? '#1890ff' : '#ff4d4f'
                                              }} />
                                            }
                                            title={
                                              <Space>
                                                <Text strong style={{ fontSize: '18px' }}>
                                                  {itemTitle}
                                                </Text>
                                                <Tag color={typeColor}>{typeLabel}</Tag>
                                              </Space>
                                            }
                                            description={
                                              <div>
                                                <div style={{ marginBottom: '8px' }}>
                                                  <Text type="secondary">{t.confidence}: </Text>
                                                  <Text style={{ marginLeft: '4px', fontWeight: 500 }}>
                                                    {result.confidence ? `${result.confidence}%` : (currentLang === 'en' ? 'Unknown' : 'æœªçŸ¥')}
                                                  </Text>
                                                </div>
                                                {result.rect && (
                                                  <Text type="secondary" style={{ fontSize: '12px' }}>
                                                    {t.position}: ({result.rect.x}, {result.rect.y}) | 
                                                    {t.size}: {result.rect.width} Ã— {result.rect.height}
                                                  </Text>
                                                )}
                                              </div>
                                            }
                                          />
                                        </List.Item>
                                      )
                                    }}
                                  />
                                </div>
                              )}
                              
                              {!isDetecting && !error && detectionResults.length === 0 && (
                                <div style={{ 
                                  textAlign: 'center', 
                                  padding: '60px 20px', 
                                  color: '#999',
                                  height: '100%',
                                  display: 'flex',
                                  flexDirection: 'column',
                                  justifyContent: 'center',
                                  alignItems: 'center'
                                }}>
                                  <FileImageOutlined style={{ 
                                    fontSize: '48px', 
                                    marginBottom: '16px',
                                    color: '#ccc'
                                  }} />
                                  <p style={{ fontSize: '16px', margin: 0 }}>{t.noDetectionData}</p>
                                </div>
                              )}
                            </div>
                          )
                        },
                        {
                          key: '2',
                          label: 'Request',
                          children: (
                            <div style={{ 
                              padding: '24px',
                              height: 'calc(100% - 48px)',
                              overflow: 'auto'
                            }}>
                              {requestData ? (
                                <pre style={{ 
                                  background: isDark ? '#1a1a1a' : '#f5f5f5',
                                  padding: '16px',
                                  borderRadius: '4px',
                                  overflow: 'auto',
                                  border: isDark ? '1px solid #303030' : '1px solid #e1e8ed',
                                  fontSize: '13px',
                                  lineHeight: '1.5'
                                }}>
                                  {JSON.stringify(requestData, null, 2)}
                                </pre>
                              ) : (
                                <div style={{ 
                                  textAlign: 'center', 
                                  padding: '60px 20px', 
                                  color: '#999',
                                  height: '100%',
                                  display: 'flex',
                                  flexDirection: 'column',
                                  justifyContent: 'center',
                                  alignItems: 'center'
                                }}>
                                  <ApiOutlined style={{ 
                                    fontSize: '48px', 
                                    marginBottom: '16px',
                                    color: '#ccc'
                                  }} />
                                  <p style={{ fontSize: '16px', margin: 0 }}>{t.noRequestData}</p>
                                </div>
                              )}
                            </div>
                          )
                        },
                        {
                          key: '3',
                          label: t.response,
                          children: (
                            <div style={{ 
                              padding: '24px',
                              height: 'calc(100% - 48px)',
                              overflow: 'auto',
                              display: 'flex',
                              flexDirection: 'column'
                            }}>
                              {responseData ? (
                                <>
                                  <pre style={{ 
                                    background: isDark ? '#1a1a1a' : '#f5f5f5',
                                    padding: '16px',
                                    borderRadius: '4px',
                                    overflow: 'auto',
                                    border: isDark ? '1px solid #303030' : '1px solid #e1e8ed',
                                    fontSize: '13px',
                                    lineHeight: '1.5',
                                    marginBottom: '24px',
                                    maxHeight: '300px'
                                  }}>
                                    {JSON.stringify(responseData, null, 2)}
                                  </pre>
                                  
                                </>
                              ) : (
                                <div style={{ 
                                  textAlign: 'center', 
                                  padding: '60px 20px', 
                                  color: '#999',
                                  height: '100%',
                                  display: 'flex',
                                  flexDirection: 'column',
                                  justifyContent: 'center',
                                  alignItems: 'center'
                                }}>
                                  <ApiOutlined style={{ 
                                    fontSize: '48px', 
                                    marginBottom: '16px',
                                    color: '#ccc'
                                  }} />
                                  <p style={{ fontSize: '16px', margin: 0 }}>{t.noResponseData}</p>
                                </div>
                              )}
                            </div>
                          )
                        }
                      ]}
                    />
                  </Card>
                </Col>
              </Row>
            </Content>
          </Layout>
        </Layout>
      </ConfigProvider>
    </>
  )
} 'æ¬¢è¿å¡ç‰‡ç»„ä»¶
/**
 * Welcome Card Component
 * 
 * æ¬¢è¿å¡ç‰‡ç»„ä»¶ï¼Œç”¨äºå±•ç¤ºç”¨æˆ·æ¬¢è¿ä¿¡æ¯å’ŒçŠ¶æ€æ ‡ç­¾
 * 
 * @module WelcomeCard
 * @description 
 * è¯¥ç»„ä»¶æä¾›äº†ç”¨æˆ·æ¬¢è¿åŒºåŸŸçš„å±•ç¤ºï¼ŒåŒ…æ‹¬ï¼š
 * - ç”¨æˆ·å¤´åƒå±•ç¤º
 * - æ¬¢è¿æ–‡æœ¬å’Œç”¨æˆ·å
 * - ç”¨æˆ·é‚®ç®±ä¿¡æ¯
 * - ç”¨æˆ·çŠ¶æ€æ ‡ç­¾ï¼ˆç®¡ç†å‘˜ã€åœ¨çº¿çŠ¶æ€ç­‰ï¼‰
 * - å¯é€‰çš„æ“ä½œæŒ‰é’®ï¼ˆé…ç½®æ£€æŸ¥ã€åç«¯æ¼”ç¤ºï¼‰
 * - ä¸»é¢˜é€‚é…ï¼ˆæ˜æš—æ¨¡å¼ï¼‰
 * 
 * @performance
 * ä½¿ç”¨ React.memo è¿›è¡Œç»„ä»¶è®°å¿†åŒ–ï¼Œä»…åœ¨ props å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“
 * 
 * @author Aerotrace Development Team
 * @version 1.0.0
 */

import React from 'react'
import { Card, Row, Col, Avatar, Typography, Space, Tag, Button } from 'antd'
import { theme } from 'antd'
import { AvatarUpload } from '@/components/avatar-upload'

const { Title, Paragraph } = Typography

/**
 * æ¬¢è¿å¡ç‰‡ç»„ä»¶çš„å±æ€§æ¥å£
 * 
 * @interface WelcomeCardProps
 * @property {string} [username='User'] - ç”¨æˆ·å
 * @property {string} [email='user@example.com'] - ç”¨æˆ·é‚®ç®±
 * @property {string} welcomeText - æ¬¢è¿æ–‡æœ¬
 * @property {string} adminText - ç®¡ç†å‘˜æ ‡ç­¾æ–‡æœ¬
 * @property {string} onlineText - åœ¨çº¿çŠ¶æ€æ ‡ç­¾æ–‡æœ¬
 * @property {string} [configCheckText] - é…ç½®æ£€æŸ¥æŒ‰é’®æ–‡æœ¬ï¼ˆå¯é€‰ï¼‰
 * @property {string} [backendDemoText] - åç«¯æ¼”ç¤ºæŒ‰é’®æ–‡æœ¬ï¼ˆå¯é€‰ï¼‰
 * @property {() => void} [onConfigCheck] - é…ç½®æ£€æŸ¥æŒ‰é’®ç‚¹å‡»å›è°ƒå‡½æ•°
 * @property {() => void} [onBackendDemo] - åç«¯æ¼”ç¤ºæŒ‰é’®ç‚¹å‡»å›è°ƒå‡½æ•°
 * @property {boolean} [isDark=false] - æ˜¯å¦ä¸ºæš—è‰²ä¸»é¢˜æ¨¡å¼
 * @property {string} colorPrimary - ä¸»é¢˜ä¸»è‰²è°ƒ
 */
interface WelcomeCardProps {
  username?: string
  email?: string
  welcomeText: string
  adminText: string
  onlineText: string
  configCheckText?: string
  backendDemoText?: string
  onConfigCheck?: () => void
  onBackendDemo?: () => void
  isDark?: boolean
  colorPrimary: string
}

/**
 * æ¬¢è¿å¡ç‰‡ç»„ä»¶
 * 
 * @component WelcomeCard
 * @param {WelcomeCardProps} props - ç»„ä»¶å±æ€§å¯¹è±¡
 * @returns {JSX.Element} æ¸²æŸ“çš„æ¬¢è¿å¡ç‰‡å…ƒç´ 
 */
export const WelcomeCard: React.FC<WelcomeCardProps> = React.memo(({
  username = 'User',
  email = 'user@example.com',
  welcomeText,
  adminText,
  onlineText,
  configCheckText,
  backendDemoText,
  onConfigCheck,
  onBackendDemo,
  isDark = false,
  colorPrimary
}) => {
  const {
    token: { borderRadiusLG },
  } = theme.useToken()

  const showButtons = configCheckText && backendDemoText && onConfigCheck && onBackendDemo

  return (
    <Card 
      style={{ 
        marginBottom: 16,
        height: 180,
        background: isDark
          ? 'linear-gradient(135deg, rgba(38,38,38,0.9) 0%, rgba(58,58,58,0.7) 50%, rgba(38,38,38,0.9) 100%)'
          : 'linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.8) 50%, rgba(255,255,255,0.95) 100%)',
        border: isDark
          ? '1px solid rgba(255,255,255,0.12)' 
          : '1px solid rgba(24, 144, 255, 0.12)',
        backdropFilter: 'blur(12px)',
        borderRadius: borderRadiusLG,
        boxShadow: isDark
          ? '0 4px 16px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1)' 
          : '0 4px 16px rgba(24, 144, 255, 0.1), inset 0 1px 0 rgba(255,255,255,0.9)'
      }}
      bodyStyle={{ padding: '24px', height: '100%' }}
    >
      <Row gutter={[24, 16]} align="middle" style={{ height: '100%' }}>
        <Col style={{ display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
          <AvatarUpload 
            size={64} 
            showUpload={false}
            style={{ 
              backgroundColor: colorPrimary,
              boxShadow: isDark
                ? `0 4px 16px ${colorPrimary}66` 
                : `0 4px 16px ${colorPrimary}50`
            }}
          />
        </Col>
        <Col flex="auto">
          <Title level={3} style={{ margin: 0 }}>
            {welcomeText}ï¼Œ{username}ï¼
          </Title>
          <Paragraph style={{ 
            margin: '8px 0 0 0', 
            color: isDark ? '#bfbfbf' : '#666' 
          }}>
            {email}
          </Paragraph>
          <Space style={{ marginTop: 12 }}>
            <Tag color="blue">{adminText}</Tag>
            <Tag color="green">{onlineText}</Tag>
          </Space>
        </Col>
        {showButtons && (
          <Col>
            <Space>
              <Button type="primary" onClick={onConfigCheck}>
                {configCheckText}
              </Button>
              <Button onClick={onBackendDemo}>
                {backendDemoText}
              </Button>
            </Space>
          </Col>
        )}
      </Row>
    </Card>
  )
})

WelcomeCard.displayName = 'WelcomeCard' 
'ç³»ç»ŸçŠ¶æ€å¡ç‰‡ç»„ä»¶
/**
 * System Status Card Component
 * 
 * ç³»ç»ŸçŠ¶æ€å¡ç‰‡ç»„ä»¶ï¼Œç”¨äºå±•ç¤ºæœåŠ¡å™¨èµ„æºä½¿ç”¨æƒ…å†µ
 * 
 * @module SystemStatusCard
 * @description 
 * è¯¥ç»„ä»¶æä¾›äº†ç³»ç»Ÿç›‘æ§æ•°æ®çš„å¯è§†åŒ–å±•ç¤ºï¼ŒåŒ…æ‹¬ï¼š
 * - CPU ä½¿ç”¨ç‡è¿›åº¦æ¡
 * - å†…å­˜ä½¿ç”¨ç‡è¿›åº¦æ¡
 * - ç£ç›˜ä½¿ç”¨ç‡è¿›åº¦æ¡
 * - ä¸»é¢˜é€‚é…ï¼ˆæ˜æš—æ¨¡å¼ï¼‰
 * - å“åº”å¼å¸ƒå±€
 * 
 * @performance
 * ä½¿ç”¨ React.memo è¿›è¡Œç»„ä»¶è®°å¿†åŒ–ï¼Œä»…åœ¨ props å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“
 * 
 * @author Aerotrace Development Team
 * @version 1.0.0
 */

import React from 'react'
import { Card, Space, Typography, Progress } from 'antd'
import { theme } from 'antd'

const { Text } = Typography

/**
 * ç³»ç»ŸçŠ¶æ€å¡ç‰‡ç»„ä»¶çš„å±æ€§æ¥å£
 * 
 * @interface SystemStatusCardProps
 * @property {string} title - å¡ç‰‡æ ‡é¢˜
 * @property {string} cpuUsageText - CPUä½¿ç”¨ç‡æ ‡ç­¾æ–‡æœ¬
 * @property {string} memoryUsageText - å†…å­˜ä½¿ç”¨ç‡æ ‡ç­¾æ–‡æœ¬
 * @property {string} diskUsageText - ç£ç›˜ä½¿ç”¨ç‡æ ‡ç­¾æ–‡æœ¬
 * @property {number} [cpuPercent=30] - CPUä½¿ç”¨ç‡ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰
 * @property {number} [memoryPercent=68] - å†…å­˜ä½¿ç”¨ç‡ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰
 * @property {number} [diskPercent=45] - ç£ç›˜ä½¿ç”¨ç‡ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰
 * @property {boolean} [isDark=false] - æ˜¯å¦ä¸ºæš—è‰²ä¸»é¢˜æ¨¡å¼
 */
interface SystemStatusCardProps {
  title: string
  cpuUsageText: string
  memoryUsageText: string
  diskUsageText: string
  cpuPercent?: number
  memoryPercent?: number
  diskPercent?: number
  isDark?: boolean
}

/**
 * ç³»ç»ŸçŠ¶æ€å¡ç‰‡ç»„ä»¶
 * 
 * @component SystemStatusCard
 * @param {SystemStatusCardProps} props - ç»„ä»¶å±æ€§å¯¹è±¡
 * @returns {JSX.Element} æ¸²æŸ“çš„ç³»ç»ŸçŠ¶æ€å¡ç‰‡å…ƒç´ 
 */
export const SystemStatusCard: React.FC<SystemStatusCardProps> = React.memo(({
  title,
  cpuUsageText,
  memoryUsageText,
  diskUsageText,
  cpuPercent = 30,
  memoryPercent = 68,
  diskPercent = 45,
  isDark = false
}) => {
  const {
    token: { borderRadiusLG },
  } = theme.useToken()

  return (
    <Card 
      title={title}
      style={{
        height: '100%',
        background: isDark
          ? 'linear-gradient(135deg, rgba(38,38,38,0.9) 0%, rgba(58,58,58,0.7) 100%)'
          : 'linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.8) 100%)',
        border: isDark
          ? '1px solid rgba(255,255,255,0.1)' 
          : '1px solid rgba(24, 144, 255, 0.1)',
        backdropFilter: 'blur(12px)',
        borderRadius: borderRadiusLG,
        boxShadow: isDark
          ? '0 4px 16px rgba(0,0,0,0.3)' 
          : '0 4px 16px rgba(24, 144, 255, 0.08)'
      }}
      bodyStyle={{ padding: '24px', height: 'calc(100% - 57px)' }}
    >
      <Space direction="vertical" style={{ width: '100%', height: '100%', justifyContent: 'center' }}>
        <div style={{ marginBottom: 16 }}>
          <Text>{cpuUsageText}</Text>
          <Progress percent={cpuPercent} size="small" />
        </div>
        <div style={{ marginBottom: 16 }}>
          <Text>{memoryUsageText}</Text>
          <Progress percent={memoryPercent} size="small" status="active" />
        </div>
        <div>
          <Text>{diskUsageText}</Text>
          <Progress percent={diskPercent} size="small" />
        </div>
      </Space>
    </Card>
  )
})

SystemStatusCard.displayName = 'SystemStatusCard' 
